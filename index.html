<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TSCHORNI: FULL STATS RPG</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #ffcc00; --hp: #ff4444; --st: #00ff88; --mp: #4488ff; --bg: #0d0d0d; --box: #1a1a1a; --border: #333; }
        body { background: var(--bg); color: #ddd; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 5px; user-select: none; }
        .box { background: var(--box); padding: 10px; border-radius: 8px; border: 1px solid var(--border); margin: 5px auto; max-width: 500px; }
        
        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã */
        .bar-bg { width: 100%; height: 16px; background: #222; border-radius: 4px; margin: 3px 0; overflow: hidden; position: relative; border: 1px solid #444; }
        .bar-fill { height: 100%; transition: width 0.4s; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 9px; font-weight: bold; line-height: 16px; color: #fff; z-index: 2; text-shadow: 1px 1px #000; }

        /* –°–µ—Ç–∫–∞ —Å—Ç–∞—Ç–æ–≤ */
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-bottom: 8px; }
        .stat-item { background: #000; padding: 4px; border-radius: 4px; text-align: center; font-size: 10px; border: 1px solid #222; }
        .stat-val { display: block; color: var(--gold); font-weight: bold; font-size: 12px; }

        .tabs { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; margin: 10px 0; }
        .tab-btn { padding: 10px 2px; background: #222; border: 1px solid #444; color: #888; font-size: 9px; border-radius: 4px; cursor: pointer; }
        .tab-active { background: var(--gold); color: #000; font-weight: bold; border-color: var(--gold); }

        /* –ú–∞–≥–∞–∑–∏–Ω –∏ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å */
        .card { background: #111; border: 1px solid #333; padding: 8px; border-radius: 6px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        .card-icon { font-size: 22px; background: #222; padding: 8px; border-radius: 6px; }
        .card-info { flex: 1; }
        .card-name { font-weight: bold; color: var(--gold); font-size: 12px; }
        .card-bonus { font-size: 10px; color: #00ff88; }
        
        .btn-act { background: var(--gold); color: #000; border: none; padding: 6px 10px; border-radius: 4px; font-weight: bold; font-size: 11px; }
        .btn-act:disabled { background: #444; color: #888; }

        /* –ß–∞—Ç */
        .chat-wrap { display: flex; flex-direction: column; height: 150px; background: #000; border-radius: 6px; border: 1px solid #222; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 8px; font-size: 11px; }
        #log { height: 50px; overflow-y: auto; font-size: 10px; color: #888; padding: 5px; border-top: 1px solid #222; }
    </style>
</head>
<body>

<div id="auth-ui">
    <div class="box" style="margin-top: 50px; text-align: center;">
        <h2 style="color: var(--gold)">TSCHORNI RPG</h2>
        <input type="text" id="u_nick" placeholder="–ù–ò–ö" style="width:80%; padding:12px; margin:5px; background:#111; border:1px solid #333; color:#fff;">
        <input type="password" id="u_pass" placeholder="–ü–ê–†–û–õ–¨" style="width:80%; padding:12px; margin:5px; background:#111; border:1px solid #333; color:#fff;">
        <button onclick="auth('login')" class="btn-act" style="width:85%; padding:12px; font-size:14px;">–í–û–ô–¢–ò</button>
    </div>
</div>

<div id="game-ui" style="display: none;">
    <div class="box">
        <div class="stat-grid">
            <div class="stat-item">üí™ –°–ò–õ<span id="s-str" class="stat-val">0</span></div>
            <div class="stat-item">üõ°Ô∏è –ñ–ò–í<span id="s-vit" class="stat-val">0</span></div>
            <div class="stat-item">‚ö° –õ–û–í<span id="s-agi" class="stat-val">0</span></div>
            <div class="stat-item">üß† –ò–ù–¢<span id="s-int" class="stat-val">0</span></div>
        </div>
        <div class="bar-bg"><div class="bar-text" id="hp-txt">HP</div><div id="hp-f" class="bar-fill" style="background:var(--hp);"></div></div>
        <div class="bar-bg"><div class="bar-text" id="st-txt">ST</div><div id="st-f" class="bar-fill" style="background:var(--st);"></div></div>
        <div class="bar-bg"><div class="bar-text" id="mp-txt">MP</div><div id="mp-f" class="bar-fill" style="background:var(--mp);"></div></div>
        <div style="font-size:11px; text-align:center; color:var(--gold); margin-top:5px;">–ó–æ–ª–æ—Ç–æ: <span id="r-gold">0</span>üí∞ | –û–ø—ã—Ç: <span id="r-exp">0</span>‚≠ê</div>
    </div>

    <div class="tabs">
        <button class="tab-btn" id="t-world" onclick="setTab('world')">–ú–ò–†</button>
        <button class="tab-btn" id="t-fight" onclick="setTab('fight')">–ë–û–ô</button>
        <button class="tab-btn" id="t-inv" onclick="setTab('inv')">–ì–ï–†–û–ô</button>
        <button class="tab-btn" id="t-shop" onclick="setTab('shop')">–†–´–ù–û–ö</button>
        <button class="tab-btn" id="t-craft" onclick="setTab('craft')">–ö–†–ê–§–¢</button>
    </div>

    <div id="tab-content" class="box" style="min-height: 180px;"></div>

    <div class="box chat-wrap">
        <div id="chat-msgs"></div>
        <input type="text" id="chat-in" placeholder="–ß–∞—Ç..." style="background:#111; border:none; color:#fff; padding:8px; border-top:1px solid #222;" onkeypress="if(event.key==='Enter') sendChat()">
        <div id="log"></div>
    </div>
</div>

<script>
    const S_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co";
    const S_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";
    const sb = window.supabase.createClient(S_URL, S_KEY);

    let user = null, data = {}, curTab = 'world';

    const ITEMS = {
        'w1': { name: '–î—É–±–∏–Ω–∞', cost: 100, str: 5, icon: 'ü™µ', type: 'weapon' },
        'w2': { name: '–ö–∏–Ω–∂–∞–ª', cost: 300, agi: 8, icon: 'üó°Ô∏è', type: 'weapon' },
        'a1': { name: '–ü–ª–∞—â –º–∞–≥–∞', cost: 400, int: 10, icon: 'üßô', type: 'armor' },
        'a2': { name: '–°–∞–ø–æ–≥–∏ –≤–æ—Ä–∞', cost: 250, agi: 6, icon: 'üëû', type: 'armor' },
        'pot': { name: '–ó–µ–ª—å–µ MP', cost: 40, icon: 'üß™', type: 'use' }
    };

    window.onload = () => {
        const s = localStorage.getItem('tschorni_session');
        if(s) { const p = JSON.parse(s); document.getElementById('u_nick').value = p.n; document.getElementById('u_pass').value = p.p; auth('login'); }
    };

    async function auth(mode) {
        const n = document.getElementById('u_nick').value, p = document.getElementById('u_pass').value;
        const { data: u } = await sb.from('users').select('*').eq('username', n).single();
        if(u && u.email_hidden === p) {
            user = n; 
            data = { ...u, 
                agi: u.agi || 5, 
                int: u.int || 5, 
                current_mp: u.current_mp || 50,
                inventory: u.inventory || [],
                equip: u.equip || { weapon: null, armor: null }
            };
            localStorage.setItem('tschorni_session', JSON.stringify({n, p}));
            document.getElementById('auth-ui').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            startApp();
        }
    }

    function startApp() {
        updateUI();
        setTab('world');
        setInterval(tick, 2000);
        setInterval(() => { if(user) sb.from('users').update(data).eq('username', user) }, 10000);
        initChat();
    }

    function updateUI() {
        const b = { str: 0, vit: 0, agi: 0, int: 0 };
        ['weapon', 'armor'].forEach(t => { if(data.equip[t]) {
            b.str += data.equip[t].str || 0; b.vit += data.equip[t].vit || 0;
            b.agi += data.equip[t].agi || 0; b.int += data.equip[t].int || 0;
        }});

        const ts = { str: data.str + b.str, vit: data.vit + b.vit, agi: data.agi + b.agi, int: data.int + b.int };
        const mHp = 100 + (ts.vit * 10), mSt = 100 + (ts.str * 5), mMp = 50 + (ts.int * 8);

        document.getElementById('s-str').innerText = ts.str;
        document.getElementById('s-vit').innerText = ts.vit;
        document.getElementById('s-agi').innerText = ts.agi;
        document.getElementById('s-int').innerText = ts.int;
        document.getElementById('r-gold').innerText = Math.floor(data.gold);
        document.getElementById('r-exp').innerText = data.exp;

        setBar('hp', data.current_hp, mHp);
        setBar('st', data.stamina, mSt);
        setBar('mp', data.current_mp, mMp);
    }

    function setBar(id, cur, max) {
        document.getElementById(`${id}-txt`).innerText = `${id.toUpperCase()}: ${Math.floor(cur)}/${max}`;
        document.getElementById(`${id}-f`).style.width = (cur/max*100)+'%';
    }

    function setTab(t) {
        curTab = t;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
        document.getElementById('t-'+t).classList.add('tab-active');
        const c = document.getElementById('tab-content');

        if(t === 'shop') {
            c.innerHTML = `<h4>–ú–∞–≥–∞–∑–∏–Ω</h4>` + Object.keys(ITEMS).map(k => {
                const i = ITEMS[k];
                return `<div class="card"><div class="card-icon">${i.icon}</div>
                <div class="card-info"><div class="card-name">${i.name}</div>
                <div class="card-bonus">${i.str?'+'+i.str+' STR ':''}${i.agi?'+'+i.agi+' AGI ':''}${i.int?'+'+i.int+' INT ':''}</div></div>
                <button class="btn-act" onclick="buyItem('${k}')" ${data.gold<i.cost?'disabled':''}>${i.cost}üí∞</button></div>`;
            }).join('');
        } else if(t === 'inv') {
            c.innerHTML = `<h4>–°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:10px;">
                    <div class="stat-item">‚öîÔ∏è ${data.equip.weapon ? data.equip.weapon.name : '–ö—É–ª–∞–∫–∏'}</div>
                    <div class="stat-item">üõ°Ô∏è ${data.equip.armor ? data.equip.armor.name : '–¢—Ä—è–ø–∫–∏'}</div>
                </div>
                <h4>–†—é–∫–∑–∞–∫</h4>
                ${data.inventory.map((item, i) => `
                    <div class="card"><div class="card-icon">${item.icon}</div><div class="card-info">${item.name}</div>
                    <button class="btn-act" onclick="equipItem(${i})">–ù–∞–¥–µ—Ç—å</button></div>
                `).join('')}`;
        } else if(t === 'world') {
            c.innerHTML = `<h4>–õ–æ–∫–∞—Ü–∏—è: ${data.location}</h4>
                <button class="btn-act" style="width:100%; margin-bottom:5px;" onclick="travel('–õ–µ—Å')">–í –õ–µ—Å</button>
                <button class="btn-act" style="width:100%;" onclick="travel('–®–∞—Ö—Ç–∞')">–í –®–∞—Ö—Ç—É</button>`;
        } else if(t === 'fight') {
            c.innerHTML = `<h4>–ë–æ–π (Carnage Style)</h4>
                <p style="font-size:10px;">–õ–æ–≤–∫–æ—Å—Ç—å ${data.agi} –¥–∞–µ—Ç —à–∞–Ω—Å ${Math.min(40, data.agi)}% –Ω–∞ —É–≤–æ—Ä–æ—Ç!</p>
                <button class="btn-act" style="width:100%; height:50px; background:#800; color:#fff;" onclick="doHit()">–£–î–ê–†–ò–¢–¨!</button>`;
        }
    }

    function doHit() {
        if(data.stamina < 10) return addLog("–£—Å—Ç–∞–ª!");
        data.stamina -= 10;
        // –®–∞–Ω—Å —É–≤–æ—Ä–æ—Ç–∞
        if(Math.random() * 100 < data.agi) {
            addLog("‚ö° –£–í–û–†–û–¢! –í—ã —Ç–µ—Ö–Ω–∏—á–Ω–æ —É—à–ª–∏ –æ—Ç –≤—Å—Ç—Ä–µ—á–Ω–æ–≥–æ —É–¥–∞—Ä–∞.");
        } else {
            data.current_hp -= 5;
            addLog("üí• –ü–æ–ª—É—á–µ–Ω —É—Ä–æ–Ω -5 HP");
        }
        data.exp += 10;
        addLog("‚úÖ –£–¥–∞—Ä –Ω–∞–Ω–µ—Å–µ–Ω! +10 –æ–ø—ã—Ç–∞");
        updateUI();
    }

    function buyItem(k) {
        const i = ITEMS[k];
        if(data.gold >= i.cost) {
            data.gold -= i.cost;
            if(i.type === 'use') data.current_mp = Math.min(500, data.current_mp + 30);
            else data.inventory.push(i);
            addLog("–ü–æ–∫—É–ø–∫–∞: " + i.name);
            updateUI(); setTab('shop');
        }
    }

    function equipItem(idx) {
        const item = data.inventory[idx];
        const type = item.type;
        if(data.equip[type]) data.inventory.push(data.equip[type]);
        data.equip[type] = item;
        data.inventory.splice(idx, 1);
        addLog("–ù–∞–¥–µ—Ç–æ: " + item.name);
        updateUI(); setTab('inv');
    }

    function travel(loc) { data.location = loc; addLog("–ü–µ—Ä–µ—Ö–æ–¥ –≤ " + loc); updateUI(); setTab('world'); }

    function tick() {
        const mHp = 100 + (data.vit * 10), mSt = 100 + (data.str * 5), mMp = 50 + (data.int * 8);
        if(data.current_hp < mHp) data.current_hp = Math.min(mHp, data.current_hp + 1.5);
        if(data.stamina < mSt) data.stamina = Math.min(mSt, data.stamina + 2);
        if(data.current_mp < mMp) data.current_mp = Math.min(mMp, data.current_mp + 1);
        updateUI();
    }

    function addLog(m) {
        const l = document.getElementById('log');
        l.innerHTML = `<div>[${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})}] ${m}</div>` + l.innerHTML;
    }

    async function initChat() {
        sb.channel('global').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => {
            const m = document.getElementById('chat-msgs');
            m.innerHTML += `<div><b>${p.new.user}:</b> ${p.new.text}</div>`;
            m.scrollTop = m.scrollHeight;
        }).subscribe();
    }

    async function sendChat() {
        const i = document.getElementById('chat-in');
        if(!i.value) return;
        await sb.from('messages').insert({ user: user, text: i.value });
        i.value = '';
    }
</script>
</body>
</html>
