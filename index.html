<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TSCHORNI GAME ONLINE</title>
    <style>
        :root { --gold: #f1c40f; --bg: #0d0d0d; --panel: #1a1a1a; --blue: #3498db; --red: #e74c3c; --green: #2ecc71; --stamina: #9b59b6; --border: #333; }
        body { background: var(--bg); color: #ddd; font-family: 'Verdana', sans-serif; margin: 0; padding-bottom: 100px; }
        
        /* –≠–∫—Ä–∞–Ω –ª–æ–≥–∏–Ω–∞ */
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .auth-form { background: var(--panel); padding: 20px; border-radius: 10px; border: 1px solid var(--gold); width: 100%; max-width: 300px; }
        .auth-form input { width: 100%; padding: 10px; margin: 10px 0; background: #000; border: 1px solid #444; color: #fff; box-sizing: border-box; }

        .header { background: #000; padding: 10px; border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .bar-bg { height: 12px; background: #222; border-radius: 6px; border: 1px solid #444; overflow: hidden; margin: 4px 0; position: relative; }
        .fill { height: 100%; transition: 0.3s; width: 0%; }
        .bar-txt { position: absolute; width: 100%; text-align: center; font-size: 9px; line-height: 12px; font-weight: bold; color: #fff; z-index: 2; }
        
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 10px; }
        .screen { display: none; } .active { display: block; }
        
        button { padding: 12px; background: #2a2a2a; color: #eee; border: 1px solid #444; border-radius: 5px; font-size: 11px; cursor: pointer; }
        button:active { transform: scale(0.98); background: #333; }

        #log, #chat-box { height: 90px; overflow-y: auto; background: #000; padding: 8px; font-size: 11px; border: 1px solid var(--border); margin-bottom: 5px; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #000; display: flex; border-top: 2px solid var(--border); height: 60px; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: #555; }
        .nav-item.active { color: var(--gold); }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-form">
            <h2 style="color:var(--gold); text-align:center; margin-top:0;">TSCHORNI GAME</h2>
            <label>–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
            <input type="text" id="login-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫...">
            <button onclick="login()" style="width:100%; background:var(--gold); color:#000;">–í–û–ô–¢–ò –í –ò–ì–†–£</button>
        </div>
    </div>

    <div id="game-ui" style="display:none;">
        <div class="header">
            <div style="display:flex; justify-content:space-between; font-size:11px; color:var(--gold); margin-bottom:4px;">
                <b id="ui-nick">---</b>
                <b>üí∞ <span id="gold">0</span></b>
            </div>
            <div class="bar-bg"><div class="bar-txt">‚ù§Ô∏è HP: <span id="hp-val">0/0</span></div><div id="hp-fill" class="fill" style="background:var(--green)"></div></div>
            <div class="bar-bg"><div class="bar-txt">üí™ STAMINA: <span id="st-val">0/0</span></div><div id="st-fill" class="fill" style="background:var(--stamina)"></div></div>
        </div>

        <div class="content" style="padding:10px;">
            <div id="chat-box"></div>
            <div id="log"></div>

            <div id="scr-town" class="screen">
                <div class="panel">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <button onclick="move('world')">‚öîÔ∏è –û–•–û–¢–ê</button>
                        <button onclick="move('char')">üë§ –ì–ï–†–û–ô</button>
                        <button onclick="logout()">üèÉ –í–´–•–û–î</button>
                    </div>
                </div>
            </div>

            <div id="scr-world" class="screen">
                <button style="width:100%; height:50px; background:var(--red);" onclick="hunt()">–ù–ê–ô–¢–ò –ú–û–ù–°–¢–†–ê</button>
                <button style="width:100%; margin-top:10px;" onclick="move('town')">–í –ì–û–†–û–î</button>
            </div>

            <div id="scr-battle" class="screen">
                <div class="panel" style="text-align:center;">
                    <h3 id="en-name">–í—Ä–∞–≥</h3>
                    <div class="bar-bg"><div id="en-hp-fill" class="fill" style="background:var(--red)"></div></div>
                    <button onclick="battleHit()" style="width:100%; height:50px; background:var(--red); margin-top:10px;">–£–î–ê–†–ò–¢–¨</button>
                </div>
            </div>

            <div id="scr-char" class="screen">
                <div class="panel" id="stat-info"></div>
            </div>
        </div>

        <div class="nav-bar">
            <div class="nav-item active" onclick="move('town')">üèôÔ∏è<br>–ì–æ—Ä–æ–¥</div>
            <div class="nav-item" onclick="move('world')">üó∫Ô∏è<br>–ú–∏—Ä</div>
            <div class="nav-item" onclick="move('char')">üë§<br>–ì–µ—Ä–æ–π</div>
        </div>
    </div>

    <script>
        const SB_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co"; 
        const SB_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";

        let p = null;
        let lastInactivityCheck = Date.now();

        // 1. –õ–û–ì–ò–ù –ò –ó–ê–ì–†–£–ó–ö–ê
        async function login() {
            const nick = document.getElementById('login-name').value.trim();
            if(!nick) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!");

            // –ò—â–µ–º –∏–≥—Ä–æ–∫–∞ –≤ –ë–î
            const res = await fetch(`${SB_URL}/rest/v1/users?username=eq.${nick}`, {
                headers: { "apikey": SB_KEY, "Authorization": `Bearer ${SB_KEY}` }
            });
            const data = await res.json();

            if(data.length > 0) {
                p = data[0].save_data;
            } else {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ
                p = {
                    username: nick, hp:100, st:100, gold:100, exp:0, lvl:1, points:5,
                    str:5, agi:5, vit:5, int:5, loc: 'town', last_save: Date.now()
                };
            }

            calculateOfflineGain();
            startInactivityTimer();
            
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            move(p.loc || 'town');
            updateUI();
            addLog(`–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º, ${p.username}!`);
        }

        // 2. –û–§–§–õ–ê–ô–ù –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï
        function calculateOfflineGain() {
            const now = Date.now();
            const diff = Math.floor((now - (p.last_save || now)) / 1000); // —Å–µ–∫—É–Ω–¥ –æ—Ñ—Ñ–ª–∞–π–Ω–∞
            
            if(diff > 5) {
                let maxHp = 100 + (p.vit * 20);
                let hpGain = Math.floor(diff / 10); // +1 HP –∑–∞ 10 —Å–µ–∫
                let stGain = Math.floor(diff / 5);  // +1 –°—Ç–∞–º–∏–Ω–∞ –∑–∞ 5 —Å–µ–∫
                
                p.hp = Math.min(maxHp, p.hp + hpGain);
                p.st = Math.min(100, p.st + stGain);
                addLog(`–ó–∞ –≤—Ä–µ–º—è –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${hpGain} HP –∏ ${stGain} –°—Ç–∞–º–∏–Ω—ã.`);
            }
        }

        // 3. –¢–ê–ô–ú–ï–† –ë–ï–ó–î–ï–ô–°–¢–í–ò–Ø (1 –ß–ê–°)
        function startInactivityTimer() {
            document.addEventListener('touchstart', resetTimer);
            document.addEventListener('click', resetTimer);
        }

        function resetTimer() {
            lastInactivityCheck = Date.now();
        }

        setInterval(() => {
            const passed = Date.now() - lastInactivityCheck;
            if(passed > 3600000) { // 1 —á–∞—Å
                alert("–í—ã –≤—ã—à–ª–∏ –∏–∑ –∏–≥—Ä—ã –∏–∑-–∑–∞ –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è.");
                logout();
            }
        }, 60000); // –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É

        function logout() {
            save();
            location.reload();
        }

        // 4. –ì–ï–ô–ú–ü–õ–ï–ô
        function updateUI() {
            if(!p) return;
            let maxHp = 100 + (p.vit * 20);
            if(maxHp <= 0) maxHp = 100; // –∑–∞—â–∏—Ç–∞ –æ—Ç 0/0

            document.getElementById('ui-nick').innerText = p.username;
            document.getElementById('gold').innerText = Math.floor(p.gold);
            
            document.getElementById('hp-val').innerText = `${Math.ceil(p.hp)}/${maxHp}`;
            document.getElementById('hp-fill').style.width = (p.hp/maxHp*100)+'%';
            
            document.getElementById('st-val').innerText = `${Math.floor(p.st)}/100`;
            document.getElementById('st-fill').style.width = p.st+'%';
        }

        function move(scr) {
            p.loc = scr;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('scr-'+scr).classList.add('active');
            if(scr === 'char') renderChar();
            updateUI();
            save();
        }

        function renderChar() {
            document.getElementById('stat-info').innerHTML = `
                <h3>${p.username} (${p.lvl} —É—Ä–æ–≤–µ–Ω—å)</h3>
                <p>–°–∏–ª–∞: ${p.str}</p>
                <p>–ñ–∏–≤—É—á–µ—Å—Ç—å: ${p.vit}</p>
                <p>–ó–æ–ª–æ—Ç–æ: ${p.gold}</p>
            `;
        }

        function addLog(m) {
            const l = document.getElementById('log');
            l.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${m}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        async function save() {
            if(!p) return;
            p.last_save = Date.now();
            localStorage.setItem('tschorni_player', JSON.stringify(p));
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Supabase (Upsert)
            try {
                await fetch(`${SB_URL}/rest/v1/users`, {
                    method: 'POST',
                    headers: { 
                        "apikey": SB_KEY, 
                        "Authorization": `Bearer ${SB_KEY}`, 
                        "Content-Type": "application/json",
                        "Prefer": "resolution=merge-duplicates" 
                    },
                    body: JSON.stringify({ username: p.username, save_data: p })
                });
            } catch(e) {}
        }

        // –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–Ω–ª–∞–π–Ω
        setInterval(() => {
            if(p && !p.enemy) {
                let maxHp = 100 + p.vit * 20;
                if(p.hp < maxHp) p.hp = Math.min(maxHp, p.hp + 2);
                if(p.st < 100) p.st = Math.min(100, p.st + 5);
                updateUI();
            }
        }, 5000);

        // –ê–≤—Ç–æ-—Å–µ–π–≤ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
        setInterval(save, 30000);

    </script>
</body>
</html>
