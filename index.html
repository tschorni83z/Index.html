<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TSCHORNI WORLD — Мультиплеер</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      margin:0; padding:0; background:#000; color:#0f0; font-family:monospace;
      image-rendering:pixelated; overflow:hidden; user-select:none;
    }
    #ui {
      position:fixed; inset:0; pointer-events:none; z-index:10;
      display:flex; flex-direction:column; justify-content:space-between;
      padding:8px; box-sizing:border-box;
    }
    #header {
      text-align:center; font-size:24px; color:#ff0; text-shadow:0 0 10px #ff0;
      margin-bottom:8px;
    }
    #top {
      display:flex; justify-content:space-between; font-size:14px;
      background:rgba(0,0,0,0.6); padding:4px; border-radius:4px;
    }
    #bars {
      margin:8px 0; display:flex; flex-direction:column; gap:4px;
    }
    .bar {
      height:12px; background:#222; border:1px solid #0f0; border-radius:2px;
      position:relative; overflow:hidden;
    }
    .fill {
      height:100%; transition:width 0.3s;
    }
    .hp .fill { background:#f44; }
    .st .fill { background:#ff0; }
    .bar-label {
      position:absolute; inset:0; text-align:center; font-size:10px; line-height:12px;
      color:#000; text-shadow:0 0 2px #fff;
    }
    #players-list {
      position:fixed; top:140px; left:8px; background:rgba(0,0,0,0.7);
      padding:8px; border:1px solid #0f0; border-radius:4px; max-height:200px;
      overflow-y:auto; font-size:12px; pointer-events:none;
    }
    #chat {
      position:fixed; bottom:180px; left:8px; right:8px; height:100px;
      background:rgba(0,0,0,0.7); border:1px solid #0f0; border-radius:4px;
      padding:8px; overflow-y:auto; font-size:13px; color:#0ff;
    }
    #chat-input {
      position:fixed; bottom:140px; left:8px; right:8px; height:30px;
      background:#000; color:#0f0; border:1px solid #0f0; padding:0 8px;
      font-family:monospace; font-size:14px; pointer-events:auto;
    }
    #bottom {
      display:flex; flex-wrap:wrap; gap:6px; pointer-events:auto;
      background:rgba(0,0,0,0.6); padding:4px; border-radius:4px;
    }
    button {
      background:#000; color:#0f0; border:1px solid #0f0; padding:6px 10px;
      cursor:pointer; font-family:monospace; font-size:13px;
    }
    button:hover { background:#0a0; color:#000; }
  </style>
</head>
<body>

<div id="ui">
  <div id="header">TSCHORNI WORLD</div>

  <div id="top">
    <div>
      <input id="myname" placeholder="Твоё имя" style="background:#000;color:#0f0;border:1px solid #0f0;padding:4px;width:120px;" value="Герой">
      <span id="lvl">1 ур.</span>
    </div>
    <div>
      <span id="loc">Лагерь</span> 
      <span id="gold">0 зол.</span>
    </div>
  </div>

  <div id="bars">
    <div class="bar hp">
      <div class="fill" id="hp-fill" style="width:100%;"></div>
      <div class="bar-label" id="hp-label">HP 100/100</div>
    </div>
    <div class="bar st">
      <div class="fill" id="st-fill" style="width:100%;"></div>
      <div class="bar-label" id="st-label">Выносливость 100/100</div>
    </div>
  </div>

  <div id="players-list"></div>

  <div id="chat"></div>
  <input id="chat-input" placeholder="Нажми Enter чтобы отправить..." />

  <div id="log"></div>

  <div id="bottom">
    <button onclick="go('Лагерь')">Лагерь</button>
    <button onclick="go('Лес')">Лес</button>
    <button onclick="go('Шахта')">Шахта</button>
    <button onclick="go('Город')">Город</button>
    <button onclick="die()">Умереть</button>
  </div>
</div>

<script>
// ==================================================
// Supabase — твои ключи из скрина
// ==================================================
const supabase = Supabase.createClient(
  'https://xgnzgapvvulizxtqdyzn.supabase.co',
  'sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT'
);

const channel = supabase.channel('tschorni_world');

// ==================================================
// Игрок (твои данные)
// ==================================================
let me = {
  id: crypto.randomUUID(),
  name: localStorage.getItem('playerName') || "Герой",
  x: 320,
  y: 240,
  hp: 100,
  maxHp: 100,
  stamina: 100,
  maxStamina: 100,
  gold: 0,
  level: 1,
  location: 'Лагерь'
};

document.getElementById('myname').value = me.name;
document.getElementById('myname').onchange = e => {
  me.name = e.target.value.trim() || "Герой";
  localStorage.setItem('playerName', me.name);
  updateMyPosition();
};

function updateMyPosition() {
  channel.send({
    type: 'broadcast',
    event: 'player-update',
    payload: {
      id: me.id,
      name: me.name,
      x: me.x,
      y: me.y,
      hp: me.hp,
      maxHp: me.maxHp,
      stamina: me.stamina,
      maxStamina: me.maxStamina,
      gold: me.gold,
      level: me.level,
      location: me.location
    }
  });
}

// ==================================================
// Другие игроки
// ==================================================
let players = {};

function updatePlayersList() {
  let list = document.getElementById('players-list');
  list.innerHTML = '<b>Игроки онлайн:</b><br>';
  Object.values(players).forEach(p => {
    list.innerHTML += `${p.name} (Lv.${p.level}) — ${p.location}<br>`;
  });
}

channel.on('broadcast', { event: 'player-update' }, ({ payload }) => {
  if (payload.id === me.id) return;
  players[payload.id] = payload;
  updatePlayersList();
});

channel.subscribe();

// ==================================================
// Чат
// ==================================================
const chat = document.getElementById('chat');
const input = document.getElementById('chat-input');

input.addEventListener('keypress', e => {
  if (e.key === 'Enter' && input.value.trim()) {
    channel.send({
      type: 'broadcast',
      event: 'chat',
      payload: { name: me.name, text: input.value.trim() }
    });
    input.value = '';
  }
});

channel.on('broadcast', { event: 'chat' }, ({ payload }) => {
  let msg = document.createElement('div');
  msg.textContent = `${payload.name}: ${payload.text}`;
  chat.appendChild(msg);
  chat.scrollTop = chat.scrollHeight;
});

// ==================================================
// Локации и передвижение
// ==================================================
const locations = {
  'Лагерь': '#111',
  'Лес': '#0a2',
  'Шахта': '#222',
  'Город': '#444'
};

function go(loc) {
  me.location = loc;
  updateMyPosition();
  document.getElementById('loc').textContent = loc;
  log(`Вы прибыли в ${loc}`, '#0ff');
}

// ==================================================
// Лог
// ==================================================
function log(txt, color = '#0f8') {
  let div = document.createElement('div');
  div.textContent = txt;
  div.style.color = color;
  document.getElementById('log').appendChild(div);
  if (document.getElementById('log').children.length > 20) {
    document.getElementById('log').removeChild(document.getElementById('log').firstChild);
  }
}

// ==================================================
// Обновление интерфейса
// ==================================================
function updateUI() {
  document.getElementById('lvl').textContent = `${me.level} ур.`;
  document.getElementById('hp-label').textContent = `HP ${Math.max(0,me.hp)}/${me.maxHp}`;
  document.getElementById('hp-fill').style.width = (me.hp / me.maxHp * 100) + '%';
  document.getElementById('st-label').textContent = `Выносливость ${Math.max(0,me.stamina)}/${me.maxStamina}`;
  document.getElementById('st-fill').style.width = (me.stamina / me.maxStamina * 100) + '%';
  document.getElementById('gold').textContent = `${me.gold} зол.`;
}

// ==================================================
// Смерть
// ==================================================
function die() {
  log('Вы умерли... Возрождение в Лагере', '#f44');
  me.hp = me.maxHp;
  me.stamina = me.maxStamina;
  me.location = 'Лагерь';
  updateMyPosition();
  updateUI();
}

// ==================================================
// Запуск
// ==================================================
log('Добро пожаловать в TSCHORNI WORLD!', '#0ff');
log('Введите имя сверху и нажми Enter');
log('Переключай локации кнопками снизу');
log('Другие игроки видны в списке и могут писать в чат');
updateUI();

// Обновление позиции каждые 2 секунды
setInterval(updateMyPosition, 2000);

// Восстановление выносливости
setInterval(() => {
  if (me.stamina < me.maxStamina) {
    me.stamina = Math.min(me.maxStamina, me.stamina + 1);
    updateUI();
  }
}, 2000);
</script>
</body>
</html>
