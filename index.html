<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TSCHORNI RPG: EXPLORE</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #0a0a0a; color: #fff; font-family: sans-serif; text-align: center; margin: 0; padding: 5px; }
        .box { background: #151515; padding: 15px; border-radius: 12px; border: 1px solid #333; max-width: 420px; margin: 8px auto; }
        .btn { width: 100%; padding: 15px; background: #ffcc00; color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn:disabled { background: #222; color: #555; }
        .tabs { display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 8px; background: #222; color: #888; border: 1px solid #444; border-radius: 8px; font-size: 11px; min-width: 80px; }
        .tab-active { background: #ffcc00; color: #000; font-weight: bold; }
        
        /* –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π */
        #log { background: #000; border: 1px solid #222; padding: 10px; height: 100px; overflow-y: auto; font-size: 12px; text-align: left; color: #aaa; margin-top: 10px; border-radius: 8px; }
        .log-win { color: #00ff88; }
        .log-lose { color: #ff4444; }
        .log-find { color: #00ccff; }

        .hp-bar { width: 100%; height: 6px; background: #300; border-radius: 3px; margin: 5px 0; overflow: hidden; }
        .hp-fill { height: 100%; background: #ff4444; transition: 0.3s; }
    </style>
</head>
<body>

<div id="game-container">
    <h1>TSCHORNI</h1>
    <div class="box">
        <input type="text" id="u_nick" placeholder="–ù–ò–ö–ù–ï–ô–ú" style="width:80%; padding:10px; margin-bottom:5px; background:#000; border:1px solid #333; color:#fff;">
        <input type="password" id="u_pass" placeholder="–ü–ê–†–û–õ–¨" style="width:80%; padding:10px; background:#000; border:1px solid #333; color:#fff;">
        <button class="btn" onclick="auth('login')">–ò–ì–†–ê–¢–¨</button>
    </div>
</div>

<script>
    const S_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co";
    const S_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";
    const sb = window.supabase.createClient(S_URL, S_KEY);

    let user, data = {}, isBusy = false, currentTab = 'explore';

    const zones = {
        forest: { name: "üå≤ –ó–µ–ª–µ–Ω—ã–π –õ–µ—Å", minLvl: 0, res: "wood", mobs: ["–°–ª–∏–∑–µ–Ω—å", "–ë–µ–ª–∫–∞-–º—É—Ç–∞–Ω—Ç"], mLevel: 1 },
        caves: { name: "ü™® –ì–ª—É–±–æ–∫–∏–µ –ü–µ—â–µ—Ä—ã", minLvl: 2, res: "iron", mobs: ["–ö—Ä–æ—Ç–æ–∫—Ä—ã—Å", "–ö–∞–º–µ–Ω–Ω—ã–π –¥—É—Ö"], mLevel: 3 },
        wasteland: { name: "üíÄ –ó–∞–±—ã—Ç—ã–µ –ó–µ–º–ª–∏", minLvl: 5, res: "copper", mobs: ["–û—Ä–∫-–∏–∑–≥–æ–π", "–î–µ–º–æ–Ω"], mLevel: 6 }
    };

    const getLvl = (exp) => Math.floor(Math.sqrt((exp || 0) / 15)) + 1;

    async function auth(mode) {
        const n = document.getElementById('u_nick').value;
        const p = document.getElementById('u_pass').value;
        const { data: u } = await sb.from('users').select('*').eq('username', n).single();
        if (u && u.email_hidden === p) {
            user = n; data = u; renderGame(); setInterval(regen, 30000);
        } else { alert("–û—à–∏–±–∫–∞!"); }
    }

    function renderGame() {
        const charLvl = getLvl(data.char_exp);
        document.getElementById('game-container').innerHTML = `
            <div class="box">
                <div style="display:flex; justify-content:space-between; font-size:12px;">
                    <span>üõ°Ô∏è –£—Ä–æ–≤–µ–Ω—å: ${charLvl}</span>
                    <span>‚ù§Ô∏è HP: ${data.current_hp}/${data.max_hp || 100}</span>
                </div>
                <div class="hp-bar"><div class="hp-fill" style="width:${(data.current_hp/(data.max_hp||100))*100}%"></div></div>
                <div style="font-size:11px; margin-top:5px; color:#ffcc00;">üí∞ –ó–æ–ª–æ—Ç–æ: ${data.gold} | üå≤:${data.wood||0} | ‚õèÔ∏è:${data.iron||0} | üü†:${data.copper||0}</div>
            </div>

            <div class="tabs">
                <button class="tab-btn ${currentTab==='explore'?'tab-active':''}" onclick="currentTab='explore';renderGame()">–ü–£–¢–ï–®–ï–°–¢–í–ò–ï</button>
                <button class="tab-btn ${currentTab==='factory'?'tab-active':''}" onclick="currentTab='factory';renderGame()">–ó–ê–í–û–î</button>
                <button class="tab-btn ${currentTab==='market'?'tab-active':''}" onclick="currentTab='market';renderGame()">–†–´–ù–û–ö</button>
            </div>

            <div id="tab-content">${renderTab()}</div>
            <div id="log">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä TSCHORNI...</div>
        `;
    }

    function renderTab() {
        if (currentTab === 'explore') {
            return `<div class="box">
                <select id="zone-sel" style="width:100%; background:#222; color:#fff; padding:10px; border-radius:8px; margin-bottom:10px;">
                    <option value="forest">üå≤ –ó–µ–ª–µ–Ω—ã–π –õ–µ—Å (–£—Ä. 0)</option>
                    <option value="caves">ü™® –ü–µ—â–µ—Ä—ã (–£—Ä. 2)</option>
                    <option value="wasteland">üíÄ –ü—É—Å—Ç–æ—à–∏ (–£—Ä. 5)</option>
                </select>
                <button class="btn" id="act-btn" onclick="explore()" ${isBusy?'disabled':''}>–ò–°–°–õ–ï–î–û–í–ê–¢–¨ (-10‚ö°)</button>
            </div>`;
        }
        if (currentTab === 'factory') return `<div class="box"><h3>–ü–õ–ê–í–ò–õ–¨–ù–Ø</h3><button class="btn" onclick="smelt()">–ü–ª–∞–≤–∏—Ç—å –°—Ç–∞–ª—å</button></div>`;
        return `<div class="box"><h3>–†–´–ù–û–ö</h3><button class="btn" onclick="sell('wood', 2)">–ü—Ä–æ–¥–∞—Ç—å –¥–µ—Ä–µ–≤–æ</button></div>`;
    }

    function addLog(msg, cl = '') {
        const l = document.getElementById('log');
        l.innerHTML = `<div class="${cl}">${msg}</div>` + l.innerHTML;
    }

    async function explore() {
        const zoneKey = document.getElementById('zone-sel').value;
        const zone = zones[zoneKey];
        const charLvl = getLvl(data.char_exp);

        if (charLvl < zone.minLvl) return alert(`–ù—É–∂–µ–Ω —É—Ä–æ–≤–µ–Ω—å ${zone.minLvl}!`);
        if (data.energy < 10) return alert("–ú–∞–ª–æ —ç–Ω–µ—Ä–≥–∏–∏!");

        isBusy = true; renderGame();
        addLog("–¢—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å—Å—è –≤ –ø—É—Ç—å...");

        setTimeout(async () => {
            const roll = Math.random();
            data.energy -= 10;

            if (roll < 0.4) { // –ù–∞—à–µ–ª —Ä–µ—Å—É—Ä—Å
                const amt = Math.floor(Math.random() * 3) + 1;
                data[zone.res] = (data[zone.res] || 0) + amt;
                addLog(`üçÄ –ù–∞—à–µ–ª ${zone.res}: +${amt}`, 'log-find');
            } else if (roll < 0.8) { // –í—Å—Ç—Ä–µ—Ç–∏–ª –º–æ–±–∞
                const mob = zone.mobs[Math.floor(Math.random()*zone.mobs.length)];
                const dmg = zone.mLevel * 5;
                const reward = zone.mLevel * 10;
                data.current_hp -= dmg;
                data.gold += reward;
                data.char_exp += zone.mLevel * 2;
                addLog(`‚öîÔ∏è –ë–æ–π —Å ${mob}! –ü–æ–ª—É—á–µ–Ω–æ —É—Ä–æ–Ω–∞: ${dmg}. –ù–∞–≥—Ä–∞–¥–∞: ${reward}üí∞`, 'log-lose');
            } else {
                addLog("–î–æ—Ä–æ–≥–∞ –±—ã–ª–∞ —Å–ø–æ–∫–æ–π–Ω–æ–π.");
            }

            if (data.current_hp <= 0) {
                addLog("üíÄ –¢—ã –ø–æ—Ç–µ—Ä—è–ª —Å–æ–∑–Ω–∞–Ω–∏–µ! –ó–æ–ª–æ—Ç–æ –ø–æ—Ç–µ—Ä—è–Ω–æ.", 'log-lose');
                data.current_hp = 20;
                data.gold = Math.floor(data.gold * 0.5);
            }

            await sb.from('users').update(data).eq('username', user);
            isBusy = false; renderGame();
        }, 2000);
    }

    async function regen() {
        if (data.energy < 100) data.energy += 5;
        if (data.current_hp < (data.max_hp || 100)) data.current_hp += 2;
        renderGame();
    }
</script>
</body>
</html>
