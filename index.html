<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carnage Mobile</title>
    <style>
        :root { --gold: #f1c40f; --bg: #111; --panel: #222; --blue: #3498db; --red: #e74c3c; --green: #2ecc71; --purp: #9b59b6; }
        body { background: var(--bg); color: #ddd; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; font-size: 13px; user-select: none; }
        .panel { background: var(--panel); padding: 10px; border-radius: 8px; border: 1px solid #333; margin-bottom: 8px; }
        .bar-bg { height: 12px; background: #000; border-radius: 6px; border: 1px solid #444; overflow: hidden; margin: 4px 0; position: relative; }
        .fill { height: 100%; transition: 0.5s; width: 100%; }
        .bar-txt { position: absolute; width: 100%; text-align: center; font-size: 9px; line-height: 12px; font-weight: bold; color: #fff; z-index: 1; }
        
        #log { height: 100px; overflow-y: auto; background: #000; padding: 8px; font-size: 11px; border-radius: 4px; color: #aaa; border: 1px solid #333; margin-bottom: 8px; }
        .screen { display: none; } .active { display: block; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        button { padding: 10px; background: #333; color: white; border: 1px solid #444; border-radius: 6px; font-weight: bold; cursor: pointer; }
        button:active { background: #444; }
        button:disabled { opacity: 0.3; }

        .stat-row { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid #333; }
        .plus-btn { background: var(--green); padding: 0 8px; border-radius: 4px; border: none; font-size: 12px; }
        .equip-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; }
        .slot { background: #151515; border: 1px solid #444; height: 40px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    </style>
</head>
<body>

    <div id="scr-game" class="active">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; font-weight:bold;">
                <span id="ui-nick">–ì–µ—Ä–æ–π</span> 
                <span style="color:var(--gold)">üí∞ <span id="gold">0</span></span>
            </div>
            <div class="bar-bg"><div class="bar-txt">–ó–¥–æ—Ä–æ–≤—å–µ <span id="hp-val"></span></div><div id="hp-fill" class="fill" style="background:var(--green)"></div></div>
            <div class="bar-bg"><div class="bar-txt">–û–ø—ã—Ç <span id="exp-val"></span></div><div id="exp-fill" class="fill" style="background:var(--blue); width:0%"></div></div>
            <div style="text-align:center; font-size:10px;">–£—Ä–æ–≤–µ–Ω—å: <b id="lvl">0</b></div>
        </div>

        <div style="display:flex; gap:5px; margin-bottom:8px;">
            <button onclick="tab('world')" style="flex:1">–ú–∏—Ä</button>
            <button onclick="tab('char')" style="flex:1">–ì–µ—Ä–æ–π</button>
        </div>

        <div id="log"></div>

        <div id="tab-world" class="screen active">
            <h3 id="loc-name" style="text-align:center; color:var(--gold); margin:5px 0;">–ì–æ—Ä–æ–¥</h3>
            <div id="act-btns" class="grid"></div>
            <div style="height:10px;"></div>
            <div id="nav-btns" class="grid"></div>
        </div>

        <div id="tab-char" class="screen">
            <div class="panel">
                <div style="color:var(--gold); font-weight:bold; margin-bottom:5px;">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–û—á–∫–∏: <span id="points">0</span>)</div>
                <div class="stat-row"><span>–°–∏–ª–∞ (–£—Ä–æ–Ω)</span> <span><b id="st-str">5</b> <button class="plus-btn" onclick="addStat('str')">+</button></span></div>
                <div class="stat-row"><span>–õ–æ–≤–∫–æ—Å—Ç—å (–£–≤–æ—Ä–æ—Ç)</span> <span><b id="st-agi">5</b> <button class="plus-btn" onclick="addStat('agi')">+</button></span></div>
                <div class="stat-row"><span>–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç (–ö—Ä–∏—Ç)</span> <span><b id="st-int">5</b> <button class="plus-btn" onclick="addStat('int')">+</button></span></div>
                <div class="stat-row"><span>–ñ–∏–≤—É—á–µ—Å—Ç—å (HP)</span> <span><b id="st-vit">5</b> <button class="plus-btn" onclick="addStat('vit')">+</button></span></div>
            </div>

            <div class="panel">
                <div style="color:var(--blue); font-weight:bold;">–≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞</div>
                <div class="equip-grid">
                    <div class="slot" title="–û–∂–µ—Ä–µ–ª—å–µ">üìø</div><div class="slot" title="–®–ª–µ–º">ü™ñ</div><div class="slot" title="–û—Ä—É–∂–∏–µ">‚öîÔ∏è</div>
                    <div class="slot" title="–ö–æ–ª—å—Ü–æ 1">üíç</div><div class="slot" title="–î–æ—Å–ø–µ—Ö">üëï</div><div class="slot" title="–ö–æ–ª—å—Ü–æ 2">üíç</div>
                </div>
            </div>
        </div>

        <div id="scr-battle" class="screen panel" style="position:fixed; top:10px; left:10px; right:10px; z-index:100; background:#221111; border-color:var(--red);">
            <div style="text-align:center;">
                <div id="en-img" style="font-size:30px;">üê∫</div>
                <b id="en-name">–í—Ä–∞–≥</b> [Lvl <span id="en-lvl">0</span>]
                <div class="bar-bg" style="width:100%;"><div id="en-hp-fill" class="fill" style="background:var(--red)"></div></div>
            </div>
            <div class="grid" style="margin-top:10px;">
                <button onclick="hit('head')">–ì–æ–ª–æ–≤–∞</button><button onclick="hit('body')">–¢–æ—Ä—Å</button>
                <button onclick="hit('legs')" style="grid-column: span 2;">–ù–æ–≥–∏</button>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co"; 
        const SB_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";

        // –î–ê–ù–ù–´–ï –ò–ì–†–û–ö–ê
        let p = JSON.parse(localStorage.getItem('last_user_save')) || { 
            username: "–ò–≥—Ä–æ–∫", hp: 100, maxHp: 100, nrg: 50, gold: 50, exp: 0, lvl: 0, points: 0,
            str: 5, agi: 5, int: 5, vit: 5, loc: 'town', wood: 0, stone: 0 
        };

        let enemy = null;
        const expTable = [0, 100, 250, 500, 1000, 2000, 4000, 8000, 15000, 30000, 60000];

        async function save() {
            if(!p.username || enemy) return;
            await fetch(`${SB_URL}/rest/v1/users?username=eq.${p.username}`, {
                method: 'PATCH',
                headers: { "apikey": SB_KEY, "Authorization": `Bearer ${SB_KEY}`, "Content-Type": "application/json" },
                body: JSON.stringify({ save_data: p })
            });
            localStorage.setItem('last_user_save', JSON.stringify(p));
        }

        function tab(t) {
            document.getElementById('tab-world').className = 'screen';
            document.getElementById('tab-char').className = 'screen';
            document.getElementById('tab-' + t).className = 'screen active';
        }

        function move(k) {
            if(enemy) return;
            const locs = {
                'town': { n: '–ì–æ—Ä–æ–¥ (–ë–µ–∑–æ–ø–∞—Å–Ω–æ)', p: ['forest_1'], a: [{t:'üõå –û—Ç–¥—ã—Ö (5üí∞)', f:'rest'}], minLvl: 0 },
                'forest_1': { n: '–û–∫—Ä–∞–∏–Ω–∞ –ª–µ—Å–∞', p: ['town', 'forest_2'], a: [{t:'ü™ì –†—É–±–∏—Ç—å', f:'work'}], minLvl: 0, chance: 0.2, m: {n: '–ö—Ä—ã—Å–∞', i:'üêÄ', hp:40, dmg:5, lvl:0} },
                'forest_2': { n: '–ì–ª—É—à—å', p: ['forest_1', 'cave'], a: [{t:'ü™ì –†—É–±–∏—Ç—å', f:'work'}], minLvl: 3, chance: 0.4, m: {n: '–í–æ–ª–∫', i:'üê∫', hp:120, dmg:12, lvl:4} },
                'cave': { n: '–¢–µ–º–Ω–∞—è –ü–µ—â–µ—Ä–∞', p: ['forest_2'], a: [{t:'‚õèÔ∏è –ö–æ–ø–∞—Ç—å', f:'work'}], minLvl: 6, chance: 0.5, m: {n: '–û—Ä–∫', i:'üëπ', hp:300, dmg:25, lvl:8} }
            };

            if(p.lvl < locs[k].minLvl) return addLog(`‚ùå –ù—É–∂–µ–Ω —É—Ä–æ–≤–µ–Ω—å ${locs[k].minLvl}!`);

            p.loc = k;
            const l = locs[k];
            document.getElementById('loc-name').innerText = l.n;
            
            if(l.chance && Math.random() < l.chance) return startBattle(l.m);

            const nB = document.getElementById('nav-btns'); nB.innerHTML = '';
            l.p.forEach(pk => {
                let b = document.createElement('button'); b.innerText = "‚û° " + locs[pk].n.split(' ')[0];
                b.onclick = () => move(pk); nB.appendChild(b);
            });

            const aB = document.getElementById('act-btns'); aB.innerHTML = '';
            l.a.forEach(a => {
                let b = document.createElement('button'); b.innerText = a.t;
                b.onclick = () => window[a.f](); aB.appendChild(b);
            });
            update();
        }

        function startBattle(m) {
            enemy = { ...m, curHp: m.hp };
            document.getElementById('en-name').innerText = enemy.n;
            document.getElementById('en-img').innerText = enemy.i;
            document.getElementById('en-lvl').innerText = enemy.lvl;
            document.getElementById('scr-battle').className = 'screen active panel';
            addLog(`‚öîÔ∏è –ù–∞–ø–∞–¥–µ–Ω–∏–µ: ${enemy.n}!`);
            update();
        }

        function hit(zone) {
            // –£—Ä–æ–Ω –∏–≥—Ä–æ–∫–∞ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–∏–ª—ã –∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞)
            let dmg = p.str + Math.floor(Math.random() * p.int);
            enemy.curHp -= dmg;
            addLog(`–¢—ã —É–¥–∞—Ä–∏–ª ${enemy.n} –≤ ${zone} –Ω–∞ ${dmg}.`);

            if(enemy.curHp <= 0) {
                let ex = 20 + (enemy.lvl * 15);
                let g = 10 + (enemy.lvl * 5);
                p.exp += ex; p.gold += g;
                addLog(`üèÜ –ü–æ–±–µ–¥–∞! +${ex} –æ–ø—ã—Ç–∞, +${g} –∑–æ–ª–æ—Ç–∞.`);
                checkLvl();
                return endBattle();
            }

            // –û—Ç–≤–µ—Ç–Ω—ã–π —É–¥–∞—Ä (—à–∞–Ω—Å —É–≤–æ—Ä–æ—Ç–∞ –æ—Ç –ª–æ–≤–∫–æ—Å—Ç–∏)
            if(Math.random() * 100 < (p.agi * 2)) {
                addLog(`üõ°Ô∏è –¢—ã —É–≤–µ—Ä–Ω—É–ª—Å—è –æ—Ç —É–¥–∞—Ä–∞!`);
            } else {
                p.hp -= enemy.dmg;
                addLog(`ü©∏ ${enemy.n} —Ä–∞–Ω–∏–ª —Ç–µ–±—è –Ω–∞ ${enemy.dmg}.`);
            }

            if(p.hp <= 0) {
                p.hp = 10; p.gold = Math.floor(p.gold * 0.7);
                addLog(`üíÄ –¢—ã –ø—Ä–æ–∏–≥—Ä–∞–ª –∏ —Å–±–µ–∂–∞–ª –≤ –≥–æ—Ä–æ–¥.`);
                endBattle();
                move('town');
            }
            update();
        }

        function endBattle() {
            enemy = null;
            document.getElementById('scr-battle').className = 'screen';
            save();
            update();
        }

        function checkLvl() {
            if(p.exp >= expTable[p.lvl + 1]) {
                p.lvl++;
                p.points += 5;
                p.hp = p.maxHp;
                addLog(`üéä –£–†–û–í–ï–ù–¨ –ü–û–í–´–®–ï–ù! –ü–æ–ª—É—á–µ–Ω–æ 5 –æ—á–∫–æ–≤ —Å—Ç–∞—Ç–æ–≤.`);
                checkLvl();
            }
        }

        function addStat(s) {
            if(p.points > 0) {
                p[s]++; p.points--;
                if(s === 'vit') p.maxHp += 20;
                update();
                save();
            }
        }

        function rest() {
            if(p.gold >= 5) { p.gold -= 5; p.hp = p.maxHp; addLog("üõå –°–∏–ª—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!"); }
            update();
        }

        function update() {
            p.maxHp = 100 + (p.vit * 20);
            document.getElementById('ui-nick').innerText = p.username;
            document.getElementById('gold').innerText = p.gold;
            document.getElementById('lvl').innerText = p.lvl;
            document.getElementById('points').innerText = p.points;
            
            document.getElementById('hp-val').innerText = `${Math.ceil(p.hp)}/${p.maxHp}`;
            document.getElementById('hp-fill').style.width = (p.hp / p.maxHp * 100) + "%";
            
            let nextExp = expTable[p.lvl + 1] || expTable[p.lvl];
            document.getElementById('exp-val').innerText = `${p.exp}/${nextExp}`;
            document.getElementById('exp-fill').style.width = (p.exp / nextExp * 100) + "%";

            ['str', 'agi', 'int', 'vit'].forEach(s => document.getElementById('st-'+s).innerText = p[s]);
            
            if(enemy) document.getElementById('en-hp-fill').style.width = (enemy.curHp / enemy.hp * 100) + "%";
            
            document.querySelectorAll('.plus-btn').forEach(b => b.style.display = p.points > 0 ? 'inline' : 'none');
        }

        function addLog(m) {
            const l = document.getElementById('log');
            l.innerHTML += `<div>${m}</div>`; l.scrollTop = l.scrollHeight;
        }

        // –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –•–ü (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∂–∏–≤—É—á–µ—Å—Ç–∏)
        setInterval(() => {
            if(!enemy && p.hp < p.maxHp) {
                p.hp = Math.min(p.maxHp, p.hp + (p.vit / 5));
                update();
            }
        }, 5000);

        move(p.loc || 'town');
        setInterval(save, 30000);
    </script>
</body>
</html>
