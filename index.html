<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TSCHORNI RPG</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #0a0a0a; color: #fff; font-family: sans-serif; text-align: center; padding: 10px; margin: 0; }
        .box { background: #1a1a1a; padding: 15px; border-radius: 12px; border: 1px solid #333; max-width: 400px; margin: 10px auto; }
        .btn { width: 100%; padding: 15px; background: #ffcc00; color: #000; border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .btn:disabled { background: #444; color: #888; }
        
        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 10px 5px; background: #222; border: 1px solid #444; color: #888; border-radius: 8px; font-size: 11px; }
        .tab-active { background: #ffcc00; color: #000; border-color: #ffcc00; font-weight: bold; }

        /* –†–µ—Å—É—Ä—Å—ã –∏ –≠–Ω–µ—Ä–≥–∏—è */
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .res-item { background: #000; padding: 8px; border-radius: 8px; border: 1px solid #222; font-size: 13px; }
        .en-bar-bg { width: 100%; background: #333; height: 12px; border-radius: 6px; margin-top: 5px; overflow: hidden; }
        #en-bar-fill { width: 100%; background: #00ccff; height: 100%; transition: 0.3s; }

        /* –õ–æ–∫–∞—Ü–∏–∏ –∏ –ö—Ä–∞—Ñ—Ç */
        .loc-btn { background: #333; color: #fff; padding: 8px; border-radius: 5px; border: 1px solid #444; margin: 2px; font-size: 10px; }
        .loc-active { border-color: #ffcc00; color: #ffcc00; }
        .craft-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #333; font-size: 13px; text-align: left; }
        
        #p-cont { width: 100%; background: #222; height: 6px; margin-top: 10px; display: none; border-radius: 3px; }
        #p-bar { width: 0%; height: 100%; background: #ffcc00; }
    </style>
</head>
<body>

<div id="game-container">
    <h1>TSCHORNI</h1>
    <div class="box">
        <input type="text" id="u_nick" placeholder="–ù–ò–ö–ù–ï–ô–ú" style="width:90%; padding:10px; margin-bottom:10px; background:#000; color:#fff; border:1px solid #444;">
        <input type="password" id="u_pass" placeholder="–ü–ê–†–û–õ–¨" style="width:90%; padding:10px; background:#000; color:#fff; border:1px solid #444;">
        <button class="btn" onclick="auth('login')">–í–û–ô–¢–ò</button>
        <button class="btn" style="background:none; color:#ffcc00; border:1px solid #ffcc00;" onclick="auth('reg')">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
    </div>
</div>

<script>
    const S_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co";
    const S_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";
    const sb = window.supabase.createClient(S_URL, S_KEY);

    let user, data = {}, isBusy = false, currentLoc = 'forest', currentTab = 'mine';

    const locations = {
        forest: { name: 'üå≤ –õ–ï–°', res: 'wood', time: 5000, energy: 10 },
        quarry: { name: 'ü™® –ö–ê–†–¨–ï–†', res: 'stone', time: 8000, energy: 15 },
        mine: { name: '‚õèÔ∏è –®–ê–•–¢–ê', res: 'iron', time: 12000, energy: 20 }
    };

    async function auth(mode) {
        const nick = document.getElementById('u_nick').value.trim();
        const pass = document.getElementById('u_pass').value.trim();
        if (!nick || !pass) return alert("–î–∞–Ω–Ω—ã–µ!");
        try {
            if (mode === 'reg') {
                await sb.from('users').insert({ id: crypto.randomUUID(), username: nick, email_hidden: pass });
                alert("–°–æ–∑–¥–∞–Ω!");
            } else {
                const { data: u } = await sb.from('users').select('*').eq('username', nick).single();
                if (u && u.email_hidden === pass) { user = nick; data = u; renderGame(); startRegen(); }
                else alert("–û—à–∏–±–∫–∞!");
            }
        } catch (e) { alert(e.message); }
    }

    function renderGame() {
        document.getElementById('game-container').innerHTML = `
            <div class="box">
                <div style="font-size:12px; color:#888; margin-bottom:5px;">‚ö° –≠–Ω–µ—Ä–≥–∏—è: <span id="en-val">${data.energy}</span>/100</div>
                <div class="en-bar-bg"><div id="en-bar-fill" style="width:${data.energy}%"></div></div>
                <div class="res-grid" style="margin-top:10px;">
                    <div class="res-item">üí∞ ${data.gold}</div>
                    <div class="res-item">üå≤ ${data.wood || 0}</div>
                    <div class="res-item">ü™® ${data.stone || 0}</div>
                    <div class="res-item">‚õèÔ∏è ${data.iron || 0}</div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn ${currentTab==='mine'?'tab-active':''}" onclick="setTab('mine')">–î–û–ë–´–ß–ê</button>
                <button class="tab-btn ${currentTab==='market'?'tab-active':''}" onclick="setTab('market')">–†–´–ù–û–ö</button>
                <button class="tab-btn ${currentTab==='craft'?'tab-active':''}" onclick="setTab('craft')">–ö–†–ê–§–¢</button>
            </div>

            <div id="tab-content">${currentTab==='mine'?renderMine():currentTab==='market'?renderMarket():renderCraft()}</div>
        `;
    }

    function renderMine() {
        const loc = locations[currentLoc];
        let time = loc.time;
        if (currentLoc === 'forest' && data.has_axe) time -= 2000;
        if (currentLoc !== 'forest' && data.has_pickaxe) time -= 3000;

        return `
            <div class="box">
                <h3>${loc.name}</h3>
                <button class="loc-btn ${currentLoc==='forest'?'loc-active':''}" onclick="setLoc('forest')">–õ–ï–°</button>
                <button class="loc-btn ${currentLoc==='quarry'?'loc-active':''}" onclick="setLoc('quarry')">–ö–ê–†–¨–ï–†</button>
                <button class="loc-btn ${currentLoc==='mine'?'loc-active':''}" onclick="setLoc('mine')">–®–ê–•–¢–ê</button>
                <button id="m-btn" class="btn" onclick="mine(${time})">–î–û–ë–´–í–ê–¢–¨ (-${loc.energy}‚ö°)</button>
                <div id="p-cont"><div id="p-bar"></div></div>
            </div>
        `;
    }

    function renderMarket() {
        return `
            <div class="box">
                <div style="display:flex; justify-content:space-between; margin:10px 0;"><span>üå≤ –î–µ—Ä–µ–≤–æ (2üí∞)</span><button onclick="sell('wood',2)" style="background:#006633; color:#fff; border:none; padding:5px 10px; border-radius:4px;">–ü—Ä–æ–¥–∞—Ç—å</button></div>
                <div style="display:flex; justify-content:space-between; margin:10px 0;"><span>ü™® –ö–∞–º–µ–Ω—å (5üí∞)</span><button onclick="sell('stone',5)" style="background:#006633; color:#fff; border:none; padding:5px 10px; border-radius:4px;">–ü—Ä–æ–¥–∞—Ç—å</button></div>
                <div style="display:flex; justify-content:space-between; margin:10px 0;"><span>‚õèÔ∏è –ñ–µ–ª–µ–∑–æ (12üí∞)</span><button onclick="sell('iron',12)" style="background:#006633; color:#fff; border:none; padding:5px 10px; border-radius:4px;">–ü—Ä–æ–¥–∞—Ç—å</button></div>
            </div>
        `;
    }

    function renderCraft() {
        return `
            <div class="box">
                <div class="craft-item">
                    <div><b>ü™ì –¢–û–ü–û–†</b><br><small>–£—Å–∫–æ—Ä—è–µ—Ç –ª–µ—Å. –¶–µ–Ω–∞: 20 –¥–µ—Ä–µ–≤–∞</small></div>
                    <button class="btn" style="width:80px;" ${data.has_axe?'disabled':''} onclick="craft('axe')">${data.has_axe?'–ï—Å—Ç—å':'–°–æ–±—Ä–∞—Ç—å'}</button>
                </div>
                <div class="craft-item" style="margin-top:10px;">
                    <div><b>‚õèÔ∏è –ö–ò–†–ö–ê</b><br><small>–£—Å–∫–æ—Ä—è–µ—Ç —à–∞—Ö—Ç—É. –¶–µ–Ω–∞: 30 –∫–∞–º–Ω—è</small></div>
                    <button class="btn" style="width:80px;" ${data.has_pickaxe?'disabled':''} onclick="craft('pick')">${data.has_pickaxe?'–ï—Å—Ç—å':'–°–æ–±—Ä–∞—Ç—å'}</button>
                </div>
            </div>
        `;
    }

    function setTab(t) { if(!isBusy){ currentTab=t; renderGame(); } }
    function setLoc(l) { if(!isBusy){ currentLoc=l; renderGame(); } }

    async function mine(time) {
        const loc = locations[currentLoc];
        if (data.energy < loc.energy) return alert("–ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏! –ù—É–∂–Ω–æ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å.");
        isBusy = true;
        const btn = document.getElementById('m-btn');
        const bar = document.getElementById('p-bar');
        const cont = document.getElementById('p-cont');

        btn.disabled = true; cont.style.display = 'block';
        setTimeout(() => { bar.style.transition = `width ${time}ms linear`; bar.style.width = '100%'; }, 50);

        setTimeout(async () => {
            data.energy -= loc.energy;
            data[loc.res] = (data[loc.res] || 0) + 1;
            await sb.from('users').update({ [loc.res]: data[loc.res], energy: data.energy }).eq('username', user);
            isBusy = false; renderGame();
        }, time);
    }

    async function sell(res, pr) {
        if (!data[res]) return;
        data.gold += data[res] * pr;
        data[res] = 0;
        await sb.from('users').update({ gold: data.gold, [res]: 0 }).eq('username', user);
        renderGame();
    }

    async function craft(type) {
        if (type === 'axe' && data.wood >= 20) {
            data.wood -= 20; data.has_axe = true;
            await sb.from('users').update({ wood: data.wood, has_axe: true }).eq('username', user);
        } else if (type === 'pick' && data.stone >= 30) {
            data.stone -= 30; data.has_pickaxe = true;
            await sb.from('users').update({ stone: data.stone, has_pickaxe: true }).eq('username', user);
        } else { return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤!"); }
        renderGame();
    }

    function startRegen() {
        setInterval(async () => {
            if (data.energy < 100) {
                data.energy += 1;
                document.getElementById('en-val').innerText = data.energy;
                document.getElementById('en-bar-fill').style.width = data.energy + '%';
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —ç–Ω–µ—Ä–≥–∏—é —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –±–∞–∑—É
                if (data.energy % 5 === 0) await sb.from('users').update({ energy: data.energy }).eq('username', user);
            }
        }, 30000); // 1 –µ–¥–∏–Ω–∏—Ü–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
    }
</script>
</body>
</html>
