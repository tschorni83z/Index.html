<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–ò–† –¢–¨–ú–´: FINAL</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #ffcc00; --hp: #ff4444; --st: #00ff88; --bg: #0a0a0a; --box: #151515; }
        body { background: var(--bg); color: #eee; font-family: sans-serif; margin: 0; padding: 5px; user-select: none; }
        .box { background: var(--box); padding: 10px; border-radius: 12px; border: 1px solid #333; max-width: 500px; margin: 5px auto; }
        
        /* –°—Ç–∞—Ç—É—Å—ã */
        .res-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-bottom: 8px; font-size: 11px; }
        .res-item { background: #000; padding: 5px; border-radius: 6px; border: 1px solid #222; text-align: center; color: var(--gold); }
        
        .bar-bg { width: 100%; height: 18px; background: #222; border-radius: 9px; margin: 4px 0; overflow: hidden; border: 1px solid #333; position: relative; }
        .bar-fill { height: 100%; transition: width 0.5s ease-in-out; width: 0%; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 10px; font-weight: bold; line-height: 18px; color: #fff; z-index: 2; text-shadow: 1px 1px #000; }

        /* –î–µ–π—Å—Ç–≤–∏—è */
        #action-box { display: none; margin: 10px 0; }
        .proc-bg { width: 100%; height: 20px; background: #000; border: 1px solid var(--gold); border-radius: 10px; overflow: hidden; position: relative; }
        .proc-fill { height: 100%; background: var(--gold); width: 0%; }
        .proc-text { position: absolute; width: 100%; text-align: center; line-height: 20px; font-size: 11px; color: #000; font-weight: bold; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .btn { width: 100%; padding: 12px; background: var(--gold); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; font-size: 12px; }
        .btn:disabled { background: #333; color: #666; cursor: not-allowed; }
        .tabs { display: flex; gap: 4px; margin: 10px 0; }
        .tab-btn { flex: 1; padding: 10px 2px; background: #1a1a1a; border: 1px solid #333; color: #888; border-radius: 8px; font-size: 11px; cursor: pointer; }
        .tab-active { background: var(--gold); color: #000; font-weight: bold; }

        /* –ß–∞—Ç */
        .chat-container { display: flex; gap: 5px; height: 150px; margin-top: 10px; }
        .online-list { width: 90px; background: #000; border: 1px solid #333; border-radius: 8px; font-size: 10px; padding: 5px; overflow-y: auto; color: #00ff88; text-align: left; }
        .chat-box { flex: 1; background: #000; border: 1px solid #333; border-radius: 8px; display: flex; flex-direction: column; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 5px; font-size: 11px; text-align: left; line-height: 1.3; }
        #chat-in { background: none; border: none; border-top: 1px solid #333; color: #fff; padding: 8px; font-size: 12px; }

        #log { background: #000; border: 1px solid #222; padding: 8px; height: 80px; overflow-y: auto; font-size: 11px; color: #aaa; border-radius: 8px; text-align: left; margin-top: 10px; }
        .time { color: #555; margin-right: 5px; }
    </style>
</head>
<body>

<div id="game-container">
    <h1 style="color: var(--gold); text-align: center;">–ú–ò–† –¢–¨–ú–´</h1>
    <div class="box">
        <input type="text" id="u_nick" placeholder="–ù–ò–ö–ù–ï–ô–ú" style="width:85%; padding:12px; margin-bottom:10px; background:#000; border:1px solid #444; color:#fff; border-radius:8px;">
        <input type="password" id="u_pass" placeholder="–ü–ê–†–û–õ–¨" style="width:85%; padding:12px; margin-bottom:10px; background:#000; border:1px solid #444; color:#fff; border-radius:8px;">
        <button class="btn" onclick="auth('login')">–í–û–ô–¢–ò</button>
        <button class="btn" style="background:none; color:var(--gold); border:1px solid var(--gold);" onclick="auth('reg')">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
    </div>
</div>

<script>
    const S_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co";
    const S_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";
    const sb = window.supabase.createClient(S_URL, S_KEY);

    let user = null, data = {}, isBusy = false, currentTab = 'world', currentLoc = '–õ–∞–≥–µ—Ä—å';

    // –í—Ö–æ–¥ –∏ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    async function auth(mode) {
        const n = document.getElementById('u_nick').value.trim();
        const p = document.getElementById('u_pass').value.trim();
        if(!n || !p) return;

        if(mode === 'reg') {
            const { error } = await sb.from('users').insert({ 
                username: n, email_hidden: p, current_hp: 100, stamina: 100, gold: 100, 
                str: 5, vit: 5, agi: 5, int: 5, wood: 0, iron: 0, coal: 0,
                equip: { helmet: "–ù–µ—Ç", body: "–¢–∫–∞–Ω—å", weapon: "–ö—É–ª–∞–∫–∏", tool: "–ö–∏—Ä–∫–∞" },
                location: '–õ–∞–≥–µ—Ä—å', last_seen: new Date().toISOString() 
            });
            if(!error) alert("–ì–µ—Ä–æ–π —Å–æ–∑–¥–∞–Ω! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.");
            else alert("–ò–º—è –∑–∞–Ω—è—Ç–æ.");
        } else {
            const { data: u, error } = await sb.from('users').select('*').eq('username', n).single();
            if (u && u.email_hidden === p) {
                user = n; data = u;
                localStorage.setItem('rpg_nick', n);
                localStorage.setItem('rpg_pass', p);
                startGame();
            } else alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å.");
        }
    }

    function startGame() {
        renderGame();
        initChat();
        setInterval(autoSave, 10000); 
        setInterval(regenTick, 2000);
        setInterval(updateOnline, 5000);
    }

    function renderGame() {
        if(!user) return;
        const mHp = 100 + (parseInt(data.vit || 5) * 10);
        const mSt = 100 + (parseInt(data.str || 5) * 5);
        const curHp = Math.max(0, parseFloat(data.current_hp || 0));
        const curSt = Math.max(0, parseFloat(data.stamina || 0));

        document.getElementById('game-container').innerHTML = `
            <div class="box">
                <div class="res-grid">
                    <div class="res-item">üí∞ ${Math.floor(data.gold || 0)}</div>
                    <div class="res-item">üå≤ ${data.wood||0}</div>
                    <div class="res-item">‚õèÔ∏è ${data.iron||0}</div>
                    <div class="res-item">‚¨õ ${data.coal||0}</div>
                    <div class="res-item">üìç ${currentLoc}</div>
                </div>
                <div class="bar-bg"><div class="bar-text">‚ù§Ô∏è HP: ${Math.floor(curHp)} / ${mHp}</div><div class="bar-fill" style="width:${(curHp/mHp)*100}%; background:var(--hp)"></div></div>
                <div class="bar-bg"><div class="bar-text">üîã ST: ${Math.floor(curSt)} / ${mSt}</div><div class="bar-fill" style="width:${(curSt/mSt)*100}%; background:var(--st)"></div></div>
                <div id="action-box"><div class="proc-bg"><div id="proc-fill" class="proc-fill"></div><div id="proc-text" class="proc-text">0%</div></div></div>
            </div>

            <div class="tabs">
                <button class="tab-btn ${currentTab==='world'?'tab-active':''}" onclick="setTab('world')">–ú–ò–†</button>
                <button class="tab-btn ${currentTab==='mine'?'tab-active':''}" onclick="setTab('mine')">–î–û–ë–´–ß–ê</button>
                <button class="tab-btn ${currentTab==='hero'?'tab-active':''}" onclick="setTab('hero')">–ì–ï–†–û–ô</button>
                <button class="tab-btn ${currentTab==='shop'?'tab-active':''}" onclick="setTab('shop')">–†–´–ù–û–ö</button>
            </div>
            <div id="tab-content">${renderTabContent()}</div>

            <div class="box chat-container">
                <div class="online-list" id="online-list">...</div>
                <div class="chat-box">
                    <div id="chat-msgs"></div>
                    <input type="text" id="chat-in" placeholder="–ß–∞—Ç..." onkeypress="if(event.key==='Enter') sendChat()">
                </div>
            </div>
            <div id="log"></div>
            <button onclick="logout()" style="color: grey; background: none; border: none; font-size: 10px; margin-top: 10px;">–°–º–µ–Ω–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
        `;
    }

    function renderTabContent() {
        if(currentTab === 'world') return `
            <div class="box">
                <button class="btn" onclick="startAction('travel', '–õ–µ—Å', 5000)">üå≤ –í –õ–ï–° (5—Å)</button>
                <button class="btn" onclick="startAction('travel', '–®–∞—Ö—Ç–∞', 8000)">‚õèÔ∏è –í –®–ê–•–¢–£ (8—Å)</button>
                <button class="btn" onclick="startAction('travel', '–õ–∞–≥–µ—Ä—å', 3000)" style="background:#444; color:#fff;">üõñ –í –õ–ê–ì–ï–†–¨</button>
            </div>`;
        if(currentTab === 'mine') return `
            <div class="box">
                ${currentLoc==='–õ–∞–≥–µ—Ä—å'?'<p>–ó–¥–µ—Å—å –Ω–µ—á–µ–≥–æ –¥–æ–±—ã–≤–∞—Ç—å.</p>':`<button class="btn" onclick="startAction('mine', '${currentLoc}', 4000)">–î–û–ë–´–í–ê–¢–¨ (-20 ST)</button>`}
            </div>`;
        if(currentTab === 'hero') return `
            <div class="box" style="text-align: left;">
                <h3>${user}</h3>
                <p>üí™ –°–∏–ª–∞: ${data.str} | üéØ –õ–æ–≤–∫–æ—Å—Ç—å: ${data.agi}</p>
                <p>üß† –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç: ${data.int} | ü©∏ –ñ–∏–≤—É—á–µ—Å—Ç—å: ${data.vit}</p>
                <hr border="0" style="border-top: 1px solid #333">
                <p>ü™ñ –®–ª–µ–º: ${data.equip.helmet}</p>
                <p>üß• –ë—Ä–æ–Ω—è: ${data.equip.body}</p>
                <p>‚öîÔ∏è –û—Ä—É–∂–∏–µ: ${data.equip.weapon}</p>
            </div>`;
        if(currentTab === 'shop') return `
            <div class="box">
                <button class="btn" onclick="sellItem('wood', 3)">–ü—Ä–æ–¥–∞—Ç—å –î–µ—Ä–µ–≤–æ (3üí∞)</button>
                <button class="btn" onclick="sellItem('iron', 10)">–ü—Ä–æ–¥–∞—Ç—å –ñ–µ–ª–µ–∑–æ (10üí∞)</button>
                <button class="btn" onclick="buyItem('hp', 50)">–ö—É–ø–∏—Ç—å –ó–µ–ª—å–µ HP (50üí∞)</button>
            </div>`;
    }

    // –õ–æ–≥–∏–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π
    function startAction(type, target, duration) {
        if(isBusy || (type==='mine' && data.stamina < 20)) return;
        isBusy = true; renderGame();
        document.getElementById('action-box').style.display = 'block';
        let start = Date.now();
        let interval = setInterval(() => {
            let elapsed = Date.now() - start;
            let percent = Math.min(100, Math.floor((elapsed / duration) * 100));
            document.getElementById('proc-fill').style.width = percent + '%';
            document.getElementById('proc-text').innerText = percent + '%';
            if(elapsed >= duration) {
                clearInterval(interval);
                isBusy = false;
                if(type === 'travel') { currentLoc = target; addLog(`üìç –í—ã –ø—Ä–∏–±—ã–ª–∏ –≤ ${target}`); }
                else { 
                    data.stamina -= 20; 
                    let res = currentLoc === '–õ–µ—Å' ? 'wood' : 'iron';
                    data[res] = (parseInt(data[res]) || 0) + 1;
                    addLog(`‚úÖ –î–æ–±—ã—Ç–æ: ${res} +1`);
                }
                autoSave(); renderGame();
            }
        }, 100);
    }

    // –†—ã–Ω–æ–∫
    async function sellItem(res, price) {
        if(data[res] > 0) {
            data[res]--;
            data.gold = (parseInt(data.gold) || 0) + price;
            addLog(`üí∞ –ü—Ä–æ–¥–∞–Ω–æ ${res} –∑–∞ ${price} –∑–æ–ª–æ—Ç–∞.`);
            await autoSave();
            renderGame();
        }
    }

    async function buyItem(type, cost) {
        if(data.gold >= cost) {
            data.gold -= cost;
            if(type === 'hp') data.current_hp = Math.min(100+(data.vit*10), data.current_hp+30);
            await autoSave();
            renderGame();
            addLog(`üß™ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∑–µ–ª—å–µ.`);
        }
    }

    // –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function regenTick() {
        if(isBusy || !user) return;
        const mHp = 100 + (parseInt(data.vit || 5) * 10);
        const mSt = 100 + (parseInt(data.str || 5) * 5);
        if(data.current_hp < mHp) data.current_hp = Math.min(mHp, parseFloat(data.current_hp) + 0.5);
        if(data.stamina < mSt) data.stamina = Math.min(mSt, parseFloat(data.stamina) + 1.2);
        renderGame();
    }

    async function autoSave() {
        if(!user) return;
        data.location = currentLoc;
        data.last_seen = new Date().toISOString();
        await sb.from('users').update(data).eq('username', user);
    }

    // –ß–∞—Ç –∏ –û–Ω–ª–∞–π–Ω
    async function initChat() {
        sb.channel('global').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => {
            const box = document.getElementById('chat-msgs');
            if(box) {
                box.innerHTML += `<div><b>${p.new.user}:</b> ${p.new.text}</div>`;
                box.scrollTop = box.scrollHeight;
            }
        }).subscribe();
    }

    async function sendChat() {
        const inp = document.getElementById('chat-in');
        if(!inp.value.trim()) return;
        await sb.from('messages').insert({ user: user, text: inp.value });
        inp.value = '';
    }

    async function updateOnline() {
        const { data: users } = await sb.from('users').select('username, location, last_seen');
        const list = document.getElementById('online-list');
        if(!list) return;
        const now = new Date();
        const active = users.filter(u => (now - new Date(u.last_seen)) < 30000);
        list.innerHTML = `<b>–û–ù–õ–ê–ô–ù:</b><br>` + active.map(u => u.username === user ? `<u>${u.username}</u>` : u.username).join('<br>');
    }

    function addLog(m) {
        const l = document.getElementById('log');
        if(l) l.innerHTML = `<div><span class="time">[${new Date().toLocaleTimeString()}]</span> ${m}</div>` + l.innerHTML;
    }

    function setTab(t) { currentTab = t; renderGame(); }
    function logout() { localStorage.clear(); location.reload(); }

    window.onload = async () => {
        const n = localStorage.getItem('rpg_nick'), p = localStorage.getItem('rpg_pass');
        if(n && p) {
            const { data: u } = await sb.from('users').select('*').eq('username', n).single();
            if(u && u.email_hidden === p) { user = n; data = u; startGame(); }
        }
    };
</script>
</body>
</html>
