<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TSCHORNI: CARNAGE ERA</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #ffcc00; --hp: #ff4444; --st: #00ff88; --bg: #0a0a0a; --box: #151515; --border: #333; }
        body { background: var(--bg); color: #eee; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 5px; user-select: none; font-size: 14px; }
        .box { background: var(--box); padding: 10px; border-radius: 8px; border: 1px solid var(--border); max-width: 500px; margin: 5px auto; }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã */
        .res-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-bottom: 8px; }
        .res-item { background: #000; padding: 5px; border-radius: 4px; text-align: center; color: var(--gold); font-size: 11px; border: 1px solid #222; }
        .bar-bg { width: 100%; height: 18px; background: #222; border-radius: 9px; margin: 3px 0; overflow: hidden; position: relative; border: 1px solid #444; }
        .bar-fill { height: 100%; transition: width 0.5s; width: 0%; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 10px; font-weight: bold; line-height: 18px; color: #fff; z-index: 2; }

        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; margin: 8px 0; }
        .tab-btn { padding: 8px 2px; background: #222; border: 1px solid #444; color: #888; border-radius: 4px; cursor: pointer; font-size: 10px; }
        .tab-active { background: var(--gold); color: #000; font-weight: bold; border-color: var(--gold); }

        .btn { width: 100%; padding: 10px; background: var(--gold); color: #000; border: none; border-radius: 5px; font-weight: bold; margin-top: 5px; cursor: pointer; }
        .btn:disabled { background: #333; color: #666; }

        /* –ë–æ–π Carnage */
        .fight-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center; }
        .zone-btn { padding: 8px; margin: 2px; background: #222; border: 1px solid #444; color: #fff; border-radius: 4px; width: 100%; }
        .zone-active { background: #440000; border-color: #ff0000; }
        .zone-def-active { background: #004400; border-color: #00ff00; }

        /* –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å */
        .inv-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }
        .slot { background: #000; border: 1px solid #333; aspect-ratio: 1/1; border-radius: 4px; font-size: 9px; display: flex; align-items: center; justify-content: center; text-align: center; }

        #chat-area { height: 120px; overflow-y: auto; font-size: 12px; background: #000; padding: 5px; border-radius: 4px; border: 1px solid #222; }
        #log { height: 60px; overflow-y: auto; font-size: 11px; color: #aaa; padding: 5px; margin-top: 5px; background: #000; border-radius: 4px; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="box" style="margin-top: 50px; text-align: center;">
        <h2 style="color: var(--gold)">TSCHORNI</h2>
        <input type="text" id="u_nick" placeholder="–ù–ò–ö" style="width:80%; padding:10px; margin:5px; background:#111; border:1px solid #333; color:#fff;">
        <input type="password" id="u_pass" placeholder="–ü–ê–†–û–õ–¨" style="width:80%; padding:10px; margin:5px; background:#111; border:1px solid #333; color:#fff;">
        <button class="btn" onclick="login()">–ò–ì–†–ê–¢–¨</button>
    </div>
</div>

<div id="game-screen" style="display: none;">
    <div class="box">
        <div class="res-grid">
            <div class="res-item">üí∞ <span id="r-gold">0</span></div>
            <div class="res-item">üí† EXP: <span id="r-exp">0</span></div>
            <div class="res-item">üéñÔ∏è LVL: <span id="r-lvl">1</span></div>
        </div>
        <div class="bar-bg"><div class="bar-text" id="hp-txt">HP: 100/100</div><div id="hp-f" class="bar-fill" style="background:var(--hp)"></div></div>
        <div class="bar-bg"><div class="bar-text" id="st-txt">ST: 100/100</div><div id="st-f" class="bar-fill" style="background:var(--st)"></div></div>
    </div>

    <div class="tabs">
        <button class="tab-btn" id="t-world" onclick="setTab('world')">–ú–ò–†</button>
        <button class="tab-btn" id="t-mine" onclick="setTab('mine')">–®–ê–•–¢–ê</button>
        <button class="tab-btn" id="t-fight" onclick="setTab('fight')">–ë–û–ô</button>
        <button class="tab-btn" id="t-inv" onclick="setTab('inv')">–ò–ù–í–ï–ù–¢</button>
        <button class="tab-btn" id="t-shop" onclick="setTab('shop')">–†–´–ù–û–ö</button>
    </div>

    <div id="tab-content" class="box" style="min-height: 150px;"></div>

    <div class="box">
        <div id="chat-area"></div>
        <input type="text" id="chat-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="width:100%; background:#000; border:none; color:#fff; padding:8px; border-top:1px solid #222;" onkeypress="if(event.key==='Enter') sendChat()">
    </div>
    <div id="log"></div>
</div>

<script>
    const S_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co";
    const S_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";
    const sb = window.supabase.createClient(S_URL, S_KEY);

    let user = null, data = {}, curTab = 'world', isBusy = false;
    let attackZone = 1, defenseZone = 1;

    // –ê–≤—Ç–æ-–ª–æ–≥–∏–Ω
    window.onload = () => {
        const saved = localStorage.getItem('tschorni_auth');
        if(saved) {
            const auth = JSON.parse(saved);
            document.getElementById('u_nick').value = auth.n;
            document.getElementById('u_pass').value = auth.p;
            login();
        }
    }

    async function login() {
        const n = document.getElementById('u_nick').value;
        const p = document.getElementById('u_pass').value;
        const { data: u } = await sb.from('users').select('*').eq('username', n).single();
        
        if(u && u.email_hidden === p) {
            user = n; data = u;
            localStorage.setItem('tschorni_auth', JSON.stringify({n, p}));
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            
            // –û—Ñ–ª–∞–π–Ω —Ä–µ–≥–µ–Ω
            const offlineSeconds = (new Date() - new Date(data.last_seen)) / 1000;
            if(offlineSeconds > 10) {
                data.current_hp = Math.min(100+(data.vit*10), data.current_hp + (offlineSeconds * 0.1));
                data.stamina = Math.min(100+(data.str*5), data.stamina + (offlineSeconds * 0.2));
                addLog(`–í—ã –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∏ ${Math.floor(offlineSeconds/60)} –º–∏–Ω. HP/ST –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.`);
            }
            
            startApp();
        } else {
            alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞!");
        }
    }

    function startApp() {
        updateUI();
        setTab('world');
        setInterval(tick, 2000);
        setInterval(() => sb.from('users').update({
            current_hp: data.current_hp, stamina: data.stamina, gold: data.gold, 
            wood: data.wood, iron: data.iron, coal: data.coal, stone: data.stone,
            exp: data.exp, level: data.level, last_seen: new Date().toISOString()
        }).eq('username', user), 10000);
    }

    function updateUI() {
        const mHp = 100 + (data.vit * 10);
        const mSt = 100 + (data.str * 5);
        document.getElementById('r-gold').innerText = Math.floor(data.gold);
        document.getElementById('r-exp').innerText = data.exp;
        document.getElementById('r-lvl').innerText = data.level;
        document.getElementById('hp-txt').innerText = `HP: ${Math.floor(data.current_hp)}/${mHp}`;
        document.getElementById('hp-f').style.width = (data.current_hp/mHp*100)+'%';
        document.getElementById('st-txt').innerText = `ST: ${Math.floor(data.stamina)}/${mSt}`;
        document.getElementById('st-f').style.width = (data.stamina/mSt*100)+'%';
    }

    function setTab(t) {
        curTab = t;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
        document.getElementById('t-'+t).classList.add('tab-active');
        const c = document.getElementById('tab-content');

        if(t === 'world') {
            c.innerHTML = `<h4>–õ–æ–∫–∞—Ü–∏—è: –õ–∞–≥–µ—Ä—å</h4>
                <button class="btn" onclick="travel('–õ–µ—Å')">üå≤ –í –õ–ï–° (ST-5)</button>
                <button class="btn" onclick="travel('–ì–æ—Ä–æ–¥')">üèõÔ∏è –í –ì–û–†–û–î (ST-5)</button>`;
        } else if(t === 'mine') {
            c.innerHTML = `<h4>–®–∞—Ö—Ç–∞ (–ì–ª—É–±–∏–Ω–∞: ${data.depth || 0}–º)</h4>
                <button class="btn" onclick="mine()">–ö–û–ü–ê–¢–¨ (-15 ST)</button>
                <button class="btn" onclick="goDeeper()">–ò–î–¢–ò –ì–õ–£–ë–ñ–ï</button>`;
        } else if(t === 'fight') {
            renderFight();
        } else if(t === 'inv') {
            c.innerHTML = `<h4>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h4>
                <div class="inv-grid">${Array(10).fill('<div class="slot">–ü—É—Å—Ç–æ</div>').join('')}</div>
                <p style="font-size:11px; margin-top:10px;">üí™ –°–∏–ª–∞: ${data.str} | üõ°Ô∏è –ñ–∏–≤: ${data.vit} | üçÄ –£–¥–∞—á–∞: 5</p>`;
        } else if(t === 'shop') {
            c.innerHTML = `<h4>–†—ã–Ω–æ–∫</h4>
                <div style="display:flex; gap:5px;">
                    <button class="btn" style="font-size:9px" onclick="sell('wood', 5)">üå≤ –î–µ—Ä–µ–≤–æ (5üí∞)</button>
                    <button class="btn" style="font-size:9px" onclick="sell('iron', 15)">‚õèÔ∏è –ñ–µ–ª–µ–∑–æ (15üí∞)</button>
                </div>
                <button class="btn" style="background:#444; color:#fff" onclick="buy('hp_pot', 50)">üß™ –ó–µ–ª—å–µ HP (50üí∞)</button>`;
        }
    }

    // –ë–æ–π Carnage
    function renderFight() {
        document.getElementById('tab-content').innerHTML = `
            <div class="fight-grid">
                <div>
                    <p>–ê–¢–ê–ö–ê</p>
                    ${[1,2,3,4,5].map(i => `<button class="zone-btn ${attackZone==i?'zone-active':''}" onclick="attackZone=${i};renderFight()">–ó–æ–Ω–∞ ${i}</button>`).join('')}
                </div>
                <div>
                    <p>–ó–ê–©–ò–¢–ê</p>
                    ${[1,2,3,4,5].map(i => `<button class="zone-btn ${defenseZone==i?'zone-def-active':''}" onclick="defenseZone=${i};renderFight()">–ó–æ–Ω–∞ ${i}</button>`).join('')}
                </div>
            </div>
            <button class="btn" onclick="doFightHit()">–£–î–ê–†–ò–¢–¨!</button>`;
    }

    function doFightHit() {
        if(data.stamina < 10) return addLog("–ù–µ—Ç —Å–∏–ª –¥–ª—è –±–æ—è!");
        data.stamina -= 10;
        let enemyZone = Math.floor(Math.random()*5)+1;
        let win = attackZone !== enemyZone;
        if(win) {
            let xp = 10 + (data.level * 2);
            data.exp += xp;
            addLog(`–£–¥–∞—Ä! –í—ã –Ω–∞–Ω–µ—Å–ª–∏ —É—Ä–æ–Ω –∏ –ø–æ–ª—É—á–∏–ª–∏ ${xp} EXP.`);
            checkLvl();
        } else {
            data.current_hp -= 15;
            addLog(`–ë–õ–û–ö! –ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫–æ–≤–∞–ª (-15 HP).`);
        }
        updateUI();
    }

    function checkLvl() {
        let need = data.level * 100;
        if(data.exp >= need) {
            data.level++;
            data.str += 2; data.vit += 2;
            addLog(`–£–†–û–í–ï–ù–¨ –ü–û–í–´–®–ï–ù! –¢–µ–ø–µ—Ä—å –≤—ã ${data.level} —É—Ä–æ–≤–Ω—è.`);
        }
    }

    function mine() {
        if(data.stamina < 15) return;
        data.stamina -= 15;
        let r = Math.random();
        if(r > 0.5) { data.iron++; addLog("–î–æ–±—ã—Ç–æ –∂–µ–ª–µ–∑–æ!"); }
        else { data.stone = (data.stone||0)+1; addLog("–î–æ–±—ã—Ç –∫–∞–º–µ–Ω—å."); }
        updateUI();
    }

    function sell(item, price) {
        if(data[item] > 0) {
            data[item]--;
            data.gold += price;
            addLog(`–ü—Ä–æ–¥–∞–Ω–æ ${item} –∑–∞ ${price}üí∞`);
            updateUI();
            setTab('shop');
        }
    }

    function tick() {
        const mHp = 100 + (data.vit * 10);
        const mSt = 100 + (data.str * 5);
        if(data.current_hp < mHp) data.current_hp = Math.min(mHp, data.current_hp + 0.5);
        if(data.stamina < mSt) data.stamina = Math.min(mSt, data.stamina + 1);
        updateUI();
    }

    function addLog(m) {
        const l = document.getElementById('log');
        l.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${m}</div>` + l.innerHTML;
    }

    async function sendChat() {
        const i = document.getElementById('chat-in');
        if(!i.value) return;
        await sb.from('messages').insert({ user: user, text: i.value });
        i.value = '';
    }

    function initChat() {
        sb.channel('global').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => {
            const a = document.getElementById('chat-area');
            a.innerHTML += `<div><b>${p.new.user}:</b> ${p.new.text}</div>`;
            a.scrollTop = a.scrollHeight;
        }).subscribe();
    }
    initChat();
</script>
</body>
</html>
