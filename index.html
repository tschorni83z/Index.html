<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TSCHORNI: MOB HUNTER</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #ffcc00; --hp: #ff4444; --st: #00ff88; --mp: #4488ff; --bg: #0d0d0d; --box: #1a1a1a; --border: #333; }
        body { background: var(--bg); color: #ddd; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 5px; user-select: none; font-size: 14px; }
        .box { background: var(--box); padding: 10px; border-radius: 8px; border: 1px solid var(--border); margin: 5px auto; max-width: 500px; }
        
        .bar-bg { width: 100%; height: 18px; background: #222; border-radius: 4px; margin: 3px 0; overflow: hidden; position: relative; border: 1px solid #444; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 10px; font-weight: bold; line-height: 18px; color: #fff; z-index: 2; text-shadow: 1px 1px #000; }

        .tabs { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; margin: 10px 0; }
        .tab-btn { padding: 10px 2px; background: #222; border: 1px solid #444; color: #888; font-size: 9px; border-radius: 4px; cursor: pointer; }
        .tab-active { background: var(--gold); color: #000; font-weight: bold; border-color: var(--gold); }
        .btn { background: var(--gold); color: #000; border: none; padding: 10px; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%; margin: 5px 0; }
        
        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
        th, td { border: 1px solid #333; padding: 5px; text-align: center; }
        th { background: #222; color: var(--gold); }

        .mob-box { background: #200; border: 1px solid #800; padding: 10px; border-radius: 6px; text-align: center; margin-bottom: 10px; }
        #log { height: 80px; overflow-y: auto; font-size: 10px; color: #aaa; background: #000; padding: 5px; border-top: 1px solid #222; }
    </style>
</head>
<body>

<div id="auth-ui">
    <div class="box" style="margin-top: 40px; text-align: center;">
        <h2 style="color: var(--gold)">TSCHORNI: REBORN</h2>
        <input type="text" id="u_nick" placeholder="–ù–ò–ö–ù–ï–ô–ú (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)" style="width:85%; padding:12px; margin:5px; background:#111; border:1px solid #333; color:#fff;">
        <input type="password" id="u_pass" placeholder="–ü–ê–†–û–õ–¨" style="width:85%; padding:12px; margin:5px; background:#111; border:1px solid #333; color:#fff;">
        <button class="btn" onclick="auth('login')">–í–û–ô–¢–ò</button>
        <button class="btn" onclick="auth('reg')" style="background:none; border:1px solid var(--gold); color:var(--gold);">–°–û–ó–î–ê–¢–¨ –ì–ï–†–û–Ø</button>
        <div id="auth-msg" style="margin-top:10px; font-size:12px; color:#aaa;"></div>
    </div>
</div>

<div id="game-ui" style="display: none;">
    <div class="box">
        <div style="display:flex; justify-content: space-between; font-size: 12px; color: var(--gold); margin-bottom: 5px;">
            <span>–£–†–û–í–ï–ù–¨: <b id="r-lvl">1</b></span>
            <span>–ó–û–õ–û–¢–û: <b id="r-gold">0</b>üí∞</span>
        </div>
        <div class="bar-bg"><div class="bar-text" id="hp-txt">HP</div><div id="hp-f" class="bar-fill" style="background:var(--hp);"></div></div>
        <div class="bar-bg"><div class="bar-text" id="st-txt">ST</div><div id="st-f" class="bar-fill" style="background:var(--st);"></div></div>
    </div>

    <div class="tabs">
        <button class="tab-btn tab-active" id="t-world" onclick="setTab('world')">–ú–ò–†</button>
        <button class="tab-btn" id="t-fight" onclick="setTab('fight')">–û–•–û–¢–ê</button>
        <button class="tab-btn" id="t-inv" onclick="setTab('inv')">–ì–ï–†–û–ô</button>
        <button class="tab-btn" id="t-shop" onclick="setTab('shop')">–†–´–ù–û–ö</button>
        <button class="tab-btn" id="t-stat" onclick="setTab('stat')">–¢–û–ü</button>
    </div>

    <div id="tab-content" class="box" style="min-height: 220px;"></div>
    <div id="log" class="box"></div>
</div>

<script>
    const S_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co";
    const S_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT"; // ‚Üê –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π anon key –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    const sb = Supabase.createClient(S_URL, S_KEY);

    let userData = null;
    let enemy = null;
    let curTab = 'world';
    let saveTimer = null;

    const MOBS = {
        '–õ–µ—Å':   [ { n: '–î–∏–∫–∏–π –í–æ–ª–∫',       hp: 50,  maxHp: 50,  dmg: 5,  exp: 20,  gold: 10 },
                   { n: '–õ–µ—Å–Ω–æ–π –†–∞–∑–±–æ–π–Ω–∏–∫', hp: 80,  maxHp: 80,  dmg: 8,  exp: 40,  gold: 25 } ],
        '–®–∞—Ö—Ç–∞': [ { n: '–ö–∞–º–µ–Ω–Ω—ã–π –°–ª–∏–∑–µ–Ω—å', hp: 100, maxHp:100, dmg: 4,  exp: 35,  gold: 15 },
                   { n: '–ì–æ–±–ª–∏–Ω-–®–∞—Ö—Ç–µ—Ä',    hp: 150, maxHp:150, dmg:12,  exp: 70,  gold: 50 } ]
    };

    const EXP_TABLE = [0, 100, 250, 500, 1000, 2000, 4000, 8000, 15000, 30000];

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //  –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function auth(mode) {
        const nick = (document.getElementById('u_nick').value || '').trim();
        const pass = document.getElementById('u_pass').value;
        const msgEl = document.getElementById('auth-msg');

        if (!nick || nick.length < 3 || nick.includes(' ')) {
            msgEl.innerHTML = "–ù–∏–∫: –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤";
            return;
        }
        if (!pass || pass.length < 6) {
            msgEl.innerHTML = "–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤";
            return;
        }

        msgEl.innerHTML = "–ü–æ–¥–æ–∂–¥–∏—Ç–µ...";

        const email = nick.toLowerCase() + "@tschorni.game";

        try {
            if (mode === 'reg') {
                const { data, error } = await sb.auth.signUp({
                    email,
                    password: pass,
                    options: { data: { username: nick } }
                });

                if (error) throw error;
                msgEl.innerHTML = "–ì–µ—Ä–æ–π —Å–æ–∑–¥–∞–Ω! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.";
            } else {
                const { data: { session }, error } = await sb.auth.signInWithPassword({
                    email,
                    password: pass
                });

                if (error) throw error;
                await loadPlayerData();
            }
        } catch (err) {
            msgEl.innerHTML = "–û—à–∏–±–∫–∞: " + (err.message || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ");
        }
    }

    async function loadPlayerData() {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) return;

        const username = user.user_metadata?.username;
        if (!username) {
            addLog("–û—à–∏–±–∫–∞: –Ω–∏–∫–Ω–µ–π–º –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø—Ä–æ—Ñ–∏–ª–µ");
            return;
        }

        const { data, error } = await sb
            .from('users')
            .select('*')
            .eq('username', username)
            .single();

        if (error || !data) {
            // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
            const initial = {
                username,
                current_hp: 150,
                stamina: 100,
                gold: 200,
                str: 5,
                vit: 5,
                agi: 5,
                int: 5,
                exp: 0,
                level: 1,
                location: '–õ–∞–≥–µ—Ä—å',
                inventory: [{name:'–†–∂–∞–≤—ã–π –Ω–æ–∂', str:2, icon:'üî™'}, {name:'–¢—Ä—è–ø–∫–∏', vit:2, icon:'üëï'}]
            };

            const { error: insErr } = await sb.from('users').insert(initial);
            if (insErr) {
                addLog("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: " + insErr.message);
                return;
            }
            userData = initial;
        } else {
            userData = data;
        }

        document.getElementById('auth-ui').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        startApp();
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //  –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function startApp() {
        updateUI();
        setTab('world');

        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        if (saveTimer) clearInterval(saveTimer);
        saveTimer = setInterval(saveData, 10000);

        // –†–µ–≥–µ–Ω –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        setInterval(tick, 2000);
    }

    async function saveData() {
        if (!userData) return;
        const { error } = await sb.from('users').update(userData).eq('username', userData.username);
        if (!error) addLog("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
    }

    function updateUI() {
        if (!userData) return;

        const maxHp = 100 + userData.vit * 10;
        const maxSt = 100 + userData.str * 5;

        document.getElementById('r-lvl').innerText  = userData.level;
        document.getElementById('r-gold').innerText = Math.floor(userData.gold);

        setBar('hp', userData.current_hp, maxHp);
        setBar('st', userData.stamina,   maxSt);
    }

    function setBar(id, cur, max) {
        const perc = Math.max(0, Math.min(100, cur / max * 100));
        document.getElementById(`${id}-txt`).innerText = `${id.toUpperCase()}: ${Math.floor(cur)}/${max}`;
        document.getElementById(`${id}-f`).style.width = perc + '%';
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //  –¢–ê–ë–´ –∏ –õ–û–ì–ò–ö–ê –ò–ì–†–´
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function setTab(t) {
        curTab = t;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
        document.getElementById('t-'+t).classList.add('tab-active');

        const c = document.getElementById('tab-content');

        if (t === 'world') {
            c.innerHTML = `
                <h4>–õ–æ–∫–∞—Ü–∏—è: ${userData?.location || '??'}</h4>
                <p>–ö—É–¥–∞ –∏–¥—ë–º?</p>
                <button class="btn" onclick="travel('–õ–µ—Å')">üå≤ –¢–µ–º–Ω—ã–π –õ–µ—Å</button>
                <button class="btn" onclick="travel('–®–∞—Ö—Ç–∞')">‚õèÔ∏è –ì–ª—É–±–æ–∫–∞—è –®–∞—Ö—Ç–∞</button>
                <button class="btn" style="background:#444;color:#fff" onclick="travel('–õ–∞–≥–µ—Ä—å')">üõñ –õ–∞–≥–µ—Ä—å (–±–µ–∑–æ–ø–∞—Å–Ω–æ)</button>`;
        }
        else if (t === 'fight') {
            if (userData.location === '–õ–∞–≥–µ—Ä—å') {
                c.innerHTML = `<p style="text-align:center;padding:60px 0">–í –ª–∞–≥–µ—Ä–µ –º–æ–Ω—Å—Ç—Ä–æ–≤ –Ω–µ—Ç. –ò–¥–∏—Ç–µ –¥–∞–ª—å—à–µ!</p>`;
            } else {
                renderFight();
            }
        }
        else if (t === 'inv') {
            renderHero();
        }
        else if (t === 'shop') {
            c.innerHTML = `<h4>–¢–æ—Ä–≥–æ–≤–µ—Ü</h4>
                <div class="box" style="margin:0;border-color:#444">
                    –ó–µ–ª—å–µ –∂–∏–∑–Ω–∏ (Full HP) ‚Äî 50 üí∞
                    <button onclick="buyPot()">–ö—É–ø–∏—Ç—å</button>
                </div>`;
        }
        else if (t === 'stat') {
            c.innerHTML = `<p style="text-align:center;padding:60px 0">–¢–û–ü —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è...</p>`;
        }
    }

    function renderFight() {
        const c = document.getElementById('tab-content');
        if (!enemy) {
            c.innerHTML = `<h4>–ó–∞—Å–∞–¥–∞!</h4><button class="btn" onclick="spawnEnemy()">–ò–°–ö–ê–¢–¨ –ú–û–ë–ê</button>`;
            return;
        }
        c.innerHTML = `
            <div class="mob-box">
                <div style="font-weight:bold;color:var(--hp)">${enemy.n}</div>
                <div class="bar-bg"><div id="en-hp" class="bar-fill" style="background:var(--hp);width:${(enemy.hp/enemy.maxHp*100)}%"></div></div>
                <div style="font-size:10px">${Math.floor(enemy.hp)} / ${enemy.maxHp} HP</div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;">
                <button class="btn" style="height:60px" onclick="attack()">–£–î–ê–†–ò–¢–¨</button>
                <button class="btn" style="height:60px;background:#555;color:#fff" onclick="enemy=null;setTab('fight')">–°–ë–ï–ñ–ê–¢–¨</button>
            </div>`;
    }

    function spawnEnemy() {
        const loc = userData.location;
        const mobs = MOBS[loc] || [];
        if (mobs.length === 0) return;
        enemy = { ...mobs[Math.floor(Math.random() * mobs.length)] };
        renderFight();
    }

    function attack() {
        if (!enemy || userData.stamina < 10) {
            addLog(userData.stamina < 10 ? "–ú–∞–ª–æ —Å—Ç–∞–º–∏–Ω—ã!" : "–ù–µ—Ç —Ü–µ–ª–∏");
            return;
        }

        userData.stamina -= 10;
        let dmg = 5 + userData.str;
        enemy.hp -= dmg;
        addLog(`–í—ã —É–¥–∞—Ä–∏–ª–∏ ‚Üí ${dmg}`);

        if (enemy.hp <= 0) {
            addLog(`–ü–æ–±–µ–¥–∞! +${enemy.exp} exp, +${enemy.gold} gold`);
            userData.exp   += enemy.exp;
            userData.gold  += enemy.gold;
            enemy = null;
            checkLevelUp();
            setTab('fight');
        } else {
            let edmg = Math.max(1, enemy.dmg - Math.floor(userData.vit / 2));
            userData.current_hp -= edmg;
            addLog(`${enemy.n} ‚Üí ${edmg}`);

            if (userData.current_hp <= 0) {
                userData.current_hp = 10;
                userData.location = '–õ–∞–≥–µ—Ä—å';
                enemy = null;
                addLog("–í—ã –æ—á–Ω—É–ª–∏—Å—å –≤ –õ–∞–≥–µ—Ä–µ...");
                setTab('world');
            }
        }

        updateUI();
        if (enemy) renderFight();
    }

    function checkLevelUp() {
        while (userData.level < EXP_TABLE.length - 1 && userData.exp >= EXP_TABLE[userData.level + 1]) {
            userData.level++;
            userData.str += 2;
            userData.vit += 2;
            addLog(`‚ú® –£—Ä–æ–≤–µ–Ω—å ${userData.level}! +2 STR, +2 VIT`);
        }
    }

    function renderHero() {
        const c = document.getElementById('tab-content');
        let tbl = `<table><tr><th>–£—Ä.</th><th>–î–æ —Å–ª–µ–¥.</th></tr>`;
        for (let i = 1; i < EXP_TABLE.length; i++) {
            const style = userData.level === i ? 'style="color:var(--gold);font-weight:bold"' : '';
            tbl += `<tr ${style}><td>${i}</td><td>${EXP_TABLE[i]}</td></tr>`;
        }
        tbl += `</table>`;

        c.innerHTML = `
            <h4>–ì–µ—Ä–æ–π: ${userData.username}</h4>
            <div style="font-size:12px">
                –°–∏–ª–∞ ${userData.str} ‚Ä¢ –ñ–∏–≤—É—á–µ—Å—Ç—å ${userData.vit}<br>
                –ü—Ä–µ–¥–º–µ—Ç–æ–≤: ${userData.inventory?.length || 0}
            </div>
            ${tbl}`;
    }

    function travel(loc) {
        userData.location = loc;
        enemy = null;
        addLog(`‚Üí ${loc}`);
        setTab('world');
        updateUI();
    }

    function buyPot() {
        if (userData.gold >= 50) {
            userData.gold -= 50;
            userData.current_hp = 100 + userData.vit * 10;
            addLog("–ó–µ–ª—å–µ –≤—ã–ø–∏—Ç–æ ‚Äî HP –ø–æ–ª–Ω–æ—Å—Ç—å—é!");
            updateUI();
        } else {
            addLog("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞");
        }
    }

    function tick() {
        if (!userData) return;
        const maxHp = 100 + userData.vit * 10;
        const maxSt = 100 + userData.str * 5;

        if (userData.current_hp < maxHp) userData.current_hp = Math.min(maxHp, userData.current_hp + 2);
        if (userData.stamina   < maxSt) userData.stamina   = Math.min(maxSt, userData.stamina   + 3);

        updateUI();
    }

    function addLog(m) {
        const l = document.getElementById('log');
        l.innerHTML = `<div>[${new Date().toLocaleTimeString('ru')}] ${m}</div>` + l.innerHTML;
        l.scrollTop = 0;
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    sb.auth.onAuthStateChange(async (event, session) => {
        if (session) {
            await loadPlayerData();
        } else {
            document.getElementById('auth-ui').style.display = 'block';
            document.getElementById('game-ui').style.display = 'none';
        }
    });

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    (async () => {
        const { data: { session } } = await sb.auth.getSession();
        if (session) await loadPlayerData();
    })();
</script>
</body>
</html>
