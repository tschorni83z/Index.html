<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TSCHORNI GAME ONLINE</title>
    <style>
        :root { --gold: #f1c40f; --bg: #0d0d0d; --panel: #1a1a1a; --blue: #3498db; --red: #e74c3c; --green: #2ecc71; --stamina: #9b59b6; --border: #333; }
        body { background: var(--bg); color: #ddd; font-family: 'Verdana', sans-serif; margin: 0; padding-bottom: 100px; user-select: none; }
        
        .header { background: #000; padding: 10px; border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .game-title { text-align: center; color: var(--gold); font-size: 14px; font-weight: bold; letter-spacing: 1px; margin-bottom: 8px; text-transform: uppercase; }
        
        .bar-bg { height: 12px; background: #222; border-radius: 6px; border: 1px solid #444; overflow: hidden; margin: 4px 0; position: relative; }
        .fill { height: 100%; transition: 0.3s; width: 100%; }
        .bar-txt { position: absolute; width: 100%; text-align: center; font-size: 9px; line-height: 12px; font-weight: bold; color: #fff; z-index: 2; }
        
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 10px; }
        .screen { display: none; } .active { display: block; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        button { padding: 12px; background: #2a2a2a; color: #eee; border: 1px solid #444; border-radius: 5px; font-size: 11px; font-weight: bold; cursor: pointer; }

        #log, #chat-box { height: 100px; overflow-y: auto; background: #000; padding: 8px; font-size: 11px; border: 1px solid var(--border); margin-bottom: 5px; }
        #chat-box { color: #3498db; height: 80px; }
        .chat-input-area { display: flex; gap: 5px; margin-bottom: 10px; }
        .chat-input-area input { flex: 1; background: #111; border: 1px solid #444; color: #fff; padding: 5px; border-radius: 4px; }

        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #000; display: flex; border-top: 2px solid var(--border); height: 60px; z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: #555; cursor: pointer; }
        .nav-item.active { color: var(--gold); background: #111; border-top: 2px solid var(--gold); }

        .item-card { background: #111; border: 1px solid #333; padding: 8px; border-radius: 4px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div class="header">
        <div class="game-title">TSCHORNI GAME ONLINE</div>
        <div style="display:flex; justify-content:space-between; font-size:11px; color:var(--gold); margin-bottom:4px;">
            <b id="ui-nick">---</b>
            <b>üí∞ <span id="gold">0</span></b>
        </div>
        <div class="bar-bg"><div class="bar-txt">‚ù§Ô∏è HP: <span id="hp-val">0/0</span></div><div id="hp-fill" class="fill" style="background:var(--green)"></div></div>
        <div class="bar-bg"><div class="bar-txt">üí™ STAMINA: <span id="st-val">0/0</span></div><div id="st-fill" class="fill" style="background:var(--stamina)"></div></div>
        <div style="text-align:center; font-size:9px;">Level: <span id="ui-lvl">1</span> | Points: <b id="ui-pts" style="color:var(--green)">0</b></div>
    </div>

    <div class="content" style="padding:10px;">
        <div id="chat-box">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞...</div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç...">
            <button onclick="sendChat()" style="padding:5px 10px;">üí¨</button>
        </div>
        <div id="log"></div>

        <div id="scr-town" class="screen">
            <div class="panel">
                <div class="grid">
                    <button onclick="move('shop')">‚öñÔ∏è –ú–∞–≥–∞–∑–∏–Ω</button>
                    <button onclick="move('craft')">‚öíÔ∏è –ö—É–∑–Ω–∏—Ü–∞</button>
                    <button onclick="move('hospital')">üè• –ë–æ–ª—å–Ω–∏—Ü–∞</button>
                    <button onclick="move('world')">üß≠ –í—ã—Ö–æ–¥</button>
                </div>
            </div>
        </div>

        <div id="scr-world" class="screen">
            <h4 style="text-align:center;">üó∫Ô∏è –í—ã–±–æ—Ä –ª–æ–∫–∞—Ü–∏–∏</h4>
            <div id="loc-list" class="grid"></div>
            <button style="width:100%; margin-top:15px; background:var(--red);" onclick="hunt()">‚öîÔ∏è –ò–°–ö–ê–¢–¨ –ú–û–ù–°–¢–†–ê</button>
            <button style="width:100%; margin-top:10px;" onclick="move('town')">üèÉ –í –≥–æ—Ä–æ–¥</button>
        </div>

        <div id="scr-battle" class="screen">
            <div class="panel" style="text-align:center;">
                <h3 id="en-name">–í—Ä–∞–≥</h3>
                <div id="en-img" style="font-size:50px;">üëæ</div>
                <div class="bar-bg"><div id="en-hp-fill" class="fill" style="background:var(--red)"></div></div>
                <div class="grid" style="margin-top:15px;">
                    <button onclick="battleHit()" style="background:var(--red); height:50px;">–£–î–ê–†–ò–¢–¨</button>
                    <button onclick="flee()">–°–ë–ï–ñ–ê–¢–¨</button>
                </div>
            </div>
        </div>

        <div id="scr-char" class="screen">
            <div class="panel">
                <h4 style="color:var(--gold)">üë§ –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h4>
                <div id="stat-list"></div>
                <hr style="border:0; border-top:1px solid #333; margin:10px 0;">
                <h4 style="color:var(--gold)">üéí –†–µ—Å—É—Ä—Å—ã</h4>
                <div id="res-list"></div>
            </div>
        </div>

        <div id="scr-craft" class="screen panel">
            <h4 style="text-align:center;">‚öíÔ∏è –ö—É–∑–Ω–∏—Ü–∞</h4>
            <div id="craft-items"></div>
            <button style="width:100%; margin-top:10px;" onclick="move('town')">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <div class="nav-bar">
        <div id="n-town" class="nav-item" onclick="move('town')">üèôÔ∏è<br>–ì–æ—Ä–æ–¥</div>
        <div id="n-world" class="nav-item" onclick="move('world')">üó∫Ô∏è<br>–ú–∏—Ä</div>
        <div id="n-char" class="nav-item" onclick="move('char')">üë§<br>–ì–µ—Ä–æ–π</div>
    </div>

    <script>
        const SB_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co"; 
        const SB_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";

        let p = JSON.parse(localStorage.getItem('save_tschorni_v2')) || {
            username: "–ò–≥—Ä–æ–∫_" + Math.floor(Math.random()*999), hp:100, st:100, gold:100, exp:0, lvl:1, points:5,
            str:5, agi:5, vit:5, int:5, loc: 'town',
            res: {fang:0, scale:0}, enemy: null
        };

        const worldMap = {
            'forest': { n:'–û–ø—É—à–∫–∞', minLvl:0, mobs:[{n:'–ö—Ä—ã—Å–∞', i:'üêÄ', hp:40, dmg:5, exp:20, g:10, drop:'fang', chance:0.4}] },
            'cave': { n:'–ü–µ—â–µ—Ä–∞', minLvl:3, mobs:[{n:'–û—Ä–∫', i:'üëπ', hp:150, dmg:15, exp:60, g:25, drop:'scale', chance:0.2}] }
        };

        function addLog(m) {
            const l = document.getElementById('log');
            l.innerHTML += `<div><span style="color:#555">[${new Date().toLocaleTimeString()}]</span> ${m}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            if(!input.value) return;
            const msg = `${p.username}: ${input.value}`;
            input.value = '';
            
            try {
                await fetch(`${SB_URL}/rest/v1/messages`, {
                    method: 'POST',
                    headers: { "apikey": SB_KEY, "Authorization": `Bearer ${SB_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ text: msg })
                });
                loadChat();
            } catch(e) { addLog("–û—à–∏–±–∫–∞ —á–∞—Ç–∞"); }
        }

        async function loadChat() {
            try {
                const res = await fetch(`${SB_URL}/rest/v1/messages?order=created_at.desc&limit=5`, {
                    headers: { "apikey": SB_KEY, "Authorization": `Bearer ${SB_KEY}` }
                });
                const data = await res.json();
                document.getElementById('chat-box').innerHTML = data.reverse().map(m => `<div>${m.text}</div>`).join('');
            } catch(e) {}
        }

        function move(scr) {
            if(p.enemy && scr !== 'battle') return addLog("‚öîÔ∏è –í—ã –≤ –±–æ—é!");
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('scr-'+scr).classList.add('active');
            if(document.getElementById('n-'+scr)) document.getElementById('n-'+scr).classList.add('active');
            
            if(scr === 'char') renderChar();
            if(scr === 'world') renderWorld();
            if(scr === 'craft') renderCraft();
            updateUI();
            save();
        }

        function renderWorld() {
            const list = document.getElementById('loc-list');
            list.innerHTML = '';
            for(let id in worldMap) {
                const loc = worldMap[id];
                list.innerHTML += `<button onclick="p.loc='${id}'; addLog('–í—ã –ø–µ—Ä–µ—à–ª–∏: ${loc.n}')" ${p.lvl < loc.minLvl ? 'disabled' : ''}>${loc.n} (Lvl ${loc.minLvl})</button>`;
            }
        }

        function renderChar() {
            const sl = document.getElementById('stat-list');
            sl.innerHTML = `<div>–°–∏–ª–∞: ${p.str} <button onclick="addStat('str')">+</button></div>
                            <div>–õ–æ–≤–∫–æ—Å—Ç—å: ${p.agi} <button onclick="addStat('agi')">+</button></div>
                            <div>–ñ–∏–≤—É—á–µ—Å—Ç—å: ${p.vit} <button onclick="addStat('vit')">+</button></div>`;
            document.getElementById('res-list').innerHTML = `–ö–ª—ã–∫–∏: ${p.res.fang} | –ß–µ—à—É—è: ${p.res.scale}`;
            document.getElementById('ui-pts').innerText = p.points;
        }

        function addStat(s) {
            if(p.points > 0) { p[s]++; p.points--; renderChar(); updateUI(); save(); }
        }

        function hunt() {
            const loc = worldMap[p.loc] || worldMap.forest;
            const m = loc.mobs[0];
            p.enemy = { ...m, curHp: m.hp };
            move('battle');
        }

        function battleHit() {
            if(!p.enemy) return;
            let dmg = (p.st >= 10) ? (p.str + 5) : 2;
            if(p.st >= 10) p.st -= 10;
            p.enemy.curHp -= dmg;
            if(p.enemy.curHp <= 0) {
                addLog(`üèÜ –ü–æ–±–µ–¥–∞! +${p.enemy.g} –∑–æ–ª–æ—Ç–∞.`);
                p.gold += p.enemy.g; p.exp += p.enemy.exp;
                if(Math.random() < p.enemy.chance) p.res[p.enemy.drop]++;
                p.enemy = null; move('world');
            } else {
                p.hp -= p.enemy.dmg;
                if(p.hp <= 0) { p.hp=20; p.enemy=null; move('town'); }
            }
            updateUI(); save();
        }

        function renderCraft() {
            document.getElementById('craft-items').innerHTML = `<div class="item-card">
                <span>üî• –ö–ª–∏–Ω–æ–∫ (10 –∫–ª—ã–∫–æ–≤)</span>
                <button onclick="doCraft('fang', 10)">–°–æ–∑–¥–∞—Ç—å</button>
            </div>`;
        }

        function doCraft(res, amt) {
            if(p.res[res] >= amt) { p.res[res] -= amt; addLog("‚öíÔ∏è –ü—Ä–µ–¥–º–µ—Ç —Å–æ–∑–¥–∞–Ω!"); }
            else { alert("–ú–∞–ª–æ —Ä–µ—Å—É—Ä—Å–æ–≤!"); }
            renderChar(); save();
        }

        function updateUI() {
            let maxHp = 100 + p.vit*20;
            document.getElementById('ui-nick').innerText = p.username;
            document.getElementById('gold').innerText = p.gold;
            document.getElementById('hp-fill').style.width = (p.hp/maxHp*100)+'%';
            document.getElementById('st-fill').style.width = p.st+'%';
            if(p.enemy) document.getElementById('en-hp-fill').style.width = (p.enemy.curHp/p.enemy.hp*100)+'%';
        }

        async function save() { localStorage.setItem('save_tschorni_v2', JSON.stringify(p)); }

        setInterval(loadChat, 3000);
        setInterval(() => { if(!p.enemy) { p.st = Math.min(100, p.st+10); updateUI(); } }, 5000);

        window.onload = () => { if(p.enemy) move('battle'); else move(p.loc || 'town'); loadChat(); };
    </script>
</body>
</html>
