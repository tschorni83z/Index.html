        const world = {
            'town': { n: '–ì–æ—Ä–æ–¥ (–ë–µ–∑–æ–ø–∞—Å–Ω–æ)', paths: ['forest_res', 'mine', 'forest_danger', 'bank'], acts: [{t: '–ö—Ä–∞—Ñ—Ç: –ú–µ—á (10 –¥–µ—Ä–µ–≤–∞/5 –∂–µ–ª)', f: 'craft'}] },
            'bank': { n: '–ë–∞–Ω–∫', paths: ['town'], acts: [{t: '–í–Ω–µ—Å—Ç–∏ –≤—Å—ë', f: 'dep'}, {t: '–ó–∞–±—Ä–∞—Ç—å –≤—Å—ë', f: 'with'}] },
            'forest_res': { n: '–õ–µ—Å —Ä–µ—Å—É—Ä—Å–æ–≤ (–ú–∏—Ä–Ω–æ)', paths: ['town'], acts: [{t: '–†—É–±–∏—Ç—å –¥–µ—Ä–µ–≤–æ', f: 'gather_wood'}] },
            'mine': { n: '–®–∞—Ö—Ç–∞ (–ú–∏—Ä–Ω–æ)', paths: ['town'], acts: [{t: '–î–æ–±—ã–≤–∞—Ç—å –∫–∞–º–µ–Ω—å', f: 'gather_stone'}, {t: '–ò—Å–∫–∞—Ç—å –∂–µ–ª–µ–∑–æ', f: 'gather_iron'}] },
            'forest_danger': { n: '–î–∏–∫–∏–π –õ–µ—Å (–û–ø–∞—Å–Ω–æ)', paths: ['town'], mob: '–û—Ä–∫', hp: 80 }
        };

        let p = JSON.parse(localStorage.getItem('c_save_v4')) || {
            hp: 100, mH: 100, g: 20, b: 0, lvl: 1, loc: 'town',
            wood: 0, stone: 0, iron: 0, dmgBonus: 0
        };
        let enemy = null, sAtk = '', sDef = '';

        function move(k) {
            p.loc = k; const l = world[k];
            document.getElementById('loc-name').innerText = l.n;
            document.getElementById('btn-hunt').style.display = l.mob ? 'block' : 'none';
            
            const nB = document.getElementById('nav-btns'); nB.innerHTML = '';
            l.paths.forEach(pk => {
                let b = document.createElement('button'); b.className = 'btn-move';
                b.innerText = `‚û° ${world[pk].n}`; b.onclick = () => move(pk);
                nB.appendChild(b);
            });

            const aB = document.getElementById('act-btns'); aB.innerHTML = '';
            if(l.acts) l.acts.forEach(a => {
                let b = document.createElement('button'); b.className = 'btn-craft';
                b.innerText = a.t; b.onclick = () => window[a.f]();
                aB.appendChild(b);
            });
            update();
        }

        window.gather_wood = () => { p.wood += 2; addLog("ü™ì –°—Ä—É–±–ª–µ–Ω–æ 2 –¥–µ—Ä–µ–≤–∞."); update(); };
        window.gather_stone = () => { p.stone += 2; addLog("‚õèÔ∏è –î–æ–±—ã—Ç–æ 2 –∫–∞–º–Ω—è."); update(); };
        window.gather_iron = () => { if(Math.random()>0.5){ p.iron += 1; addLog("‚õìÔ∏è –ù–∞–π–¥–µ–Ω–æ –∂–µ–ª–µ–∑–æ!"); } else addLog("...—Ç–æ–ª—å–∫–æ –ø—É—Å—Ç–∞—è –ø–æ—Ä–æ–¥–∞."); update(); };
        
        window.craft = () => {
            if(p.wood >= 10 && p.iron >= 5) {
                p.wood -= 10; p.iron -= 5; p.dmgBonus += 15;
                addLog("‚öîÔ∏è –í—ã —Å–∫–æ–≤–∞–ª–∏ –°—Ç–∞–ª—å–Ω–æ–π –ú–µ—á! –£—Ä–æ–Ω +15");
            } else addLog("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤!");
            update();
        };

        window.dep = () => { p.b += p.g; p.g = 0; addLog("–ó–æ–ª–æ—Ç–æ –≤ —Å–µ–π—Ñ–µ."); update(); };
        window.with = () => { p.g += p.b; p.b = 0; addLog("–ó–∞–±—Ä–∞–ª–∏ –∑–æ–ª–æ—Ç–æ."); update(); };

        function hunt() {
            const l = world[p.loc];
            if(l.mob) startBattle(l.mob, l.hp + (p.lvl*10));
        }

        function startBattle(n, h) {
            enemy = { n, hp: h, max: h, dmg: 10 + p.lvl };
            document.getElementById('scr-world').classList.remove('active');
            document.getElementById('scr-battle').classList.add('active');
            addLog(`üëπ –ù–∞—à–µ–ª—Å—è ${n}! –í –±–æ–π!`);
        }

        function sel(t, i, n) {
            for(let j=1; j<=2; j++) document.getElementById(t+j).classList.remove('selected');
            document.getElementById(t+i).classList.add('selected');
            if(t==='atk') sAtk = n; else sDef = n;
        }

        function doTurn() {
            if(!sAtk || !sDef) { alert("–í—ã–±–µ—Ä–∏ –∑–æ–Ω—ã!"); return; }
            let d = 10 + p.lvl + p.dmgBonus;
            enemy.hp -= d; addLog(`–£–¥–∞—Ä: -${d} HP.`);
            
            if(enemy.hp <= 0) {
                p.g += 30; addLog("–ü–æ–±–µ–¥–∞! +30üí∞");
                document.getElementById('scr-battle').classList.remove('active');
                document.getElementById('scr-world').classList.add('active');
                enemy = null; sAtk = ''; sDef = '';
            } else {
                p.hp -= enemy.dmg; addLog(`–í—Ä–∞–≥ —Ä–∞–Ω–∏–ª –≤–∞—Å –Ω–∞ ${enemy.dmg}`);
            }
            if(p.hp <= 0) { 
                addLog("üíÄ –°–º–µ—Ä—Ç—å! –ó–æ–ª–æ—Ç–æ –ø–æ—Ç–µ—Ä—è–Ω–æ."); 
                p.hp = 100; p.g = 0; move('town'); 
                document.getElementById('scr-battle').classList.remove('active');
                document.getElementById('scr-world').classList.add('active');
            }
            update();
        }

        function addLog(m) {
            const l = document.getElementById('log');
            l.innerHTML += `<div>${m}</div>`; l.scrollTop = l.scrollHeight;
        }

        function update() {
            document.getElementById('gold').innerText = p.g;
            document.getElementById('bank').innerText = p.b;
            document.getElementById('r-wood').innerText = p.wood;
            document.getElementById('r-stone').innerText = p.stone;
            document.getElementById('r-iron').innerText = p.iron;
            document.getElementById('lvl').innerText = p.lvl;
            localStorage.setItem('c_save_v4', JSON.stringify(p));
        }

        move('town');
