<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–ò–† –¢–¨–ú–´</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #ffcc00; --hp: #ff4444; --st: #00ff88; --bg: #0a0a0a; --box: #151515; }
        body { background: var(--bg); color: #eee; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 5px; user-select: none; }
        .box { background: var(--box); padding: 12px; border-radius: 12px; border: 1px solid #333; max-width: 450px; margin: 8px auto; }
        
        /* –°—Ç–∞—Ç—É—Å-–±–∞—Ä */
        .res-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 10px; font-size: 12px; }
        .res-item { background: #000; padding: 5px; border-radius: 6px; border: 1px solid #222; }
        
        .bar-bg { width: 100%; height: 12px; background: #222; border-radius: 6px; margin: 5px 0; overflow: hidden; border: 1px solid #333; position: relative; }
        .bar-fill { height: 100%; transition: 0.4s; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 9px; font-weight: bold; line-height: 12px; color: #fff; }

        /* –ö–Ω–æ–ø–∫–∏ –∏ –¢–∞–±—ã */
        .btn { width: 100%; padding: 14px; background: var(--gold); color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 8px; }
        .btn:disabled { background: #333; color: #666; }
        .tabs { display: flex; gap: 4px; overflow-x: auto; padding: 5px 0; }
        .tab-btn { flex: 1; min-width: 80px; padding: 10px; background: #1a1a1a; border: 1px solid #333; color: #888; border-radius: 8px; font-size: 11px; cursor: pointer; }
        .tab-active { background: var(--gold); color: #000; font-weight: bold; }

        /* –°–ø–∏—Å–∫–∏ */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #222; font-size: 14px; }
        #log { background: #000; border: 1px solid #222; padding: 10px; height: 80px; overflow-y: auto; font-size: 11px; text-align: left; color: #aaa; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>

<div id="game-container">
    <h2 style="color: var(--gold); margin: 10px;">–ú–ò–† –¢–¨–ú–´</h2>
    <div class="box">
        <input type="text" id="u_nick" placeholder="–ù–ò–ö–ù–ï–ô–ú" style="width:85%; padding:12px; margin-bottom:10px; background:#000; border:1px solid #444; color:#fff;">
        <input type="password" id="u_pass" placeholder="–ü–ê–†–û–õ–¨" style="width:85%; padding:12px; background:#000; border:1px solid #444; color:#fff;">
        <button class="btn" onclick="auth('login')">–í–û–ô–¢–ò</button>
        <button class="btn" style="background:none; color:var(--gold); border:1px solid var(--gold);" onclick="auth('reg')">–°–û–ó–î–ê–¢–¨ –ì–ï–†–û–Ø</button>
    </div>
</div>

<script>
    const S_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co";
    const S_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";
    const sb = window.supabase.createClient(S_URL, S_KEY);

    let user, data = {}, isBusy = false, currentTab = 'world', currentLoc = '–õ–∞–≥–µ—Ä—å';

    async function auth(mode) {
        const n = document.getElementById('u_nick').value.trim();
        const p = document.getElementById('u_pass').value.trim();
        if(mode === 'reg') {
            await sb.from('users').insert({ id: crypto.randomUUID(), username: n, email_hidden: p, stamina: 100, gold: 50, inv: { pot_hp: 1 } });
            alert("–ì–µ—Ä–æ–π —Å–æ–∑–¥–∞–Ω!");
        } else {
            const { data: u } = await sb.from('users').select('*').eq('username', n).single();
            if (u && u.email_hidden === p) {
                user = n; data = u; localStorage.setItem('rpg_user', n); localStorage.setItem('rpg_pass', p);
                renderGame(); setInterval(regen, 30000);
            } else alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞!");
        }
    }

    function renderGame() {
        const maxHp = 100 + (data.vit * 10);
        const maxSt = 100 + (data.str * 5);
        document.getElementById('game-container').innerHTML = `
            <div class="box">
                <div class="res-row">
                    <div class="res-item">üí∞ ${data.gold}</div>
                    <div class="res-item">üå≤ ${data.wood || 0}</div>
                    <div class="res-item">ü™® ${data.stone || 0}</div>
                    <div class="res-item">‚õèÔ∏è ${data.iron || 0}</div>
                    <div class="res-item">‚¨õ ${data.coal || 0}</div>
                    <div class="res-item">üî± ${data.steel_ingot || 0}</div>
                </div>
                <div class="bar-bg"><div class="bar-text">HP: ${data.current_hp}/${maxHp}</div><div class="bar-fill" style="width:${(data.current_hp/maxHp)*100}%; background:var(--hp)"></div></div>
                <div class="bar-bg"><div class="bar-text">ST: ${data.stamina}/${maxSt}</div><div class="bar-fill" style="width:${(data.stamina/maxSt)*100}%; background:var(--st)"></div></div>
            </div>

            <div class="tabs">
                <button class="tab-btn ${currentTab==='world'?'tab-active':''}" onclick="setTab('world')">–ú–ò–†</button>
                <button class="tab-btn ${currentTab==='mine'?'tab-active':''}" onclick="setTab('mine')">–î–û–ë–´–ß–ê</button>
                <button class="tab-btn ${currentTab==='shop'?'tab-active':''}" onclick="setTab('shop')">–ú–ê–ì–ê–ó–ò–ù</button>
                <button class="tab-btn ${currentTab==='inv'?'tab-active':''}" onclick="setTab('inv')">–ì–ï–†–û–ô</button>
            </div>
            <div id="tab-content">${renderTab()}</div>
            <div id="log">–¢–µ–∫—É—â–∞—è –ª–æ–∫–∞—Ü–∏—è: ${currentLoc}</div>
        `;
    }

    function renderTab() {
        if(currentTab === 'world') return `
            <div class="box">
                <h3>–õ–û–ö–ê–¶–ò–ò</h3>
                <div class="list-item"><span>üå≤ –î–∏–∫–∏–π –õ–µ—Å</span> <button onclick="travel('–î–∏–∫–∏–π –õ–µ—Å', 5)" class="tab-btn">–ò–î–¢–ò (5—Å)</button></div>
                <div class="list-item"><span>‚õèÔ∏è –ú—Ä–∞—á–Ω–∞—è –®–∞—Ö—Ç–∞</span> <button onclick="travel('–®–∞—Ö—Ç–∞', 10)" class="tab-btn">–ò–î–¢–ò (10—Å)</button></div>
                <div class="list-item"><span>‚öñÔ∏è –†—ã–Ω–æ–∫</span> <button onclick="travel('–†—ã–Ω–æ–∫', 3)" class="tab-btn">–ò–î–¢–ò (3—Å)</button></div>
            </div>`;
        
        if(currentTab === 'mine') {
            if(currentLoc === '–õ–∞–≥–µ—Ä—å' || currentLoc === '–†—ã–Ω–æ–∫') return `<div class="box"><p>–ó–¥–µ—Å—å –Ω–µ—á–µ–≥–æ –¥–æ–±—ã–≤–∞—Ç—å. –ò–¥–∏ –≤ –õ–µ—Å –∏–ª–∏ –®–∞—Ö—Ç—É!</p></div>`;
            return `
            <div class="box">
                <h3>–î–û–ë–´–ß–ê: ${currentLoc}</h3>
                <button class="btn" onclick="mine('wood')" ${isBusy?'disabled':''}>–°–û–ë–ò–†–ê–¢–¨ –†–ï–°–£–†–°–´ (-15 ST)</button>
            </div>`;
        }

        if(currentTab === 'shop') return `
            <div class="box">
                <h3>–ú–ê–ì–ê–ó–ò–ù</h3>
                <div class="list-item"><span>üß™ –ó–µ–ª—å–µ HP (50üí∞)</span> <button onclick="buy('pot_hp', 50)" class="tab-btn">–ö–£–ü–ò–¢–¨</button></div>
                <div class="list-item"><span>‚ö° –≠–ª–∏–∫—Å–∏—Ä ST (40üí∞)</span> <button onclick="buy('pot_st', 40)" class="tab-btn">–ö–£–ü–ò–¢–¨</button></div>
                <hr>
                <h3>–ü–†–û–î–ê–ñ–ê</h3>
                <button class="btn" onclick="sellAll()" style="background:#444; color:#fff;">–ü–†–û–î–ê–¢–¨ –í–°–ï –†–ï–°–£–†–°–´</button>
            </div>`;

        return `<div class="box"><h3>–ò–ù–í–ï–ù–¢–ê–†–¨</h3><p>–ó–µ–ª—å—è HP: ${data.inv?.pot_hp || 0}</p><p>–ó–µ–ª—å—è ST: ${data.inv?.pot_st || 0}</p><button class="btn" onclick="logout()">–í–´–ô–¢–ò</button></div>`;
    }

    async function travel(name, time) {
        if(isBusy) return;
        isBusy = true; renderGame();
        addLog(`–ü–µ—Ä–µ—Ö–æ–¥ –≤ ${name}...`);
        setTimeout(() => {
            currentLoc = name;
            isBusy = false;
            renderGame();
            addLog(`–ü—Ä–∏–±—ã–ª –≤ ${name}`);
        }, time * 1000);
    }

    async function mine(type) {
        if(data.stamina < 15) return alert("–ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏!");
        isBusy = true; renderGame();
        setTimeout(async () => {
            data.stamina -= 15;
            let res = currentLoc === '–î–∏–∫–∏–π –õ–µ—Å' ? 'wood' : 'iron';
            data[res] = (data[res] || 0) + 1;
            await sb.from('users').update(data).eq('username', user);
            isBusy = false; renderGame();
            addLog(`–î–æ–±—ã—Ç–æ: ${res}`);
        }, 2000);
    }

    async function sellAll() {
        let gain = (data.wood || 0) * 2 + (data.iron || 0) * 5;
        if(gain === 0) return alert("–ù–µ—á–µ–≥–æ –ø—Ä–æ–¥–∞–≤–∞—Ç—å!");
        data.gold += gain;
        data.wood = 0; data.iron = 0;
        await sb.from('users').update(data).eq('username', user);
        renderGame();
        addLog(`–ü—Ä–æ–¥–∞–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –Ω–∞ ${gain}üí∞`);
    }

    async function buy(item, price) {
        if(data.gold < price) return alert("–ù–µ—Ç –∑–æ–ª–æ—Ç–∞!");
        data.gold -= price;
        data.inv[item] = (data.inv[item] || 0) + 1;
        await sb.from('users').update({ gold: data.gold, inv: data.inv }).eq('username', user);
        renderGame();
    }

    function addLog(m) { const l = document.getElementById('log'); if(l) l.innerHTML = `> ${m}<br>` + l.innerHTML; }
    function setTab(t) { currentTab = t; renderGame(); }
    function logout() { localStorage.clear(); location.reload(); }

    async function regen() {
        if(data.stamina < 100) data.stamina += 5;
        if(user) { renderGame(); await sb.from('users').update({ stamina: data.stamina }).eq('username', user); }
    }

    window.onload = async () => {
        const n = localStorage.getItem('rpg_user'), p = localStorage.getItem('rpg_pass');
        if(n && p) {
            const { data: u } = await sb.from('users').select('*').eq('username', n).single();
            if(u && u.email_hidden === p) { user = n; data = u; renderGame(); setInterval(regen, 30000); }
        }
    };
</script>
</body>
</html>
