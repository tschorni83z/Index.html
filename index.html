<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carnage: Mobile Legacy</title>
    <style>
        :root { --gold: #f1c40f; --bg: #111; --panel: #222; --blue: #3498db; --red: #e74c3c; --green: #2ecc71; --border: #444; }
        body { background: var(--bg); color: #ddd; font-family: 'Verdana', sans-serif; margin: 0; padding-bottom: 80px; user-select: none; }
        .header { background: #000; padding: 10px; border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 10; }
        .bar-bg { height: 14px; background: #333; border-radius: 7px; border: 1px solid #555; overflow: hidden; margin: 4px 0; position: relative; }
        .fill { height: 100%; transition: 0.4s; width: 100%; }
        .bar-txt { position: absolute; width: 100%; text-align: center; font-size: 10px; line-height: 14px; font-weight: bold; color: #fff; z-index: 2; }
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .screen { display: none; } .active { display: block; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        button { padding: 12px; background: #3c3c3c; color: #eee; border: 1px solid #555; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #000; display: flex; border-top: 2px solid var(--border); z-index: 20; }
        .nav-item { flex: 1; padding: 15px 5px; text-align: center; font-size: 10px; color: #888; }
        .nav-item.active { color: var(--gold); background: #1a1a1a; }
        #log { height: 100px; overflow-y: auto; background: #000; padding: 8px; font-size: 11px; color: #aaa; margin-bottom: 10px; border: 1px solid var(--border); }
        .item-card { background: #1a1a1a; border: 1px solid #444; padding: 10px; border-radius: 5px; text-align: center; margin-bottom: 8px; }
        .slot { background: #111; border: 1px dashed #555; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 24px; border-radius: 6px; }
    </style>
</head>
<body>

    <div class="header">
        <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--gold); margin-bottom:5px;">
            <b id="ui-nick">–ó–∞–≥—Ä—É–∑–∫–∞...</b>
            <b>üí∞ <span id="gold">0</span></b>
        </div>
        <div class="bar-bg"><div class="bar-txt">‚ù§Ô∏è HP: <span id="hp-val">0/0</span></div><div id="hp-fill" class="fill" style="background:var(--green)"></div></div>
        <div class="bar-bg"><div class="bar-txt">üåü EXP: <span id="exp-val">0/0</span></div><div id="exp-fill" class="fill" style="background:var(--blue)"></div></div>
    </div>

    <div class="content" style="padding:10px;">
        <div id="log"></div>

        <div id="scr-town" class="screen">
            <h3 style="text-align:center; color:var(--gold)">üèôÔ∏è –ü–ª–æ—â–∞–¥—å –ì–æ—Ä–æ–¥–∞</h3>
            <div class="grid">
                <button onclick="openBuild('shop')">üõí –ú–ê–ì–ê–ó–ò–ù</button>
                <button onclick="openBuild('hospital')">üè• –ë–û–õ–¨–ù–ò–¶–ê</button>
                <button onclick="move('forest_1')">üå≤ –í –õ–ï–°</button>
                <button onclick="openBuild('bank')">üèõÔ∏è –ë–ê–ù–ö</button>
            </div>
        </div>

        <div id="scr-shop" class="screen">
            <h3 style="color:var(--gold); text-align:center;">üõí –õ–∞–≤–∫–∞ –ö—É–ø—Ü–∞</h3>
            <div id="shop-list"></div>
            <button style="width:100%; margin-top:10px;" onclick="move('town')">‚ùå –í—ã–π—Ç–∏</button>
        </div>

        <div id="scr-char" class="screen">
            <div class="panel">
                <h4 style="margin:0 0 10px 0; color:var(--gold);">üë§ –°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</h4>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;">
                    <div class="slot" id="slot-neck" title="–®–µ—è">‚ûñ</div>
                    <div class="slot" id="slot-head" title="–ì–æ–ª–æ–≤–∞">‚ûñ</div>
                    <div class="slot" id="slot-weapon" title="–û—Ä—É–∂–∏–µ">‚ûñ</div>
                </div>
            </div>
            <div class="panel">
                <h4 style="margin:0 0 10px 0; color:var(--blue);">üéí –†—é–∫–∑–∞–∫ (–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å)</h4>
                <div id="inventory-list" class="grid"></div>
            </div>
        </div>

        <div id="scr-hospital" class="screen panel">
            <h3 style="color:var(--red); text-align:center;">üè• –ë–æ–ª—å–Ω–∏—Ü–∞</h3>
            <p style="text-align:center;">–î–æ–∫—Ç–æ—Ä –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç —Å–∏–ª—ã –∑–∞ 10 –∑–æ–ª–æ—Ç—ã—Ö.</p>
            <button style="width:100%" onclick="healPlayer()">–õ–µ—á–∏—Ç—å—Å—è (10üí∞)</button>
            <button style="width:100%; margin-top:10px;" onclick="move('town')">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" id="nav-town" onclick="move('town')">üèôÔ∏è<br>–ì–æ—Ä–æ–¥</div>
        <div class="nav-item" id="nav-wild" onclick="move('forest_1')">üå≤<br>–õ–µ—Å</div>
        <div class="nav-item" id="nav-char" onclick="openChar()">üë§<br>–ì–µ—Ä–æ–π</div>
    </div>

    <script>
        const SB_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co"; 
        const SB_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –ø–∞–º—è—Ç–∏ –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç)
        let p = JSON.parse(localStorage.getItem('last_user_save')) || { 
            username: "–ì–µ—Ä–æ–π", hp: 100, gold: 100, exp: 0, lvl: 1, 
            str: 5, agi: 5, vit: 5, int: 5, 
            loc: 'town',
            equip: { weapon: null, head: null, neck: null },
            inventory: [] 
        };

        const gTime = () => new Intl.DateTimeFormat('ru-RU', {timeZone:'Europe/Berlin', hour:'2-digit', minute:'2-digit', second:'2-digit'}).format(new Date());

        const itemsDB = {
            'sw1': { id: 'sw1', name: '–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π –Ω–æ–∂', type: 'weapon', cost: 30, stat: 'str', val: 2, icon: 'üî™' },
            'sw2': { id: 'sw2', name: '–ú–µ—á –û–ø–æ–ª—á–µ–Ω—Ü–∞', type: 'weapon', cost: 150, stat: 'str', val: 8, icon: '‚öîÔ∏è' },
            'hm1': { id: 'hm1', name: '–ö–æ–∂–∞–Ω–∞—è —à–∞–ø–∫–∞', type: 'head', cost: 40, stat: 'vit', val: 3, icon: 'ü™ñ' },
            'nk1': { id: 'nk1', name: '–ó—É–± –≤–æ–ª–∫–∞', type: 'neck', cost: 80, stat: 'agi', val: 4, icon: 'üìø' }
        };

        // --- –§–£–ù–ö–¶–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø (–¢–£–î–ê, –ö–£–î–ê –¢–´ –°–ü–†–ê–®–ò–í–ê–õ) ---
        async function save() {
            localStorage.setItem('last_user_save', JSON.stringify(p));
            try {
                await fetch(`${SB_URL}/rest/v1/users?username=eq.${p.username}`, {
                    method: 'PATCH',
                    headers: { "apikey": SB_KEY, "Authorization": `Bearer ${SB_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ save_data: p, last_seen: new Date().toISOString() })
                });
                console.log("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ Supabase");
            } catch(e) { console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", e); }
        }

        function addLog(m) {
            const l = document.getElementById('log');
            l.innerHTML += `<div><span style="color:#555">[${gTime()}]</span> ${m}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        function move(loc) {
            p.loc = loc;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('scr-' + (loc === 'forest_1' ? 'town' : loc)).classList.add('active');
            document.getElementById('nav-' + (loc === 'town' ? 'town' : 'wild')).classList.add('active');
            if(loc === 'forest_1') addLog("–í—ã –≤–æ—à–ª–∏ –≤ –õ–µ—Å.");
            updateUI(); save();
        }

        function openBuild(type) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('scr-' + type).classList.add('active');
            if(type === 'shop') renderShop();
        }

        function renderShop() {
            const list = document.getElementById('shop-list');
            list.innerHTML = '';
            Object.values(itemsDB).forEach(it => {
                list.innerHTML += `
                <div class="item-card">
                    <b>${it.icon} ${it.name}</b><br>
                    <small>+${it.val} –∫ ${it.stat}</small><br>
                    <button onclick="buy('${it.id}')" style="margin-top:5px;">–ö—É–ø–∏—Ç—å ${it.cost}üí∞</button>
                </div>`;
            });
        }

        function buy(id) {
            const it = itemsDB[id];
            if(p.gold >= it.cost) {
                p.gold -= it.cost;
                p.inventory.push(id);
                addLog(`–ö—É–ø–ª–µ–Ω–æ: ${it.name}`);
                save(); updateUI();
            } else { alert("–ù–µ—Ç –¥–µ–Ω–µ–≥!"); }
        }

        function openChar() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('scr-char').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('nav-char').classList.add('active');
            
            const inv = document.getElementById('inventory-list');
            inv.innerHTML = '';
            p.inventory.forEach((id, idx) => {
                const it = itemsDB[id];
                inv.innerHTML += `
                <div class="item-card" onclick="equip('${id}', ${idx})">
                    ${it.icon}<br><small>–ù–∞–¥–µ—Ç—å</small>
                </div>`;
            });
            updateUI();
        }

        function equip(id, idx) {
            const it = itemsDB[id];
            p.equip[it.type] = id;
            addLog(`–í—ã –Ω–∞–¥–µ–ª–∏ ${it.name}`);
            save(); openChar();
        }

        function healPlayer() {
            if(p.gold >= 10) {
                p.gold -= 10;
                p.hp = 100 + (p.vit * 20);
                addLog("–í—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å—Ü–µ–ª–µ–Ω—ã!");
                updateUI(); save();
            }
        }

        function updateUI() {
            let bonusVit = 0;
            Object.values(p.equip).forEach(id => {
                if(id && itemsDB[id]) {
                    document.getElementById(`slot-${itemsDB[id].type}`).innerText = itemsDB[id].icon;
                    if(itemsDB[id].stat === 'vit') bonusVit += itemsDB[id].val;
                }
            });

            let maxHp = 100 + ((p.vit + bonusVit) * 20);
            document.getElementById('ui-nick').innerText = p.username;
            document.getElementById('gold').innerText = p.gold;
            document.getElementById('hp-val').innerText = `${Math.ceil(p.hp)}/${maxHp}`;
            document.getElementById('hp-fill').style.width = (p.hp / maxHp * 100) + "%";
        }

        // –ê–≤—Ç–æ-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É
        setInterval(save, 60000);
        
        move('town');
    </script>
</body>
</html>
