<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–ò–† –¢–¨–ú–´: EVOLUTION</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #ffcc00; --hp: #ff4444; --st: #00ff88; --bg: #0a0a0a; --box: #151515; --border: #333; }
        body { background: var(--bg); color: #eee; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 5px; user-select: none; }
        .box { background: var(--box); padding: 12px; border-radius: 12px; border: 1px solid var(--border); max-width: 450px; margin: 8px auto; }
        
        /* –°—Ç–∞—Ç—É—Å—ã */
        .res-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 10px; font-size: 11px; }
        .res-item { background: #000; padding: 6px; border-radius: 6px; border: 1px solid #222; text-align: center; color: var(--gold); }
        
        .bar-bg { width: 100%; height: 18px; background: #222; border-radius: 9px; margin: 6px 0; overflow: hidden; border: 1px solid #333; position: relative; }
        .bar-fill { height: 100%; transition: width 0.4s ease; width: 0%; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 10px; font-weight: bold; line-height: 18px; color: #fff; z-index: 2; }

        /* –î–µ–π—Å—Ç–≤–∏–µ (–ü—Ä–æ—Ü–µ–Ω—Ç—ã) */
        #action-box { display: none; margin: 15px 0; }
        .proc-bg { width: 100%; height: 24px; background: #000; border: 1px solid var(--gold); border-radius: 12px; overflow: hidden; position: relative; }
        .proc-fill { height: 100%; background: var(--gold); width: 0%; transition: width 0.1s linear; }
        .proc-text { position: absolute; width: 100%; text-align: center; line-height: 24px; font-size: 13px; color: #000; font-weight: bold; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .btn { width: 100%; padding: 15px; background: var(--gold); color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 8px; font-size: 14px; }
        .btn:disabled { background: #333; color: #666; cursor: not-allowed; }
        
        .tabs { display: flex; gap: 4px; margin: 10px 0; overflow-x: auto; }
        .tab-btn { flex: 1; min-width: 80px; padding: 12px 5px; background: #1a1a1a; border: 1px solid #333; color: #888; border-radius: 8px; font-size: 11px; }
        .tab-active { background: var(--gold); color: #000; font-weight: bold; }

        #log { background: #000; border: 1px solid #222; padding: 10px; height: 100px; overflow-y: auto; font-size: 12px; color: #aaa; border-radius: 8px; text-align: left; line-height: 1.4; }
        .stat-row { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #222; }
    </style>
</head>
<body>

<div id="game-container">
    <h1 style="color: var(--gold); text-align: center;">–ú–ò–† –¢–¨–ú–´</h1>
    <div class="box">
        <input type="text" id="u_nick" placeholder="–ù–ò–ö–ù–ï–ô–ú" style="width:88%; padding:12px; margin-bottom:10px; background:#000; border:1px solid #444; color:#fff; border-radius:8px;">
        <input type="password" id="u_pass" placeholder="–ü–ê–†–û–õ–¨" style="width:88%; padding:12px; margin-bottom:10px; background:#000; border:1px solid #444; color:#fff; border-radius:8px;">
        <button class="btn" onclick="auth('login')">–í–û–ô–¢–ò –í –ú–ò–†</button>
        <button class="btn" style="background:none; color:var(--gold); border:1px solid var(--gold);" onclick="auth('reg')">–°–û–ó–î–ê–¢–¨ –ì–ï–†–û–Ø</button>
    </div>
</div>

<script>
    const S_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co";
    const S_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";
    const sb = window.supabase.createClient(S_URL, S_KEY);

    let user, data = {}, isBusy = false, currentTab = 'world', currentLoc = '–õ–∞–≥–µ—Ä—å';

    async function auth(mode) {
        const n = document.getElementById('u_nick').value.trim();
        const p = document.getElementById('u_pass').value.trim();
        if(!n || !p) return alert("–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å!");

        if(mode === 'reg') {
            const { error } = await sb.from('users').insert({ 
                username: n, email_hidden: p, 
                current_hp: 100, stamina: 100, gold: 100, 
                char_exp: 0, str: 5, vit: 5, int: 5, agi: 5,
                last_seen: new Date().toISOString() 
            });
            if(!error) alert("–ì–µ—Ä–æ–π —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!");
            else alert("–ò–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ —Ç–µ–Ω—å—é...");
        } else {
            const { data: u } = await sb.from('users').select('*').eq('username', n).single();
            if (u && u.email_hidden === p) {
                user = n; data = u;
                localStorage.setItem('rpg_user', n);
                localStorage.setItem('rpg_pass', p);
                processOfflineRegen();
                renderGame();
                setInterval(autoSave, 15000);
                setInterval(regenTick, 2000);
            } else alert("–¢–µ–Ω—å –Ω–µ –ø—Ä–∏–∑–Ω–∞–ª–∞ —Ç–µ–±—è.");
        }
    }

    function processOfflineRegen() {
        const now = new Date();
        const last = new Date(data.last_seen || now);
        const diffSec = Math.floor((now - last) / 1000);
        const regenAmt = Math.floor(diffSec / 15); // 1 –µ–¥ –≤ 15 —Å–µ–∫
        
        const maxHp = 100 + (data.vit * 10);
        const maxSt = 100 + (data.str * 5);

        data.current_hp = Math.min(maxHp, (data.current_hp || 0) + regenAmt);
        data.stamina = Math.min(maxSt, (data.stamina || 0) + regenAmt);
        if(diffSec > 60) addLog(`–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ: ${Math.floor(diffSec/60)} –º–∏–Ω. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ${regenAmt} –µ–¥.`);
    }

    function renderGame() {
        const maxHp = 100 + (data.vit * 10);
        const maxSt = 100 + (data.str * 5);
        
        document.getElementById('game-container').innerHTML = `
            <div class="box">
                <div class="res-grid">
                    <div class="res-item">üí∞ ${Math.floor(data.gold)}</div>
                    <div class="res-item">üå≤ ${data.wood || 0}</div>
                    <div class="res-item">‚õèÔ∏è ${data.iron || 0}</div>
                </div>
                <div class="bar-bg">
                    <div class="bar-text">‚ù§Ô∏è –ó–î–û–†–û–í–¨–ï: ${Math.floor(data.current_hp)} / ${maxHp}</div>
                    <div class="bar-fill" style="width:${(data.current_hp/maxHp)*100}%; background:var(--hp)"></div>
                </div>
                <div class="bar-bg">
                    <div class="bar-text">üîã –í–´–ù–û–°–õ–ò–í–û–°–¢–¨: ${Math.floor(data.stamina)} / ${maxSt}</div>
                    <div class="bar-fill" style="width:${(data.stamina/maxSt)*100}%; background:var(--st)"></div>
                </div>
                <div id="action-box">
                    <div class="proc-bg">
                        <div id="proc-fill" class="proc-fill"></div>
                        <div id="proc-text" class="proc-text">0%</div>
                    </div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn ${currentTab==='world'?'tab-active':''}" onclick="setTab('world')">–ú–ò–†</button>
                <button class="tab-btn ${currentTab==='mine'?'tab-active':''}" onclick="setTab('mine')">–î–û–ë–´–ß–ê</button>
                <button class="tab-btn ${currentTab==='shop'?'tab-active':''}" onclick="setTab('shop')">–ú–ê–ì–ê–ó–ò–ù</button>
                <button class="tab-btn ${currentTab==='hero'?'tab-active':''}" onclick="setTab('hero')">–ì–ï–†–û–ô</button>
            </div>

            <div id="tab-content">${renderTab()}</div>
            <div id="log">–õ–æ–∫–∞—Ü–∏—è: ${currentLoc}</div>
        `;
    }

    function renderTab() {
        if(currentTab === 'world') return `
            <div class="box">
                <button class="btn" onclick="startAction('travel', '–õ–µ—Å', 6000)" ${isBusy?'disabled':''}>üå≤ –í –õ–ï–° (6 —Å–µ–∫)</button>
                <button class="btn" onclick="startAction('travel', '–®–∞—Ö—Ç–∞', 10000)" ${isBusy?'disabled':''}>‚õèÔ∏è –í –®–ê–•–¢–£ (10 —Å–µ–∫)</button>
                <button class="btn" style="background:#333; color:#fff;" onclick="startAction('travel', '–õ–∞–≥–µ—Ä—å', 4000)" ${isBusy?'disabled':''}>üõñ –í –õ–ê–ì–ï–†–¨</button>
            </div>`;
        
        if(currentTab === 'mine') {
            if(currentLoc === '–õ–∞–≥–µ—Ä—å') return `<div class="box"><p>–í –ª–∞–≥–µ—Ä–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –Ω–µ—Ç. –ò–¥–∏ –≤ –ª–µ—Å –∏–ª–∏ —à–∞—Ö—Ç—É.</p></div>`;
            let rName = currentLoc === '–õ–µ—Å' ? '–î–µ—Ä–µ–≤–æ' : '–ñ–µ–ª–µ–∑–æ';
            return `<div class="box"><h3>${currentLoc}</h3><button class="btn" onclick="startAction('mine', '${rName}', 5000)" ${isBusy?'disabled':''}>–î–û–ë–´–í–ê–¢–¨ ${rName.toUpperCase()} (-20 ST)</button></div>`;
        }

        if(currentTab === 'shop') return `
            <div class="box">
                <div class="stat-row"><span>üß™ –ó–µ–ª—å–µ HP</span><button onclick="buy('hp')" class="tab-btn">50üí∞</button></div>
                <div class="stat-row"><span>–ü—Ä–æ–¥–∞—Ç—å –≤—Å—ë –¥–µ—Ä–µ–≤–æ</span><button onclick="sell('wood', 5)" class="tab-btn">5üí∞/–µ–¥</button></div>
                <div class="stat-row"><span>–ü—Ä–æ–¥–∞—Ç—å –≤—Å—ë –∂–µ–ª–µ–∑–æ</span><button onclick="sell('iron', 12)" class="tab-btn">12üí∞/–µ–¥</button></div>
            </div>`;

        return `<div class="box"><h3>–ì–ï–†–û–ô</h3><div class="stat-row"><span>–°–∏–ª–∞ (ST):</span> <b>${data.str}</b></div><div class="stat-row"><span>–ñ–∏–≤—É—á–µ—Å—Ç—å (HP):</span> <b>${data.vit}</b></div><button class="btn" onclick="logout()" style="background:red; color:#fff;">–í–´–ô–¢–ò</button></div>`;
    }

    function startAction(type, target, duration) {
        if(isBusy) return;
        if(type === 'mine' && data.stamina < 20) return alert("–í—ã —Å–ª–∏—à–∫–æ–º —É—Å—Ç–∞–ª–∏!");

        isBusy = true; renderGame();
        const actionBox = document.getElementById('action-box');
        const fill = document.getElementById('proc-fill');
        const txt = document.getElementById('proc-text');
        actionBox.style.display = 'block';

        let start = Date.now();
        let eventTriggered = false;

        let interval = setInterval(() => {
            let elapsed = Date.now() - start;
            let percent = Math.min(100, Math.floor((elapsed / duration) * 100));
            fill.style.width = percent + '%';
            txt.innerText = percent + '%';

            if (percent >= 50 && !eventTriggered && Math.random() < 0.2) {
                eventTriggered = true;
                handleRandomEvent(type);
            }

            if(elapsed >= duration) {
                clearInterval(interval);
                finishAction(type, target);
            }
        }, 100);
    }

    function handleRandomEvent(type) {
        const roll = Math.random();
        if(type === 'travel') {
            if(roll < 0.5) {
                const dmg = 10; data.current_hp -= dmg;
                addLog(`‚öîÔ∏è –ó–∞—Å–∞–¥–∞! –ü–æ–ª—É—á–µ–Ω–æ ${dmg} —É—Ä–æ–Ω–∞!`, 'red');
            } else {
                const found = 20; data.gold += found;
                addLog(`üéÅ –ù–∞–π–¥–µ–Ω–æ –Ω–∞ –¥–æ—Ä–æ–≥–µ: +${found}üí∞`, 'green');
            }
        } else {
            data.stamina -= 10;
            addLog("‚õèÔ∏è –¢—è–∂–µ–ª–∞—è —Ä–∞–±–æ—Ç–∞: -10 –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏", 'orange');
        }
        renderGame();
    }

    async function finishAction(type, target) {
        isBusy = false;
        document.getElementById('action-box').style.display = 'none';
        
        if(type === 'travel') {
            currentLoc = target;
            addLog(`üìç –ü—Ä–∏–±—ã–ª –≤: ${target}`);
        } else {
            data.stamina -= 20;
            let key = target === '–î–µ—Ä–µ–≤–æ' ? 'wood' : 'iron';
            data[key] = (data[key] || 0) + 1;
            addLog(`‚úÖ –î–æ–±—ã—Ç–æ: ${target} +1`);
        }
        renderGame();
        autoSave();
    }

    async function buy(type) {
        if(data.gold < 50) return alert("–ù–µ—Ç –∑–æ–ª–æ—Ç–∞!");
        data.gold -= 50;
        data.current_hp = Math.min(100 + (data.vit * 10), data.current_hp + 30);
        addLog("üß™ –í—ã–ø–∏—Ç–æ –∑–µ–ª—å–µ: +30 HP");
        renderGame();
    }

    async function sell(res, price) {
        const amt = data[res] || 0;
        if(amt <= 0) return alert("–ù–µ—á–µ–≥–æ –ø—Ä–æ–¥–∞–≤–∞—Ç—å!");
        data.gold += amt * price;
        data[res] = 0;
        addLog(`üí∞ –ü—Ä–æ–¥–∞–Ω–æ –Ω–∞ ${amt * price} –∑–æ–ª–æ—Ç–∞`);
        renderGame();
    }

    function regenTick() {
        if(isBusy) return;
        const maxHp = 100 + (data.vit * 10);
        const maxSt = 100 + (data.str * 5);
        if(data.current_hp < maxHp) data.current_hp = Math.min(maxHp, data.current_hp + 0.3);
        if(data.stamina < maxSt) data.stamina = Math.min(maxSt, data.stamina + 0.8);
        renderGame();
    }

    async function autoSave() {
        if(!user) return;
        data.last_seen = new Date().toISOString();
        await sb.from('users').update(data).eq('username', user);
    }

    function addLog(m, c) { 
        const l = document.getElementById('log'); 
        if(l) l.innerHTML = `<span style="color:${c || 'inherit'}">> ${m}</span><br>` + l.innerHTML; 
    }
    
    function setTab(t) { if(!isBusy) { currentTab = t; renderGame(); } }
    function logout() { localStorage.clear(); location.reload(); }

    window.onload = async () => {
        const n = localStorage.getItem('rpg_user'), p = localStorage.getItem('rpg_pass');
        if(n && p) {
            const { data: u } = await sb.from('users').select('*').eq('username', n).single();
            if(u && u.email_hidden === p) { 
                user = n; data = u; 
                processOfflineRegen();
                renderGame();
                setInterval(autoSave, 15000);
                setInterval(regenTick, 2000);
            }
        }
    };
</script>
</body>
</html>
