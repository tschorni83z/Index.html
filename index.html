<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–ò–† –¢–¨–ú–´: RPG</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #0a0a0a; color: #fff; font-family: sans-serif; text-align: center; margin: 0; padding: 5px; }
        .box { background: #151515; padding: 15px; border-radius: 12px; border: 1px solid #333; max-width: 420px; margin: 8px auto; }
        .btn { width: 100%; padding: 15px; background: #ffcc00; color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn:disabled { background: #222; color: #555; }
        .tabs { display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto; padding: 5px 0; }
        .tab-btn { flex: 1; padding: 10px; background: #222; color: #888; border: 1px solid #444; border-radius: 8px; font-size: 11px; min-width: 80px; }
        .tab-active { background: #ffcc00; color: #000; font-weight: bold; }
        .hp-bar { width: 100%; height: 8px; background: #300; border-radius: 4px; margin: 5px 0; overflow: hidden; }
        .hp-fill { height: 100%; background: #ff4444; transition: 0.4s; }
        #log { background: #000; border: 1px solid #222; padding: 10px; height: 100px; overflow-y: auto; font-size: 12px; text-align: left; color: #aaa; border-radius: 8px; }
        .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #222; }
        .plus-btn { background: #ffcc00; color: #000; border: none; width: 30px; height: 30px; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>

<div id="game-container">
    <h1>–ú–ò–† –¢–¨–ú–´</h1>
    <div class="box">
        <input type="text" id="u_nick" placeholder="–ù–ò–ö–ù–ï–ô–ú" style="width:80%; padding:10px; margin-bottom:5px; background:#000; color:#fff; border:1px solid #333;">
        <input type="password" id="u_pass" placeholder="–ü–ê–†–û–õ–¨" style="width:80%; padding:10px; background:#000; color:#fff; border:1px solid #333;">
        <button class="btn" onclick="auth('login')">–ò–ì–†–ê–¢–¨</button>
        <button class="btn" style="background:none; color:#ffcc00; border:1px solid #ffcc00; margin-top:10px;" onclick="auth('reg')">–°–û–ó–î–ê–¢–¨ –ì–ï–†–û–Ø</button>
    </div>
</div>

<script>
    const S_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co";
    const S_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";
    const sb = window.supabase.createClient(S_URL, S_KEY);

    let user, data = {}, isBusy = false, currentTab = 'explore';

    // –¢–∞–±–ª–∏—Ü–∞ –æ–ø—ã—Ç–∞ –ø–æ —Ç–≤–æ–µ–º—É –∑–∞–ø—Ä–æ—Å—É
    const expTable = [0, 150, 500, 1200, 2500, 4500, 7000, 10000, 15000]; 

    function getLevel(exp) {
        let lvl = 1;
        for (let i = 1; i < expTable.length; i++) {
            if (exp >= expTable[i]) lvl = i + 1;
        }
        return lvl;
    }

    async function auth(mode) {
        const n = document.getElementById('u_nick').value.trim();
        const p = document.getElementById('u_pass').value.trim();
        if (mode === 'reg') {
            await sb.from('users').insert({ id: crypto.randomUUID(), username: n, email_hidden: p });
            alert("–°–æ–∑–¥–∞–Ω!");
        } else {
            const { data: u } = await sb.from('users').select('*').eq('username', n).single();
            if (u && u.email_hidden === p) {
                user = n; data = u; renderGame(); setInterval(regen, 30000);
            }
        }
    }

    function renderGame() {
        const lvl = getLevel(data.char_exp);
        const nextExp = expTable[lvl] || 'MAX';
        const maxHp = 100 + (data.vit * 10);
        
        document.getElementById('game-container').innerHTML = `
            <h2>–ú–ò–† –¢–¨–ú–´</h2>
            <div class="box">
                <div style="display:flex; justify-content:space-between; font-size:12px;">
                    <span>üõ°Ô∏è –£—Ä. ${lvl} (${data.char_exp}/${nextExp})</span>
                    <span>‚ù§Ô∏è HP: ${data.current_hp}/${maxHp}</span>
                </div>
                <div class="hp-bar"><div class="hp-fill" style="width:${(data.current_hp/maxHp)*100}%"></div></div>
                <div style="font-size:11px; color:#ffcc00; margin-top:5px;">üí∞:${data.gold} | üå≤:${data.wood||0} | ‚õèÔ∏è:${data.iron||0} | üîó:${data.steel_ingot||0}</div>
            </div>

            <div class="tabs">
                <button class="tab-btn ${currentTab==='explore'?'tab-active':''}" onclick="setTab('explore')">–ú–ò–†</button>
                <button class="tab-btn ${currentTab==='hero'?'tab-active':''}" onclick="setTab('hero')">–ì–ï–†–û–ô ${data.stat_points>0?'üî¥':''}</button>
                <button class="tab-btn ${currentTab==='factory'?'tab-active':''}" onclick="setTab('factory')">–ó–ê–í–û–î</button>
                <button class="tab-btn ${currentTab==='market'?'tab-active':''}" onclick="setTab('market')">–†–´–ù–û–ö</button>
            </div>
            <div id="tab-content">${renderTab()}</div>
            <div id="log">–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞...</div>
        `;
    }

    function renderTab() {
        if (currentTab === 'hero') return renderHero();
        if (currentTab === 'explore') return `<div class="box">
            <select id="z-sel" style="width:100%; background:#222; color:#fff; padding:10px; border-radius:8px; margin-bottom:10px;">
                <option value="forest">üå≤ –õ–µ—Å (0+ –£—Ä)</option>
                <option value="caves">ü™® –ü–µ—â–µ—Ä—ã (2+ –£—Ä)</option>
            </select>
            <button class="btn" onclick="explore()">–ò–°–°–õ–ï–î–û–í–ê–¢–¨ (-10‚ö°)</button>
        </div>`;
        if (currentTab === 'factory') return `<div class="box"><h3>–ó–ê–í–û–î</h3><button class="btn" onclick="smelt()">–ü–ª–∞–≤–∏—Ç—å –°—Ç–∞–ª—å</button></div>`;
        return `<div class="box"><h3>–†–´–ù–û–ö</h3><button class="btn" onclick="sell('wood', 2)">–ü—Ä–æ–¥–∞—Ç—å –¥–µ—Ä–µ–≤–æ</button></div>`;
    }

    function renderHero() {
        return `<div class="box">
            <h3>–•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò</h3>
            <p style="color:#ffcc00;">–°–≤–æ–±–æ–¥–Ω—ã—Ö –æ—á–∫–æ–≤: ${data.stat_points}</p>
            <div class="stat-row"><span>üí™ –°–∏–ª–∞: ${data.str}</span><button class="plus-btn" onclick="upStat('str')" ${data.stat_points<1?'disabled':''}>+</button></div>
            <div class="stat-row"><span>üéØ –õ–æ–≤–∫–æ—Å—Ç—å: ${data.agi}</span><button class="plus-btn" onclick="upStat('agi')" ${data.stat_points<1?'disabled':''}>+</button></div>
            <div class="stat-row"><span>üß† –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç: ${data.int}</span><button class="plus-btn" onclick="upStat('int')" ${data.stat_points<1?'disabled':''}>+</button></div>
            <div class="stat-row"><span>ü©∏ –ñ–∏–≤—É—á–µ—Å—Ç—å: ${data.vit}</span><button class="plus-btn" onclick="upStat('vit')" ${data.stat_points<1?'disabled':''}>+</button></div>
            <button class="btn" onclick="logout()" style="background:#444; color:#fff; margin-top:15px;">–í–´–ô–¢–ò</button>
        </div>`;
    }

    async function addExp(amount) {
        data.char_exp += amount;
        // –ö–∞–∂–¥—ã–µ 50 –æ–ø—ã—Ç–∞ –¥–∞–µ–º 3 —Å—Ç–∞—Ç–∞
        let milestonesReached = Math.floor(data.char_exp / 50);
        let prevMilestones = data.exp_milestone || 0;
        
        if (milestonesReached > prevMilestones) {
            let newPoints = (milestonesReached - prevMilestones) * 3;
            data.stat_points = (data.stat_points || 0) + newPoints;
            data.exp_milestone = milestonesReached;
            addLog(`‚ö° –ü—Ä–æ–≥—Ä–µ—Å—Å! –ü–æ–ª—É—á–µ–Ω–æ ${newPoints} –æ—á–∫–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫!`, 'find');
        }
    }

    async function upStat(s) {
        if (data.stat_points > 0) {
            data.stat_points--;
            data[s]++;
            await sb.from('users').update(data).eq('username', user);
            renderGame();
        }
    }

    async function explore() {
        if (data.energy < 10) return alert("–ú–∞–ª–æ —ç–Ω–µ—Ä–≥–∏–∏!");
        isBusy = true; renderGame();
        
        setTimeout(async () => {
            data.energy -= 10;
            const roll = Math.random();
            // –ë–æ–Ω—É—Å –æ—Ç –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ –∫ –¥–æ–±—ã—á–µ
            const intBonus = Math.floor(data.int / 5);

            if (roll < 0.5) {
                const amt = 1 + intBonus;
                data.wood = (data.wood || 0) + amt;
                addLog(`–ù–∞–π–¥–µ–Ω–æ –¥–µ—Ä–µ–≤–æ: +${amt}`, 'find');
            } else {
                // –ë–æ–π: –°–∏–ª–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —É—Ä–æ–Ω –º–æ–±—É, –õ–æ–≤–∫–æ—Å—Ç—å —É–º–µ–Ω—å—à–∞–µ—Ç —É—Ä–æ–Ω —Ç–µ–±–µ
                const mobDmg = Math.max(1, 15 - Math.floor(data.agi / 2));
                data.current_hp -= mobDmg;
                data.gold += 10 + Math.floor(data.str / 2);
                await addExp(20);
                addLog(`–ë–æ–π! –£—Ä–æ–Ω –ø–æ–ª—É—á–µ–Ω: ${mobDmg}. +20 –æ–ø—ã—Ç–∞.`, 'lose');
            }
            
            await sb.from('users').update(data).eq('username', user);
            isBusy = false; renderGame();
        }, 1500);
    }

    function addLog(m, c) {
        const l = document.getElementById('log');
        const color = c==='find'?'#00ccff':c==='lose'?'#ff4444':'#aaa';
        l.innerHTML = `<div style="color:${color}">> ${m}</div>` + l.innerHTML;
    }

    function setTab(t) { currentTab = t; renderGame(); }
    function logout() { localStorage.clear(); location.reload(); }
    async function regen() {
        const maxHp = 100 + (data.vit * 10);
        if (data.energy < 100) data.energy += 5;
        if (data.current_hp < maxHp) data.current_hp += 3;
        renderGame();
    }
</script>
</body>
</html>
