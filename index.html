<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carnage RPG Online</title>
    <style>
        :root { --gold: #f1c40f; --bg: #121212; --panel: #222; --blue: #3498db; --red: #e74c3c; --green: #2ecc71; --nrg: #9b59b6; }
        body { background: var(--bg); color: #e0e0e0; font-family: sans-serif; margin: 0; padding: 10px; font-size: 14px; user-select: none; }
        .panel { background: var(--panel); padding: 12px; border-radius: 10px; border: 1px solid #333; margin-bottom: 8px; }
        input { width: 100%; padding: 12px; margin: 5px 0; background: #000; color: white; border: 1px solid #444; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; margin-top: 10px; background: var(--blue); border: none; color: white; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .bar { height: 10px; background: #000; border-radius: 5px; border: 1px solid #444; overflow: hidden; margin: 5px 0; }
        .fill { height: 100%; width: 100%; transition: 0.3s; }
        #log { height: 100px; overflow-y: auto; background: #000; padding: 8px; font-size: 12px; border-radius: 5px; color: #bbb; border: 1px solid #333; }
        .screen { display: none; } .active { display: block; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="scr-auth" class="screen active">
        <div class="panel">
            <h2 style="text-align:center; color:var(--gold)">TSCHORNI GAME ONLINE</h2>
            <input type="text" id="user" placeholder="–í–∞—à –ù–∏–∫">
            <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="handleAuth('login')">–í–û–ô–¢–ò</button>
            <button onclick="handleAuth('reg')" style="background:#27ae60">–°–û–ó–î–ê–¢–¨ –ê–ö–ö–ê–£–ù–¢</button>
            <div id="msg" style="text-align:center; margin-top:10px; color:var(--red); font-size:12px;"></div>
        </div>
    </div>

    <div id="scr-game" class="screen">
        <div class="panel">
            <div style="display:flex; justify-content:space-between">
                <b id="ui-nick">–ì–µ—Ä–æ–π</b> <b style="color:var(--gold)">üí∞ <span id="gold">0</span></b>
            </div>
            <div class="bar"><div id="hp-fill" class="fill" style="background:var(--green)"></div></div>
            <div class="bar"><div id="nrg-fill" class="fill" style="background:var(--nrg)"></div></div>
            <div id="work-ui" style="display:none; font-size:10px; color:var(--gold); text-align:center;">‚è≥ –ò–î–ï–¢ –î–û–ë–´–ß–ê...</div>
        </div>
        <div id="log"></div>
        <div id="scr-world" class="active">
            <h3 id="loc-name" style="text-align:center; color:var(--gold)">–ì–æ—Ä–æ–¥</h3>
            <div id="nav-btns" class="grid"></div>
            <div id="act-btns" class="grid"></div>
        </div>
        <button onclick="saveAndExit()" style="background:none; border:none; color:#555; margin-top:20px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤—ã–π—Ç–∏</button>
    </div>

    <script>
        const SB_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co"; 
        const SB_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";

        let p = {}; 
        let isWorking = false;

        async function handleAuth(type) {
            const user = document.getElementById('user').value.trim();
            const pass = document.getElementById('pass').value.trim();
            const msg = document.getElementById('msg');
            if(!user || !pass) return msg.innerText = "–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!";
            
            msg.style.color = "var(--gold)";
            msg.innerText = "–°–≤—è–∑—å —Å –±–∞–∑–æ–π...";

            const headers = { "apikey": SB_KEY, "Authorization": `Bearer ${SB_KEY}`, "Content-Type": "application/json", "Prefer": "return=representation" };

            try {
                if(type === 'reg') {
                    const res = await fetch(`${SB_URL}/rest/v1/users`, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({ 
                            username: user, 
                            password: pass, 
                            save_data: { hp: 100, nrg: 50, gold: 50, wood: 0, iron: 0, loc: 'town' } 
                        })
                    });
                    if(res.ok) { msg.style.color = "#27ae60"; msg.innerText = "–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –ñ–º–∏ '–í–æ–π—Ç–∏'"; }
                    else { const err = await res.json(); msg.innerText = "–û—à–∏–±–∫–∞: " + err.message; }
                } else {
                    const res = await fetch(`${SB_URL}/rest/v1/users?username=eq.${user}`, { headers: headers });
                    const data = await res.json();
                    if(data.length > 0 && data[0].password === pass) {
                        p = { username: user, ...data[0].save_data };
                        startGame();
                    } else msg.innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å";
                }
            } catch(e) { msg.innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏!"; }
        }

        function startGame() {
            document.getElementById('scr-auth').classList.remove('active');
            document.getElementById('scr-game').classList.add('active');
            document.getElementById('ui-nick').innerText = p.username;
            move(p.loc || 'town');
            setInterval(saveToCloud, 30000);
        }

        async function saveToCloud() {
            if(!p.username || isWorking) return;
            fetch(`${SB_URL}/rest/v1/users?username=eq.${p.username}`, {
                method: 'PATCH',
                headers: { "apikey": SB_KEY, "Authorization": `Bearer ${SB_KEY}`, "Content-Type": "application/json" },
                body: JSON.stringify({ save_data: p })
            });
        }

        function move(k) {
            if(isWorking) return;
            p.loc = k;
            const locs = {
                'town': { n: '–ì–æ—Ä–æ–¥', p: ['forest', 'mine'], a: [{t:'üõå –û—Ç–¥—ã—Ö (5üí∞)', f:'rest'}] },
                'forest': { n: '–õ–µ—Å', p: ['town'], a: [{t:'ü™ì –†—É–±–∏—Ç—å (10—Å)', f:'work', res: 'wood'}] },
                'mine': { n: '–®–∞—Ö—Ç–∞', p: ['town'], a: [{t:'‚õèÔ∏è –ö–æ–ø–∞—Ç—å (20—Å)', f:'work', res: 'iron'}] }
            };
            const l = locs[k];
            document.getElementById('loc-name').innerText = l.n;
            
            const nB = document.getElementById('nav-btns'); nB.innerHTML = '';
            l.p.forEach(pk => {
                let b = document.createElement('button'); b.innerText = "‚û° " + pk;
                b.onclick = () => move(pk); nB.appendChild(b);
            });

            const aB = document.getElementById('act-btns'); aB.innerHTML = '';
            l.a.forEach(a => {
                let b = document.createElement('button'); b.innerText = a.t;
                b.onclick = () => window[a.f](a.res); aB.appendChild(b);
            });
            update();
        }

        window.work = (res) => {
            if(p.nrg < 10) return addLog("‚ùå –¢—ã —É—Å—Ç–∞–ª!");
            isWorking = true; p.nrg -= 10;
            document.getElementById('work-ui').style.display = 'block';
            setTimeout(() => {
                isWorking = false; p[res]++;
                document.getElementById('work-ui').style.display = 'none';
                addLog(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ: 1 ${res}`);
                move(p.loc);
            }, res === 'wood' ? 10000 : 20000);
            update();
        };

        window.rest = () => { if(p.gold >= 5) { p.gold -= 5; p.hp = 100; p.nrg = 50; addLog("üõå –°–∏–ª –ø—Ä–∏–±–∞–≤–∏–ª–æ—Å—å!"); } update(); };
        function addLog(m) { const l = document.getElementById('log'); l.innerHTML += `<div>${m}</div>`; l.scrollTop = l.scrollHeight; }
        function update() {
            document.getElementById('gold').innerText = p.gold;
            document.getElementById('hp-fill').style.width = p.hp + "%";
            document.getElementById('nrg-fill').style.width = (p.nrg/50*100) + "%";
        }
        function saveAndExit() { saveToCloud().then(() => location.reload()); }
    </script>
</body>
</html>
