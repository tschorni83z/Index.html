<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TSCHORNI RPG PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #0a0a0a; color: #fff; font-family: sans-serif; text-align: center; padding: 10px; margin: 0; }
        .box { background: #1a1a1a; padding: 15px; border-radius: 12px; border: 1px solid #333; max-width: 400px; margin: 10px auto; }
        .btn { width: 100%; padding: 15px; background: #ffcc00; color: #000; border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .btn:disabled { background: #444; color: #888; }
        .tabs { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .tab-btn { flex: 1; min-width: 80px; padding: 10px 5px; background: #222; border: 1px solid #444; color: #888; border-radius: 8px; font-size: 10px; }
        .tab-active { background: #ffcc00; color: #000; border-color: #ffcc00; font-weight: bold; }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .res-item { background: #000; padding: 8px; border-radius: 8px; border: 1px solid #222; font-size: 13px; }
        .en-bar-bg { width: 100%; background: #333; height: 12px; border-radius: 6px; margin-top: 5px; overflow: hidden; }
        #en-bar-fill { background: #00ccff; height: 100%; transition: 0.3s; }
        .prof-item { text-align: left; margin: 10px 0; font-size: 13px; }
        .prof-bar { width: 100%; background: #222; height: 4px; margin-top: 4px; }
        .prof-fill { background: #ffcc00; height: 100%; }
        #p-cont { width: 100%; background: #222; height: 6px; margin-top: 10px; display: none; }
        #p-bar { width: 0%; height: 100%; background: #ffcc00; }
    </style>
</head>
<body>

<div id="game-container">
    <h1>TSCHORNI</h1>
    <div class="box">
        <input type="text" id="u_nick" placeholder="–ù–ò–ö–ù–ï–ô–ú" style="width:90%; padding:12px; margin-bottom:10px; background:#000; color:#fff; border:1px solid #444;">
        <input type="password" id="u_pass" placeholder="–ü–ê–†–û–õ–¨" style="width:90%; padding:12px; background:#000; color:#fff; border:1px solid #444;">
        <button class="btn" onclick="auth('login')">–í–û–ô–¢–ò</button>
        <button class="btn" style="background:none; color:#ffcc00; border:1px solid #ffcc00;" onclick="auth('reg')">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
    </div>
</div>

<script>
    const S_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co";
    const S_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";
    const sb = window.supabase.createClient(S_URL, S_KEY);

    let user, data = {}, isBusy = false, currentLoc = 'forest', currentTab = 'mine';

    const locations = {
        forest: { name: 'üå≤ –õ–ï–°', res: 'wood', exp: 'exp_wood', time: 5000, energy: 10 },
        quarry: { name: 'ü™® –ö–ê–†–¨–ï–†', res: 'stone', exp: 'exp_stone', time: 8000, energy: 15 },
        mine: { name: '‚õèÔ∏è –®–ê–•–¢–ê', res: 'iron', exp: 'exp_iron', time: 12000, energy: 20 }
    };

    const getLevel = (exp) => Math.floor(Math.sqrt(exp / 10)) + 1;

    async function auth(mode) {
        const nick = document.getElementById('u_nick').value.trim();
        const pass = document.getElementById('u_pass').value.trim();
        if (!nick || !pass) return;
        try {
            if (mode === 'reg') {
                await sb.from('users').insert({ id: crypto.randomUUID(), username: nick, email_hidden: pass });
                alert("–ì–æ—Ç–æ–≤–æ!");
            } else {
                const { data: u } = await sb.from('users').select('*').eq('username', nick).single();
                if (u && u.email_hidden === pass) { user = nick; data = u; renderGame(); setInterval(regen, 30000); }
            }
        } catch (e) { alert("–û—à–∏–±–∫–∞!"); }
    }

    function renderGame() {
        const maxEn = data.max_energy || 100;
        document.getElementById('game-container').innerHTML = `
            <div class="box">
                <div style="font-size:12px; color:#888;">‚ö° –≠–Ω–µ—Ä–≥–∏—è: <span id="en-val">${data.energy}</span>/${maxEn}</div>
                <div class="en-bar-bg"><div id="en-bar-fill" style="width:${(data.energy/maxEn)*100}%"></div></div>
                <div class="res-grid" style="margin-top:10px;">
                    <div class="res-item">üí∞ ${data.gold}</div>
                    <div class="res-item">üå≤ ${data.wood || 0}</div>
                    <div class="res-item">ü™® ${data.stone || 0}</div>
                    <div class="res-item)‚õèÔ∏è ${data.iron || 0}</div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn ${currentTab==='mine'?'tab-active':''}" onclick="setTab('mine')">–î–û–ë–´–ß–ê</button>
                <button class="tab-btn ${currentTab==='char'?'tab-active':''}" onclick="setTab('char')">–ì–ï–†–û–ô</button>
                <button class="tab-btn ${currentTab==='market'?'tab-active':''}" onclick="setTab('market')">–†–´–ù–û–ö</button>
                <button class="tab-btn ${currentTab==='craft'?'tab-active':''}" onclick="setTab('craft')">–ö–†–ê–§–¢</button>
            </div>

            <div id="tab-content">${currentTab==='mine'?renderMine():currentTab==='char'?renderChar():currentTab==='market'?renderMarket():renderCraft()}</div>
        `;
    }

    function renderMine() {
        const loc = locations[currentLoc];
        const lvl = getLevel(data[loc.exp] || 0);
        let time = loc.time - (lvl * 200); // -0.2 —Å–µ–∫ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        if (currentLoc === 'forest' && data.has_axe) time -= 1500;
        if (currentLoc !== 'forest' && data.has_pickaxe) time -= 2000;
        
        return `
            <div class="box">
                <h3>${loc.name} (–£—Ä. ${lvl})</h3>
                <button class="loc-btn ${currentLoc==='forest'?'loc-active':''}" onclick="setLoc('forest')">–õ–ï–°</button>
                <button class="loc-btn ${currentLoc==='quarry'?'loc-active':''}" onclick="setLoc('quarry')">–ö–ê–†–¨–ï–†</button>
                <button class="loc-btn ${currentLoc==='mine'?'loc-active':''}" onclick="setLoc('mine')">–®–ê–•–¢–ê</button>
                <button id="m-btn" class="btn" onclick="mine(${Math.max(1000, time)}, ${loc.energy})">–î–û–ë–´–í–ê–¢–¨</button>
                <div id="p-cont"><div id="p-bar"></div></div>
            </div>
        `;
    }

    function renderChar() {
        const nextEnPrice = (data.max_energy || 100) * 5;
        return `
            <div class="box">
                <div class="prof-item">üå≤ –î—Ä–æ–≤–æ—Å–µ–∫: –£—Ä. ${getLevel(data.exp_wood || 0)}</div>
                <div class="prof-item">ü™® –ì–æ—Ä–Ω—è–∫: –£—Ä. ${getLevel(data.exp_stone || 0)}</div>
                <div class="prof-item)‚õèÔ∏è –®–∞—Ö—Ç–µ—Ä: –£—Ä. ${getLevel(data.exp_iron || 0)}</div>
                <hr style="border:0; border-top:1px solid #333; margin:15px 0;">
                <p style="font-size:13px;">–£–ª—É—á—à–∏—Ç—å —ç–Ω–µ—Ä–≥–∏—é –¥–æ ${data.max_energy + 20}‚ö°</p>
                <button class="btn" onclick="upEnergy(${nextEnPrice})">–ö–£–ü–ò–¢–¨ –ó–ê ${nextEnPrice}üí∞</button>
            </div>
        `;
    }

    function renderMarket() {
        return `<div class="box">
            <button class="btn" onclick="sell('wood',2)">–ü—Ä–æ–¥–∞—Ç—å –î–µ—Ä–µ–≤–æ (2üí∞)</button>
            <button class="btn" onclick="sell('stone',5)">–ü—Ä–æ–¥–∞—Ç—å –ö–∞–º–µ–Ω—å (5üí∞)</button>
            <button class="btn" onclick="sell('iron',12)">–ü—Ä–æ–¥–∞—Ç—å –ñ–µ–ª–µ–∑–æ (12üí∞)</button>
        </div>`;
    }

    function renderCraft() {
        return `<div class="box">
            <p>–¢–æ–ø–æ—Ä (20üå≤): <button onclick="craft('axe')" ${data.has_axe?'disabled':''}>${data.has_axe?'–ï—Å—Ç—å':'–°–æ–±—Ä–∞—Ç—å'}</button></p>
            <p>–ö–∏—Ä–∫–∞ (30ü™®): <button onclick="craft('pick')" ${data.has_pickaxe?'disabled':''}>${data.has_pickaxe?'–ï—Å—Ç—å':'–°–æ–±—Ä–∞—Ç—å'}</button></p>
        </div>`;
    }

    function setTab(t) { if(!isBusy){ currentTab=t; renderGame(); } }
    function setLoc(l) { if(!isBusy){ currentLoc=l; renderGame(); } }

    async function mine(time, enCost) {
        if (data.energy < enCost) return alert("–ú–∞–ª–æ —ç–Ω–µ—Ä–≥–∏–∏!");
        isBusy = true;
        const btn = document.getElementById('m-btn');
        btn.disabled = true;
        document.getElementById('p-cont').style.display = 'block';
        document.getElementById('p-bar').style.width = '0%';
        setTimeout(() => { document.getElementById('p-bar').style.transition = `width ${time}ms linear`; document.getElementById('p-bar').style.width = '100%'; }, 50);

        setTimeout(async () => {
            const loc = locations[currentLoc];
            data.energy -= enCost;
            data[loc.res] = (data[loc.res] || 0) + 1;
            data[loc.exp] = (data[loc.exp] || 0) + 5; // +5 –æ–ø—ã—Ç–∞ –∑–∞ —Ä–∞–∑
            await sb.from('users').update({ [loc.res]: data[loc.res], [loc.exp]: data[loc.exp], energy: data.energy }).eq('username', user);
            isBusy = false; renderGame();
        }, time);
    }

    async function sell(res, price) {
        if(!data[res]) return;
        data.gold += data[res] * price;
        data[res] = 0;
        await sb.from('users').update({ gold: data.gold, [res]: 0 }).eq('username', user);
        renderGame();
    }

    async function upEnergy(price) {
        if (data.gold < price) return alert("–ù–µ—Ç –¥–µ–Ω–µ–≥!");
        data.gold -= price;
        data.max_energy = (data.max_energy || 100) + 20;
        await sb.from('users').update({ gold: data.gold, max_energy: data.max_energy }).eq('username', user);
        renderGame();
    }

    async function craft(t) {
        if(t==='axe' && data.wood >= 20) { data.wood-=20; data.has_axe=true; }
        else if(t==='pick' && data.stone >= 30) { data.stone-=30; data.has_pickaxe=true; }
        else return alert("–ù–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤!");
        await sb.from('users').update({ wood: data.wood, stone: data.stone, has_axe: data.has_axe, has_pickaxe: data.has_pickaxe }).eq('username', user);
        renderGame();
    }

    async function regen() {
        const max = data.max_energy || 100;
        if (data.energy < max) {
            data.energy = Math.min(max, data.energy + 2);
            if(document.getElementById('en-val')) renderGame();
            if(data.energy % 10 === 0) await sb.from('users').update({ energy: data.energy }).eq('username', user);
        }
    }
</script>
</body>
</html>
