<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TSCHORNI WORLD</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #0a0a0a; color: #fff; font-family: sans-serif; text-align: center; padding: 10px; margin: 0; }
        .box { background: #1a1a1a; padding: 15px; border-radius: 12px; border: 1px solid #333; max-width: 400px; margin: 10px auto; }
        input { width: 90%; padding: 12px; margin: 8px 0; background: #000; border: 1px solid #444; color: #fff; border-radius: 8px; font-size: 16px; }
        .btn { width: 100%; padding: 15px; background: #ffcc00; color: #000; border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; font-size: 16px; }
        .btn-reg { background: none; color: #ffcc00; border: 1px solid #ffcc00; }
        .btn:disabled { background: #444; color: #888; }
        
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .res-item { background: #000; padding: 10px; border-radius: 8px; border: 1px solid #222; font-size: 14px; }
        
        .loc-btn { background: #333; color: #fff; padding: 10px; border-radius: 5px; border: 1px solid #444; margin: 5px; font-size: 12px; }
        .loc-active { border-color: #ffcc00; color: #ffcc00; background: #221a00; }

        #p-cont { width: 100%; background: #222; height: 8px; margin-top: 15px; display: none; border-radius: 4px; overflow: hidden; }
        #p-bar { width: 0%; height: 100%; background: #ffcc00; transition: width linear; }
    </style>
</head>
<body>

<div id="game-container">
    <h1>TSCHORNI</h1>
    <div class="box">
        <input type="text" id="u_nick" placeholder="–ù–ò–ö–ù–ï–ô–ú">
        <input type="password" id="u_pass" placeholder="–ü–ê–†–û–õ–¨">
        <button class="btn" onclick="auth('login')">–í–û–ô–¢–ò</button>
        <button class="btn btn-reg" onclick="auth('reg')">–°–û–ó–î–ê–¢–¨ –ì–ï–†–û–Ø</button>
    </div>
    <p id="st" style="color: #666;">–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞</p>
</div>

<script>
    const S_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co";
    const S_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";
    const sb = window.supabase.createClient(S_URL, S_KEY);

    let user, data = {}, isBusy = false, currentLoc = 'forest';

    const locations = {
        forest: { name: 'üå≤ –õ–ï–°', res: 'wood', time: 5000 },
        quarry: { name: 'ü™® –ö–ê–†–¨–ï–†', res: 'stone', time: 8000 },
        mine: { name: '‚õèÔ∏è –®–ê–•–¢–ê', res: 'iron', time: 12000 }
    };

    async function auth(mode) {
        const nick = document.getElementById('u_nick').value.trim();
        const pass = document.getElementById('u_pass').value.trim();
        const st = document.getElementById('st');
        if (!nick || !pass) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!");

        try {
            if (mode === 'reg') {
                const { error } = await sb.from('users').insert({ id: crypto.randomUUID(), username: nick, email_hidden: pass });
                if (error) throw error;
                alert("–ì–µ—Ä–æ–π —Å–æ–∑–¥–∞–Ω! –¢–µ–ø–µ—Ä—å –≤—Ö–æ–¥–∏.");
            } else {
                const { data: u, error } = await sb.from('users').select('*').eq('username', nick).single();
                if (!u || u.email_hidden !== pass) throw new Error("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞");
                user = nick; data = u; renderGame();
            }
        } catch (e) { alert(e.message); }
    }

    function renderGame() {
        document.getElementById('game-container').innerHTML = `
            <h2>–ì–ï–†–û–ô: ${user}</h2>
            <div class="box">
                <div class="res-grid">
                    <div class="res-item">üí∞ –ó–æ–ª–æ—Ç–æ: <b id="r-gold">${data.gold}</b></div>
                    <div class="res-item">üå≤ –î–µ—Ä–µ–≤–æ: <b id="r-wood">${data.wood || 0}</b></div>
                    <div class="res-item">ü™® –ö–∞–º–µ–Ω—å: <b id="r-stone">${data.stone || 0}</b></div>
                    <div class="res-item">‚õèÔ∏è –ñ–µ–ª–µ–∑–æ: <b id="r-iron">${data.iron || 0}</b></div>
                </div>
            </div>

            <div class="box">
                <h3>–õ–û–ö–ê–¶–ò–Ø: <span id="loc-name">${locations[currentLoc].name}</span></h3>
                <div style="margin-bottom: 10px;">
                    <button class="loc-btn ${currentLoc==='forest'?'loc-active':''}" onclick="setLoc('forest')">–õ–ï–°</button>
                    <button class="loc-btn ${currentLoc==='quarry'?'loc-active':''}" onclick="setLoc('quarry')">–ö–ê–†–¨–ï–†</button>
                    <button class="loc-btn ${currentLoc==='mine'?'loc-active':''}" onclick="setLoc('mine')">–®–ê–•–¢–ê</button>
                </div>
                <button id="m-btn" class="btn" onclick="mine()">–î–û–ë–´–í–ê–¢–¨</button>
                <div id="p-cont"><div id="p-bar"></div></div>
            </div>
            
            <button class="btn" onclick="location.reload()" style="background:#333; color:#fff; width: 200px;">–í–´–ô–¢–ò</button>
        `;
    }

    function setLoc(l) { if (!isBusy) { currentLoc = l; renderGame(); } }

    async function mine() {
        if (isBusy) return;
        isBusy = true;
        const loc = locations[currentLoc];
        const btn = document.getElementById('m-btn');
        const bar = document.getElementById('p-bar');
        const cont = document.getElementById('p-cont');

        btn.disabled = true; btn.innerText = "–í –ü–†–û–¶–ï–°–°–ï...";
        cont.style.display = 'block'; bar.style.width = '0%';
        
        setTimeout(() => { bar.style.transition = `width ${loc.time}ms linear`; bar.style.width = '100%'; }, 50);

        setTimeout(async () => {
            const count = Math.floor(Math.random() * 3) + 1;
            data[loc.res] = (data[loc.res] || 0) + count;
            document.getElementById(`r-${loc.res}`).innerText = data[loc.res];
            
            const updateData = {}; updateData[loc.res] = data[loc.res];
            await sb.from('users').update(updateData).eq('username', user);

            isBusy = false; btn.disabled = false; btn.innerText = "–î–û–ë–´–í–ê–¢–¨";
            cont.style.display = 'none'; bar.style.width = '0%'; bar.style.transition = 'none';
        }, loc.time);
    }
</script>
</body>
</html>
