<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TSCHORNI: MOB HUNTER</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:#000;
      color:#e0e0e0;
      font-family:Arial, Helvetica, sans-serif;
      font-size:13px;
      line-height:1.4;
      overflow:hidden;
      height:100vh;
    }
    #container {
      height:100vh;
      display:flex;
      flex-direction:column;
    }
    #header {
      background:#111;
      border-bottom:2px solid #400;
      padding:8px 12px;
      color:#ff6600;
      font-size:18px;
      font-weight:bold;
      text-align:center;
    }
    #topbar {
      background:#1a1a1a;
      border-bottom:1px solid #333;
      padding:6px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:14px;
    }
    #topbar span { color:#ffcc00; }
    #bars {
      padding:8px 12px;
      background:#111;
      border-bottom:1px solid #400;
    }
    .bar {
      height:18px;
      background:#222;
      border:1px solid #444;
      border-radius:3px;
      margin:6px 0;
      position:relative;
      overflow:hidden;
    }
    .fill {
      height:100%;
      transition:width 0.5s ease;
    }
    .hp .fill { background:linear-gradient(to right, #c00, #800); }
    .st .fill { background:linear-gradient(to right, #ffcc00, #cc9900); }
    .label {
      position:absolute;
      inset:0;
      text-align:center;
      line-height:18px;
      color:#fff;
      font-size:11px;
      text-shadow:1px 1px #000;
    }
    #content {
      flex:1;
      padding:12px;
      overflow-y:auto;
      background:#0d0d0d;
    }
    #log {
      background:#000;
      border:1px solid #400;
      border-radius:4px;
      padding:8px;
      margin-top:12px;
      max-height:180px;
      overflow-y:auto;
      font-size:12px;
      color:#0f8;
    }
    #bottombar {
      background:#111;
      border-top:2px solid #400;
      padding:8px 12px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:center;
    }
    button {
      background:#400;
      color:#ffcc00;
      border:1px solid #800;
      padding:8px 14px;
      border-radius:4px;
      cursor:pointer;
      font-size:14px;
      min-width:90px;
    }
    button:hover {
      background:#600;
      border-color:#a00;
    }
    button:disabled {
      background:#222;
      color:#555;
      border-color:#444;
      cursor:not-allowed;
    }
    .panel-overlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.85);
      z-index:999;
      display:none;
    }
    .panel {
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      background:#111;
      border:2px solid #800;
      border-radius:8px;
      padding:20px;
      max-width:90%;
      max-height:85vh;
      overflow-y:auto;
      z-index:1000;
      display:none;
      box-shadow:0 0 20px rgba(255,0,0,0.3);
    }
    .item {
      background:#1a1a1a;
      border:1px solid #400;
      border-radius:4px;
      padding:8px;
      margin:6px 0;
    }
    #fight { width:90%; max-width:700px; }
    .fighter {
      flex:1;
      text-align:center;
      padding:16px;
      background:#1a1a1a;
      border:1px solid #400;
      border-radius:6px;
    }
    .action-bar {
      display:flex;
      gap:10px;
      justify-content:center;
      margin:20px 0;
    }
    .progress-line {
      height:6px;
      background:#222;
      border-radius:3px;
      overflow:hidden;
      margin:12px 0;
    }
    .progress-fill {
      height:100%;
      width:0%;
      background:#ff6600;
      transition:width 1.2s ease;
    }
  </style>
</head>
<body>

<div id="container">
  <div id="header">TSCHORNI: MOB HUNTER</div>

  <div id="topbar">
    <span id="name">Герой</span>
    <span id="lvl">1 ур.</span>
    <span id="gold">0 зол.</span>
  </div>

  <div id="bars">
    <div class="bar hp">
      <div class="fill" id="hp-fill" style="width:100%"></div>
      <div class="label" id="hp-label">HP 100/100</div>
    </div>
    <div class="bar st">
      <div class="fill" id="st-fill" style="width:100%"></div>
      <div class="label" id="st-label">Выносливость 100/100</div>
    </div>
  </div>

  <div id="content">
    <div id="log"></div>
  </div>

  <div id="bottombar">
    <button onclick="go('Лагерь')">Лагерь</button>
    <button onclick="go('Лес')">Лес</button>
    <button onclick="go('Шахта')">Шахта</button>
    <button onclick="go('Город')">Город</button>
    <button onclick="showInv()">Инвентарь</button>
    <button onclick="showCraft()">Крафт</button>
    <button onclick="showShop()">Магазин</button>
    <button onclick="die()">Умереть</button>
  </div>
</div>

<div id="panel-overlay" class="panel-overlay" onclick="closeAllPanels()"></div>

<div id="inv" class="panel">
  <h2>Инвентарь</h2>
  <div id="inv-list"></div>
  <h3>Экипировка</h3>
  <div id="equip-list"></div>
  <hr>
  <button onclick="closePanel('inv')">Закрыть</button>
</div>

<div id="craft" class="panel">
  <h2>Крафт</h2>
  <div id="craft-list"></div>
  <hr>
  <button onclick="closePanel('craft')">Закрыть</button>
</div>

<div id="shop" class="panel">
  <h2>Магазин</h2>
  <div id="shop-list"></div>
  <hr>
  <button onclick="closePanel('shop')">Закрыть</button>
</div>

<div id="fight" class="panel">
  <h2>Бой</h2>
  <div style="display:flex; gap:20px; margin:20px 0;">
    <div class="fighter fighter-player">
      <h3>Вы</h3>
      <div>HP: <span id="player-hp">100</span>/<span id="player-maxhp">100</span></div>
      <div>Выносливость: <span id="player-st">100</span>/<span id="player-maxst">100</span></div>
    </div>
    <div class="fighter fighter-mob">
      <h3 id="mob-name">Враг</h3>
      <div>Уровень: <span id="mob-level">1</span></div>
      <div>HP: <span id="mob-hp">100</span>/<span id="mob-maxhp">100</span></div>
    </div>
  </div>

  <div class="action-bar">
    <button onclick="playerAttack()">Атака</button>
    <button onclick="playerBlock()">Блок</button>
    <button onclick="playerRun()">Сбежать</button>
  </div>

  <div class="progress-line">
    <div class="progress-fill" id="action-progress"></div>
  </div>

  <button onclick="closeFight()">Завершить бой</button>
</div>
<script>
// ==================================================
// ДАННЫЕ ИГРОКА
// ==================================================
let player = JSON.parse(localStorage.getItem('tschorniWorld')) || {
  name: "Герой",
  level: 1,
  exp: 0,
  expToNext: 100,
  hp: 100,
  maxHp: 100,
  stamina: 100,
  maxStamina: 100,
  gold: 0,
  str: 5,
  vit: 5,
  location: "Лагерь",
  inventory: [
    {id:"rKnife", name:"Ржавый нож", type:"weapon", str:3, count:1},
    {id:"rags", name:"Тряпьё", type:"armor", vit:2, count:1}
  ],
  equip: {
    weapon: {id:"rKnife", name:"Ржавый нож", str:3},
    armor: {id:"rags", name:"Тряпьё", vit:2}
  },
  resources: { wood:0, ore:0, herb:0 }
};

let currentMob = null;

function save() {
  localStorage.setItem('tschorniWorld', JSON.stringify(player));
}

// ==================================================
// ЛОГ + ПРОГРЕСС-ДЕЙСТВИЯ
// ==================================================
function log(txt, color = '#0f8') {
  const div = document.createElement('div');
  div.textContent = txt;
  div.style.color = color;
  document.getElementById('log').appendChild(div);
  div.scrollIntoView({behavior:'smooth'});
  if (document.getElementById('log').children.length > 20) {
    document.getElementById('log').removeChild(document.getElementById('log').firstChild);
  }
}

function progressAction(callback, duration = 1200) {
  const progress = document.createElement('div');
  progress.className = 'progress-line';
  const fill = document.createElement('div');
  fill.className = 'progress-fill';
  progress.appendChild(fill);
  document.getElementById('content').prepend(progress);

  let start = null;
  function animate(timestamp) {
    if (!start) start = timestamp;
    const elapsed = timestamp - start;
    const progressVal = Math.min(1, elapsed / duration);
    fill.style.width = (progressVal * 100) + '%';
    if (elapsed < duration) {
      requestAnimationFrame(animate);
    } else {
      progress.remove();
      callback();
    }
  }
  requestAnimationFrame(animate);
}
// ==================================================
// ОБНОВЛЕНИЕ ИНТЕРФЕЙСА
// ==================================================
function updateUI() {
  document.getElementById('name').textContent = player.name;
  document.getElementById('lvl').textContent = `${player.level} ур.`;
  document.getElementById('gold').textContent = `${player.gold} золота`;

  const hpPerc = Math.min(100, (player.hp / player.maxHp) * 100);
  document.getElementById('hp-fill').style.width = hpPerc + '%';
  document.getElementById('hp-label').textContent = `HP ${Math.floor(player.hp)}/${player.maxHp}`;

  const stPerc = Math.min(100, (player.stamina / player.maxStamina) * 100);
  document.getElementById('st-fill').style.width = stPerc + '%';
  document.getElementById('st-label').textContent = `Выносливость ${Math.floor(player.stamina)}/${player.maxStamina}`;
}

// ==================================================
// ПЕРЕХОД В ЛОКАЦИЮ
// ==================================================
function go(loc) {
  if (player.location === loc) return;
  progressAction(() => {
    player.location = loc;
    log(`→ ${loc}`, '#ffcc00');
    updateUI();
    renderMobs();
  });
}

// ==================================================
// ПАНЕЛИ (инвентарь, крафт, магазин, бой)
// ==================================================
function closeAllPanels() {
  document.getElementById('panel-overlay').style.display = 'none';
  ['inv', 'craft', 'shop', 'fight'].forEach(id => {
    document.getElementById(id).style.display = 'none';
  });
}

function showPanel(id) {
  closeAllPanels();
  document.getElementById('panel-overlay').style.display = 'block';
  document.getElementById(id).style.display = 'block';
}

function closePanel(id) {
  document.getElementById(id).style.display = 'none';
  document.getElementById('panel-overlay').style.display = 'none';
}

function showInv() { showPanel('inv'); renderInventory(); }
function showCraft() { showPanel('craft'); renderCraft(); }
function showShop() { 
  if (player.location !== 'Город') {
    log('Магазин только в Городе', '#ff4444');
    return;
  }
  showPanel('shop'); renderShop(); 
}
// ==================================================
// ИНВЕНТАРЬ
// ==================================================
function renderInventory() {
  const list = document.getElementById('inv-list');
  list.innerHTML = '';
  player.inventory.forEach((item, i) => {
    let btn = '';
    if (item.type === 'weapon' && (!player.equip.weapon || player.equip.weapon.id !== item.id)) {
      btn += `<button onclick="equip(${i}, 'weapon')">Надеть</button>`;
    }
    if (item.type === 'armor' && (!player.equip.armor || player.equip.armor.id !== item.id)) {
      btn += `<button onclick="equip(${i}, 'armor')">Надеть</button>`;
    }
    list.innerHTML += `<div class="item">${item.name} x${item.count || 1} ${btn}</div>`;
  });

  const eq = document.getElementById('equip-list');
  eq.innerHTML = '';
  if (player.equip.weapon) eq.innerHTML += `<div class="item eq">Оружие: ${player.equip.weapon.name} (+${player.equip.weapon.str} STR)</div>`;
  if (player.equip.armor) eq.innerHTML += `<div class="item eq">Броня: ${player.equip.armor.name} (+${player.equip.armor.vit} VIT)</div>`;
}

function equip(index, slot) {
  const item = player.inventory[index];
  if (!item) return;

  if (player.equip[slot]) {
    player.inventory.push({...player.equip[slot], count:1});
  }

  player.equip[slot] = {id:item.id, name:item.name, str:item.str || 0, vit:item.vit || 0};
  item.count = (item.count || 1) - 1;
  if (item.count <= 0) player.inventory.splice(index, 1);

  log(`Надето: ${item.name}`, '#00ff00');
  save();
  updateUI();
  renderInventory();
}

// ==================================================
// МАГАЗИН
// ==================================================
function renderShop() {
  const items = [
    {id:'knife2', name:'Железный нож', type:'weapon', str:8, price:150},
    {id:'leather', name:'Кожаная куртка', type:'armor', vit:8, price:200},
    {id:'potion', name:'Зелье лечения', type:'consumable', price:50}
  ];

  let html = '';
  items.forEach(it => {
    html += `<div class="item">${it.name} — ${it.price} зол. <button onclick="buy('${it.id}',${it.price})">Купить</button></div>`;
  });
  document.getElementById('shop-list').innerHTML = html;
}

function buy(id, price) {
  if (player.gold < price) {
    log('Недостаточно золота', '#ff4444');
    return;
  }
  player.gold -= price;
  const item = {
    id, count:1,
    name: id === 'knife2' ? 'Железный нож' : id === 'leather' ? 'Кожаная куртка' : 'Зелье лечения',
    type: id === 'potion' ? 'consumable' : id.includes('knife') ? 'weapon' : 'armor',
    str: id === 'knife2' ? 8 : 0,
    vit: id === 'leather' ? 8 : 0
  };
  player.inventory.push(item);
  log(`Куплено: ${item.name}`, '#00ff00');
  save();
  updateUI();
}

// ==================================================
// КРАФТ
// ==================================================
function renderCraft() {
  const recipes = [
    {result:{id:'ironKnife', name:'Железный нож', type:'weapon', str:12, count:1}, need:{ore:3, wood:1}},
    {result:{id:'ironArmor', name:'Железная броня', type:'armor', vit:12, count:1}, need:{ore:5, wood:2}}
  ];

  let html = '';
  recipes.forEach((r, i) => {
    let can = true;
    let needTxt = '';
    for (let res in r.need) {
      if ((player.resources[res] || 0) < r.need[res]) can = false;
      needTxt += `${r.need[res]} ${res} `;
    }
    html += `<div class="item">${r.result.name} — ${needTxt} <button ${can ? '' : 'disabled'} onclick="doCraft(${i})">Создать</button></div>`;
  });
  document.getElementById('craft-list').innerHTML = html;
}

function doCraft(index) {
  const r = [
    {result:{id:'ironKnife', name:'Железный нож', type:'weapon', str:12, count:1}, need:{ore:3, wood:1}},
    {result:{id:'ironArmor', name:'Железная броня', type:'armor', vit:12, count:1}, need:{ore:5, wood:2}}
  ][index];

  for (let res in r.need) {
    player.resources[res] -= r.need[res];
  }
  player.inventory.push(r.result);
  log(`Создано: ${r.result.name}`, '#00ff00');
  save();
  updateUI();
  renderCraft();
}

// ==================================================
// БОЙ (полноценный)
// ==================================================
function startFight(mob) {
  currentMob = mob;
  showPanel('fight');
  document.getElementById('mob-name').textContent = mob.name;
  document.getElementById('mob-level').textContent = mob.level;
  document.getElementById('mob-hp').textContent = mob.hp;
  document.getElementById('mob-maxhp').textContent = mob.maxHp;
  document.getElementById('player-hp').textContent = player.hp;
  document.getElementById('player-maxhp').textContent = player.maxHp;
  document.getElementById('player-st').textContent = player.stamina;
  document.getElementById('player-maxst').textContent = player.maxStamina;
  log(`Бой начался: ${mob.name} (ур. ${mob.level})`, '#ff6600');
}

function playerAttack() {
  if (!currentMob || player.stamina < 15) return;
  player.stamina -= 15;
  const dmg = player.str + (player.equip.weapon?.str || 0) + Math.floor(Math.random() * 8);
  currentMob.hp -= dmg;
  log(`→ ${dmg} урона ${currentMob.name}`, '#ff4444');

  if (currentMob.hp <= 0) {
    log(`Убит ${currentMob.name} (ур. ${currentMob.level})!`, '#00ff00');
    player.exp += currentMob.exp;
    player.gold += currentMob.gold;
    closeFight();
    while (player.exp >= player.expToNext) {
      player.level++;
      player.exp -= player.expToNext;
      player.expToNext = Math.floor(player.expToNext * 1.7);
      player.str += 2;
      player.vit += 2;
      player.maxHp += 30;
      player.hp = player.maxHp;
      log(`Уровень ${player.level}! +2 STR +2 VIT +30 HP`, '#ffff00');
    }
  } else {
    mobAttack();
  }

  updateUI();
  renderFight();
}

function playerBlock() {
  if (!currentMob || player.stamina < 5) return;
  player.stamina -= 5;
  log('Блок поставлен', '#0044cc');
  mobAttack(true);
}

function playerRun() {
  if (Math.random() > 0.6) {
    log('Удалось сбежать!', '#00ff00');
    closeFight();
  } else {
    log('Не удалось сбежать!', '#ff4444');
    mobAttack();
  }
}

function mobAttack(isBlocked = false) {
  let mobDmg = Math.max(1, currentMob.dmg - Math.floor(player.vit / 3) - (player.equip.armor?.vit || 0));
  if (isBlocked) mobDmg = Math.floor(mobDmg / 2);
  player.hp -= mobDmg;
  log(`${currentMob.name} → ${mobDmg}${isBlocked ? ' (блок)' : ''}`, '#ff4444');

  if (player.hp <= 0) {
    log('Вы мертвы!', '#ff0000');
    player.hp = 1;
    closeFight();
    die();
  }

  updateUI();
  renderFight();
}

function renderFight() {
  document.getElementById('player-hp').textContent = Math.max(0, player.hp);
  document.getElementById('player-st').textContent = Math.max(0, player.stamina);
  document.getElementById('mob-hp').textContent = Math.max(0, currentMob.hp);
}

function closeFight() {
  closePanel('fight');
  currentMob = null;
  updateUI();
}

// ==================================================
// СМЕРТЬ
// ==================================================
function die() {
  log('Вы мертвы... Возрождение в Лагере', '#ff4444');
  player.hp = player.maxHp;
  player.stamina = player.maxStamina;
  player.exp = Math.floor(player.exp * 0.6);
  player.gold = Math.floor(player.gold * 0.5);
  player.location = 'Лагерь';
  save();
  updateUI();
  go('Лагерь');
}

// ==================================================
// ЗАПУСК
// ==================================================
updateUI();
go('Лагерь');
log('Добро пожаловать в TSCHORNI: MOB HUNTER!', '#ff6600');
log('Переключай локации → бей мобов → крафти → покупай шмот');
log('Прогресс сохраняется автоматически');

// Восстановление выносливости
setInterval(() => {
  if (player.stamina < player.maxStamina) {
    player.stamina = Math.min(player.maxStamina, player.stamina + 1);
    updateUI();
  }
}, 2000);
</script>
</body>
</html>
