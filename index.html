<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TSCHORNI: MOB HUNTER</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #ffcc00; --hp: #ff4444; --st: #00ff88; --bg: #0d0d0d; --box: #1a1a1a; --border: #333; }
        body { background: var(--bg); color: #ddd; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 5px; user-select: none; font-size: 14px; }
        .box { background: var(--box); padding: 10px; border-radius: 8px; border: 1px solid var(--border); margin: 5px auto; max-width: 500px; }
        .bar-bg { width: 100%; height: 18px; background: #222; border-radius: 4px; margin: 3px 0; overflow: hidden; position: relative; border: 1px solid #444; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 10px; font-weight: bold; line-height: 18px; color: #fff; z-index: 2; text-shadow: 1px 1px #000; }
        .tabs { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; margin: 10px 0; }
        .tab-btn { padding: 10px 2px; background: #222; border: 1px solid #444; color: #888; font-size: 9px; border-radius: 4px; cursor: pointer; }
        .tab-active { background: var(--gold); color: #000; font-weight: bold; border-color: var(--gold); }
        .btn { background: var(--gold); color: #000; border: none; padding: 10px; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%; margin: 5px 0; }
        #log { height: 120px; overflow-y: auto; font-size: 10px; color: #aaa; background: #000; padding: 5px; border-top: 1px solid #222; }
        .mob-box { background: #200; border: 1px solid #800; padding: 10px; border-radius: 6px; text-align: center; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="auth-ui">
    <div class="box" style="margin-top:40px; text-align:center;">
        <h2 style="color:var(--gold)">TSCHORNI: REBORN</h2>
        <input type="text" id="u_nick" placeholder="ĞĞ˜ĞšĞĞ•Ğ™Ğœ (Ğ±ĞµĞ· Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ğ¾Ğ²)" style="width:85%;padding:12px;margin:5px;background:#111;border:1px solid #333;color:#fff;">
        <input type="password" id="u_pass" placeholder="ĞŸĞĞ ĞĞ›Ğ¬" style="width:85%;padding:12px;margin:5px;background:#111;border:1px solid #333;color:#fff;">
        <button class="btn" onclick="auth('login')">Ğ’ĞĞ™Ğ¢Ğ˜</button>
        <button class="btn" onclick="auth('reg')" style="background:none;border:1px solid var(--gold);color:var(--gold);">Ğ¡ĞĞ—Ğ”ĞĞ¢Ğ¬ Ğ“Ğ•Ğ ĞĞ¯</button>
        <div id="auth-msg" style="margin-top:12px;font-size:12px;color:#aaa;min-height:1.5em;"></div>
    </div>
</div>

<div id="game-ui" style="display:none;">
    <div class="box">
        <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--gold);margin-bottom:5px;">
            <span>Ğ£Ğ ĞĞ’Ğ•ĞĞ¬: <b id="r-lvl">1</b></span>
            <span>Ğ—ĞĞ›ĞĞ¢Ğ: <b id="r-gold">0</b> ğŸ’°</span>
        </div>
        <div class="bar-bg"><div class="bar-text" id="hp-txt">HP</div><div id="hp-f" class="bar-fill" style="background:var(--hp);"></div></div>
        <div class="bar-bg"><div class="bar-text" id="st-txt">ST</div><div id="st-f" class="bar-fill" style="background:var(--st);"></div></div>
    </div>

    <div class="tabs">
        <button class="tab-btn tab-active" id="t-world" onclick="setTab('world')">ĞœĞ˜Ğ </button>
        <button class="tab-btn" id="t-fight" onclick="setTab('fight')">ĞĞ¥ĞĞ¢Ğ</button>
        <button class="tab-btn" id="t-inv" onclick="setTab('inv')">Ğ“Ğ•Ğ ĞĞ™</button>
        <button class="tab-btn" id="t-shop" onclick="setTab('shop')">Ğ Ğ«ĞĞĞš</button>
        <button class="tab-btn" id="t-stat" onclick="setTab('stat')">Ğ¢ĞĞŸ</button>
    </div>

    <div id="tab-content" class="box" style="min-height:220px;"></div>
    <div id="log" class="box"></div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ĞšĞĞĞ¤Ğ˜Ğ“
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const S_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co";
const S_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";

let sb = null;
let userData = null;
let enemy = null;
let curTab = 'world';
let saveTimer = null;
let isAuthInProgress = false;

const MOBS = {
    'Ğ›ĞµÑ': [
        { n: 'Ğ”Ğ¸ĞºĞ¸Ğ¹ Ğ’Ğ¾Ğ»Ğº', hp: 50, maxHp: 50, dmg: 5, exp: 20, gold: 10 },
        { n: 'Ğ›ĞµÑĞ½Ğ¾Ğ¹ Ğ Ğ°Ğ·Ğ±Ğ¾Ğ¹Ğ½Ğ¸Ğº', hp: 80, maxHp: 80, dmg: 8, exp: 40, gold: 25 }
    ],
    'Ğ¨Ğ°Ñ…Ñ‚Ğ°': [
        { n: 'ĞšĞ°Ğ¼ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¡Ğ»Ğ¸Ğ·ĞµĞ½ÑŒ', hp: 100, maxHp:100, dmg: 4, exp: 35, gold: 15 },
        { n: 'Ğ“Ğ¾Ğ±Ğ»Ğ¸Ğ½-Ğ¨Ğ°Ñ…Ñ‚ĞµÑ€', hp: 150, maxHp:150, dmg:12, exp: 70, gold: 50 }
    ]
};

const EXP_TABLE = [0, 100, 250, 500, 1000, 2000, 4000, 8000, 15000, 30000];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ’Ğ¡ĞŸĞĞœĞĞ“ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ«Ğ• Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addLog(message) {
    const logEl = document.getElementById('log');
    if (!logEl) return;
    const time = new Date().toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'});
    logEl.innerHTML = `<div>[${time}] ${message}</div>` + logEl.innerHTML;
    logEl.scrollTop = logEl.scrollHeight;
}

function updateUI() {
    if (!userData) return;
    const maxHp = 100 + (userData.vit * 10 || 50);
    const maxSt = 100 + (userData.str * 5 || 25);

    document.getElementById('r-lvl').innerText = userData.level || 1;
    document.getElementById('r-gold').innerText = Math.floor(userData.gold || 0);

    const hpPerc = Math.min(100, Math.max(0, (userData.current_hp || 0) / maxHp * 100));
    document.getElementById('hp-txt').innerText = `HP: ${Math.floor(userData.current_hp || 0)}/${maxHp}`;
    document.getElementById('hp-f').style.width = hpPerc + '%';

    const stPerc = Math.min(100, Math.max(0, (userData.stamina || 0) / maxSt * 100));
    document.getElementById('st-txt').innerText = `ST: ${Math.floor(userData.stamina || 0)}/${maxSt}`;
    document.getElementById('st-f').style.width = stPerc + '%';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SUPABASE Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initSupabase() {
    if (typeof supabase === 'undefined') {
        document.getElementById('auth-msg').innerHTML = 'Supabase Ğ½Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ğ»ÑÑ';
        return false;
    }
    sb = supabase.createClient(S_URL, S_KEY);
    addLog('Supabase Ğ³Ğ¾Ñ‚Ğ¾Ğ²');
    return true;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ĞĞ’Ğ¢ĞĞ Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ (email Ñ‚ĞµĞ¿ĞµÑ€ÑŒ @gmail.com)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function auth(mode) {
    if (isAuthInProgress) return;
    isAuthInProgress = true;

    const msg = document.getElementById('auth-msg');
    msg.innerHTML = 'ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ...';

    if (!sb && !initSupabase()) {
        msg.innerHTML = 'ĞÑˆĞ¸Ğ±ĞºĞ° Supabase';
        isAuthInProgress = false;
        return;
    }

    const nick = (document.getElementById('u_nick').value || '').trim();
    const pass = document.getElementById('u_pass').value;

    if (!nick || nick.length < 3 || nick.includes(' ')) {
        msg.innerHTML = 'ĞĞ¸Ğº: Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 3 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°, Ğ±ĞµĞ· Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ğ¾Ğ²';
        isAuthInProgress = false;
        return;
    }
    if (!pass || pass.length < 6) {
        msg.innerHTML = 'ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²';
        isAuthInProgress = false;
        return;
    }

    const email = nick.toLowerCase() + '@gmail.com';  // â† Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ Ğ—Ğ”Ğ•Ğ¡Ğ¬

    try {
        if (mode === 'reg') {
            const { error } = await sb.auth.signUp({
                email,
                password: pass,
                options: { data: { username: nick } }
            });
            if (error) throw error;
            msg.innerHTML = `Ğ“ĞµÑ€Ğ¾Ğ¹ "${nick}" ÑĞ¾Ğ·Ğ´Ğ°Ğ½! Ğ’Ñ…Ğ¾Ğ´Ğ¸.`;
            addLog(`Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ: ${nick} (${email})`);
        } else {
            const { data: { session }, error } = await sb.auth.signInWithPassword({
                email,
                password: pass
            });
            if (error) throw error;
            addLog(`Ğ’Ñ…Ğ¾Ğ´: ${nick} (${email})`);
            await loadPlayerData();
        }
    } catch (err) {
        msg.innerHTML = 'ĞÑˆĞ¸Ğ±ĞºĞ°: ' + (err.message || 'Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾');
        addLog('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸: ' + err.message);
    } finally {
        isAuthInProgress = false;
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ Ğ“Ğ•Ğ ĞĞ¯
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPlayerData() {
    addLog("1. ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ³ĞµÑ€Ğ¾Ñ");

    try {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) {
            addLog("ĞĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾ÑĞ»Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ°");
            return;
        }
        addLog("2. UID: " + user.id);

        const username = user.user_metadata?.username || user.email?.split('@')[0];
        if (!username) {
            addLog("ĞĞ¸ĞºĞ½ĞµĞ¹Ğ¼ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½");
            return;
        }
        addLog("3. Username: " + username);

        addLog("4. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº users...");

        const { data, error, count } = await sb
            .from('users')
            .select('*', { count: 'exact' })
            .eq('username', username);

        if (error) {
            addLog("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°: " + error.message);
            return;
        }

        addLog("5. ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ ÑÑ‚Ñ€Ğ¾Ğº: " + (count || 0));

        if (count === 0 || !data || data.length === 0) {
            addLog("6. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ³ĞµÑ€Ğ¾Ñ");
            const initial = {
                id: user.id,
                username: username,
                current_hp: 150,
                stamina: 100,
                gold: 200,
                str: 5,
                vit: 5,
                agi: 5,
                int: 5,
                exp: 0,
                level: 1,
                location: 'Ğ›Ğ°Ğ³ĞµÑ€ÑŒ',
                inventory: []
            };

            const { error: insErr } = await sb.from('users').insert(initial);
            if (insErr) {
                addLog("ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ: " + insErr.message);
                return;
            }

            userData = initial;
            addLog("7. ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ³ĞµÑ€Ğ¾Ğ¹ ÑĞ¾Ğ·Ğ´Ğ°Ğ½");
        } else {
            userData = data[0];
            addLog("7. Ğ“ĞµÑ€Ğ¾Ğ¹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹");
        }

        document.getElementById('auth-ui').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        startApp();

    } catch (err) {
        addLog("ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: " + err.message);
        console.error(err);
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ˜Ğ“Ğ ĞĞ’Ğ«Ğ• Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜ (Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startApp() {
    updateUI();
    setTab('world');
    saveTimer = setInterval(saveData, 10000);
    setInterval(tick, 2000);
}

async function saveData() {
    if (!userData || !sb) return;
    const { error } = await sb.from('users').update(userData).eq('username', userData.username);
    if (!error) addLog("Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾");
}

function setTab(t) {
    curTab = t;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
    document.getElementById('t-'+t).classList.add('tab-active');

    const c = document.getElementById('tab-content');

    if (t === 'world') {
        c.innerHTML = `
            <h4>Ğ›Ğ¾ĞºĞ°Ñ†Ğ¸Ñ: ${userData?.location || '??'}</h4>
            <p>ĞšÑƒĞ´Ğ° Ğ¸Ğ´Ñ‘Ğ¼?</p>
            <button class="btn" onclick="travel('Ğ›ĞµÑ')">ğŸŒ² Ğ¢ĞµĞ¼Ğ½Ñ‹Ğ¹ Ğ›ĞµÑ</button>
            <button class="btn" onclick="travel('Ğ¨Ğ°Ñ…Ñ‚Ğ°')">â›ï¸ Ğ“Ğ»ÑƒĞ±Ğ¾ĞºĞ°Ñ Ğ¨Ğ°Ñ…Ñ‚Ğ°</button>
            <button class="btn" style="background:#444;color:#fff" onclick="travel('Ğ›Ğ°Ğ³ĞµÑ€ÑŒ')">ğŸ›– Ğ›Ğ°Ğ³ĞµÑ€ÑŒ</button>`;
    } else if (t === 'fight') {
        if (userData.location === 'Ğ›Ğ°Ğ³ĞµÑ€ÑŒ') {
            c.innerHTML = '<p style="text-align:center;padding:60px 0">Ğ’ Ğ»Ğ°Ğ³ĞµÑ€Ğµ Ğ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ¾Ğ² Ğ½ĞµÑ‚</p>';
        } else {
            renderFight();
        }
    } else if (t === 'inv') {
        renderHero();
    } else if (t === 'shop') {
        c.innerHTML = `
            <h4>Ğ¢Ğ¾Ñ€Ğ³Ğ¾Ğ²ĞµÑ†</h4>
            <div class="box" style="margin:0;border-color:#444">
                Ğ—ĞµĞ»ÑŒĞµ Ğ¶Ğ¸Ğ·Ğ½Ğ¸ (Full HP) â€” 50 ğŸ’°
                <button onclick="buyPot()">ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ</button>
            </div>`;
    } else if (t === 'stat') {
        c.innerHTML = '<p style="text-align:center;padding:60px 0">Ğ¢ĞĞŸ ÑĞºĞ¾Ñ€Ğ¾ Ğ¿Ğ¾ÑĞ²Ğ¸Ñ‚ÑÑ...</p>';
    }
}

function renderFight() {
    const c = document.getElementById('tab-content');
    if (!enemy) {
        c.innerHTML = `<h4>Ğ—Ğ°ÑĞ°Ğ´Ğ°!</h4><button class="btn" onclick="spawnEnemy()">Ğ˜Ğ¡ĞšĞĞ¢Ğ¬ ĞœĞĞ‘Ğ</button>`;
        return;
    }
    c.innerHTML = `
        <div class="mob-box">
            <div style="font-weight:bold;color:var(--hp)">${enemy.n}</div>
            <div class="bar-bg"><div id="en-hp" class="bar-fill" style="background:var(--hp);width:${(enemy.hp/enemy.maxHp*100)}%"></div></div>
            <div style="font-size:10px">${Math.floor(enemy.hp)} / ${enemy.maxHp} HP</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;">
            <button class="btn" style="height:60px" onclick="attack()">Ğ£Ğ”ĞĞ Ğ˜Ğ¢Ğ¬</button>
            <button class="btn" style="height:60px;background:#555;color:#fff" onclick="enemy=null;setTab('fight')">Ğ¡Ğ‘Ğ•Ğ–ĞĞ¢Ğ¬</button>
        </div>`;
}

function spawnEnemy() {
    const mobs = MOBS[userData.location] || [];
    if (!mobs.length) return;
    enemy = { ...mobs[Math.floor(Math.random() * mobs.length)] };
    renderFight();
}

function attack() {
    if (!enemy || (userData.stamina || 0) < 10) {
        addLog((userData.stamina || 0) < 10 ? 'ĞœĞ°Ğ»Ğ¾ ÑÑ‚Ğ°Ğ¼Ğ¸Ğ½Ñ‹!' : 'ĞĞµÑ‚ Ñ†ĞµĞ»Ğ¸');
        return;
    }
    userData.stamina = (userData.stamina || 0) - 10;
    let dmg = 5 + (userData.str || 5);
    enemy.hp -= dmg;
    addLog(`Ğ’Ñ‹ ÑƒĞ´Ğ°Ñ€Ğ¸Ğ»Ğ¸ â†’ ${dmg}`);

    if (enemy.hp <= 0) {
        addLog(`ĞŸĞ¾Ğ±ĞµĞ´Ğ°! +${enemy.exp} exp +${enemy.gold} gold`);
        userData.exp = (userData.exp || 0) + enemy.exp;
        userData.gold = (userData.gold || 0) + enemy.gold;
        enemy = null;
        checkLevelUp();
        setTab('fight');
    } else {
        let edmg = Math.max(1, enemy.dmg - Math.floor((userData.vit || 0) / 2));
        userData.current_hp = (userData.current_hp || 0) - edmg;
        addLog(`${enemy.n} â†’ ${edmg}`);
        if (userData.current_hp <= 0) {
            userData.current_hp = 10;
            userData.location = 'Ğ›Ğ°Ğ³ĞµÑ€ÑŒ';
            enemy = null;
            addLog('Ğ’Ñ‹ Ğ¾Ñ‡Ğ½ÑƒĞ»Ğ¸ÑÑŒ Ğ² Ğ›Ğ°Ğ³ĞµÑ€Ğµ...');
            setTab('world');
        }
    }
    updateUI();
    if (enemy) renderFight();
}

function checkLevelUp() {
    while (userData.level < EXP_TABLE.length - 1 && (userData.exp || 0) >= EXP_TABLE[userData.level + 1]) {
        userData.level++;
        userData.str = (userData.str || 5) + 2;
        userData.vit = (userData.vit || 5) + 2;
        addLog(`âœ¨ Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ ${userData.level}! +2 STR +2 VIT`);
    }
}

function renderHero() {
    const c = document.getElementById('tab-content');
    let tbl = `<table><tr><th>Ğ£Ñ€.</th><th>Ğ”Ğ¾ ÑĞ»ĞµĞ´.</th></tr>`;
    for (let i = 1; i < EXP_TABLE.length; i++) {
        const style = userData.level === i ? 'style="color:var(--gold);font-weight:bold"' : '';
        tbl += `<tr ${style}><td>${i}</td><td>${EXP_TABLE[i]}</td></tr>`;
    }
    tbl += '</table>';

    c.innerHTML = `
        <h4>Ğ“ĞµÑ€Ğ¾Ğ¹: ${userData.username || '??'}</h4>
        <div style="font-size:12px">
            Ğ¡Ğ¸Ğ»Ğ° ${userData.str || 5} â€¢ Ğ–Ğ¸Ğ²ÑƒÑ‡ĞµÑÑ‚ÑŒ ${userData.vit || 5}<br>
            ĞŸÑ€ĞµĞ´Ğ¼ĞµÑ‚Ğ¾Ğ²: ${userData.inventory?.length || 0}
        </div>
        ${tbl}`;
}

function travel(loc) {
    userData.location = loc;
    enemy = null;
    addLog(`â†’ ${loc}`);
    setTab('world');
    updateUI();
}

function buyPot() {
    if ((userData.gold || 0) >= 50) {
        userData.gold = (userData.gold || 0) - 50;
        userData.current_hp = 100 + (userData.vit || 5) * 10;
        addLog('Ğ—ĞµĞ»ÑŒĞµ Ğ²Ñ‹Ğ¿Ğ¸Ñ‚Ğ¾ â€” HP Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ!');
        updateUI();
    } else {
        addLog('ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ·Ğ¾Ğ»Ğ¾Ñ‚Ğ°');
    }
}

function tick() {
    if (!userData) return;
    const maxHp = 100 + (userData.vit || 5) * 10;
    const maxSt = 100 + (userData.str || 5) * 5;
    if ((userData.current_hp || 0) < maxHp) userData.current_hp = Math.min(maxHp, (userData.current_hp || 0) + 2);
    if ((userData.stamina || 0) < maxSt) userData.stamina = Math.min(maxSt, (userData.stamina || 0) + 3);
    updateUI();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ğ—ĞĞŸĞ£Ğ¡Ğš
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', () => {
    if (initSupabase()) {
        sb.auth.onAuthStateChange(async (event, session) => {
            if (session) await loadPlayerData();
            else {
                document.getElementById('auth-ui').style.display = 'block';
                document.getElementById('game-ui').style.display = 'none';
            }
        });

        sb.auth.getSession().then(({ data: { session } }) => {
            if (session) loadPlayerData();
        });
    }
});
</script>
</body>
</html>
