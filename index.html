<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carnage: Levels & Mobs</title>
    <style>
        :root { --gold: #f1c40f; --bg: #111; --panel: #222; --blue: #3498db; --red: #e74c3c; --green: #2ecc71; --border: #444; }
        body { background: var(--bg); color: #ddd; font-family: 'Verdana', sans-serif; margin: 0; padding-bottom: 80px; user-select: none; }
        .header { background: #000; padding: 10px; border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 10; }
        .bar-bg { height: 14px; background: #333; border-radius: 7px; border: 1px solid #555; overflow: hidden; margin: 4px 0; position: relative; }
        .fill { height: 100%; transition: 0.4s; width: 100%; }
        .bar-txt { position: absolute; width: 100%; text-align: center; font-size: 10px; line-height: 14px; font-weight: bold; color: #fff; z-index: 2; }
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .screen { display: none; } .active { display: block; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        button { padding: 12px; background: #3c3c3c; color: #eee; border: 1px solid #555; border-radius: 6px; font-weight: bold; cursor: pointer; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #000; display: flex; border-top: 2px solid var(--border); z-index: 20; }
        .nav-item { flex: 1; padding: 15px 5px; text-align: center; font-size: 10px; color: #888; }
        .nav-item.active { color: var(--gold); background: #1a1a1a; }
        #log { height: 120px; overflow-y: auto; background: #000; padding: 8px; font-size: 11px; color: #aaa; margin-bottom: 10px; border: 1px solid var(--border); line-height: 1.4; }
        .btn-move { background: #2c3e50; border-color: var(--blue); }
        #scr-battle { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; padding: 20px; text-align: center; display:none; }
        #scr-battle.active { display: block; }
    </style>
</head>
<body>

    <div class="header">
        <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--gold); margin-bottom:5px;">
            <b id="ui-nick">–ì–µ—Ä–æ–π</b>
            <b>üí∞ <span id="gold">0</span></b>
        </div>
        <div class="bar-bg"><div class="bar-txt">‚ù§Ô∏è HP: <span id="hp-val">0/0</span></div><div id="hp-fill" class="fill" style="background:var(--green)"></div></div>
        <div class="bar-bg"><div class="bar-txt">üåü EXP: <span id="exp-val">0/0</span></div><div id="exp-fill" class="fill" style="background:var(--blue)"></div></div>
        <div style="text-align:center; font-size:10px; margin-top:5px;">–£—Ä–æ–≤–µ–Ω—å: <b id="ui-lvl">1</b></div>
    </div>

    <div class="content" style="padding:10px;">
        <div id="log"></div>

        <div id="scr-town" class="screen active">
            <h3 style="text-align:center; color:var(--gold)">üèòÔ∏è –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ì–æ—Ä–æ–¥</h3>
            <div class="grid">
                <button onclick="openBuild('shop')">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
                <button onclick="openBuild('hospital')">üè• –ë–æ–ª—å–Ω–∏—Ü–∞</button>
            </div>
            <h4 style="text-align:center; margin: 15px 0 5px 0;">–í—ã—Ö–æ–¥—ã:</h4>
            <button class="btn-move" style="width:100%" onclick="move('forest_1')">üå≤ –û–ø—É—à–∫–∞ –ª–µ—Å–∞ (LVL 0+)</button>
        </div>

        <div id="scr-world" class="screen">
            <h3 id="loc-name" style="text-align:center;">–õ–æ–∫–∞—Ü–∏—è</h3>
            <div id="loc-nav" class="grid"></div>
            <div style="height:10px;"></div>
            <div id="loc-actions">
                <button style="width:100%; background:var(--red);" onclick="hunt()">‚öîÔ∏è –ò–°–ö–ê–¢–¨ –í–†–ê–ì–ê</button>
            </div>
            <button style="width:100%; margin-top:10px; background:#111;" onclick="move('town')">üèòÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–æ—Ä–æ–¥</button>
        </div>

        <div id="scr-char" class="screen panel">
            <h4 style="margin:0 0 10px 0; color:var(--gold);">üë§ –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h4>
            <div id="stat-points" style="color:var(--green); font-size:12px; margin-bottom:10px;">–°–≤–æ–±–æ–¥–Ω—ã–µ –æ—á–∫–∏: 0</div>
            <div id="stat-list"></div>
        </div>
        
        <div id="scr-shop" class="screen">
            <h3 style="color:var(--gold); text-align:center;">üõí –ú–∞–≥–∞–∑–∏–Ω</h3>
            <div id="shop-list"></div>
            <button style="width:100%; margin-top:10px;" onclick="move('town')">‚ùå –í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div id="scr-battle">
        <h2 style="color:var(--red)">‚öîÔ∏è –ë–ò–¢–í–ê</h2>
        <div id="en-img" style="font-size:60px; margin: 20px 0;">üëπ</div>
        <h3 id="en-name">–ú–æ–Ω—Å—Ç—Ä</h3>
        <div style="font-size:12px; margin-bottom:5px;">–£—Ä–æ–≤–µ–Ω—å: <span id="en-lvl">0</span></div>
        <div class="bar-bg" style="width:80%; margin: 0 auto;"><div id="en-hp-fill" class="fill" style="background:var(--red)"></div></div>
        <div class="grid" style="max-width:300px; margin: 30px auto;">
            <button onclick="hit('head')">–ì–æ–ª–æ–≤–∞</button>
            <button onclick="hit('body')">–¢–æ—Ä—Å</button>
            <button onclick="hit('legs')" style="grid-column: span 2;">–ù–æ–≥–∏</button>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" id="nav-town" onclick="move('town')">üèôÔ∏è<br>–ì–æ—Ä–æ–¥</div>
        <div class="nav-item" id="nav-wild" onclick="move('forest_1')">üó∫Ô∏è<br>–ú–∏—Ä</div>
        <div class="nav-item" id="nav-char" onclick="openChar()">üë§<br>–ì–µ—Ä–æ–π</div>
    </div>

    <script>
        const SB_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co"; 
        const SB_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";

        let p = JSON.parse(localStorage.getItem('last_user_save')) || { 
            username: "–ì–µ—Ä–æ–π", hp: 100, gold: 50, exp: 0, lastExpPoint: 0, lvl: 1, points: 5,
            str: 5, agi: 5, vit: 5, int: 5, loc: 'town',
            equip: { weapon: null }, inventory: [] 
        };

        let enemy = null;
        const gTime = () => new Intl.DateTimeFormat('ru-RU', {timeZone:'Europe/Berlin', hour:'2-digit', minute:'2-digit'}).format(new Date());

        // –ë–∞–∑–∞ –ª–æ–∫–∞—Ü–∏–π
        const world = {
            'town': { name: '–ì–æ—Ä–æ–¥', links: ['forest_1'], minLvl: 0 },
            'forest_1': { name: '–û–ø—É—à–∫–∞ –ª–µ—Å–∞', links: ['town', 'forest_2'], minLvl: 0, 
                mobs: [{n:'–ö—Ä—ã—Å–∞', i:'üêÄ', hp:40, dmg:5, lvl:1, exp:10, g:5}] },
            'forest_2': { name: '–ì—É—Å—Ç–∞—è —á–∞—â–∞', links: ['forest_1', 'cave'], minLvl: 3, 
                mobs: [{n:'–í–æ–ª–∫', i:'üê∫', hp:120, dmg:12, lvl:4, exp:35, g:15}] },
            'cave': { name: '–ü–µ—â–µ—Ä–∞ –æ—Ä–∫–æ–≤', links: ['forest_2', 'lair'], minLvl: 6, 
                mobs: [{n:'–û—Ä–∫', i:'üëπ', hp:350, dmg:25, lvl:7, exp:100, g:40}] },
            'lair': { name: '–õ–æ–≥–æ–≤–æ –î—Ä–∞–∫–æ–Ω–∞', links: ['cave'], minLvl: 9, 
                mobs: [{n:'–î—Ä–∞–∫–æ–Ω', i:'üêâ', hp:1000, dmg:60, lvl:12, exp:500, g:200}] }
        };

        async function save() {
            localStorage.setItem('last_user_save', JSON.stringify(p));
            try {
                await fetch(`${SB_URL}/rest/v1/users?username=eq.${p.username}`, {
                    method: 'PATCH',
                    headers: { "apikey": SB_KEY, "Authorization": `Bearer ${SB_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ save_data: p })
                });
            } catch(e) {}
        }

        function move(locID) {
            const loc = world[locID];
            if(p.lvl < loc.minLvl) {
                return addLog(`‚ùå –°–ª–∏—à–∫–æ–º –æ–ø–∞—Å–Ω–æ! –ù—É–∂–µ–Ω —É—Ä–æ–≤–µ–Ω—å ${loc.minLvl}`);
            }

            p.loc = locID;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));

            if(locID === 'town') {
                document.getElementById('scr-town').classList.add('active');
                document.getElementById('nav-town').classList.add('active');
            } else {
                document.getElementById('scr-world').classList.add('active');
                document.getElementById('nav-wild').classList.add('active');
                document.getElementById('loc-name').innerText = loc.name;
                
                const nav = document.getElementById('loc-nav');
                nav.innerHTML = '';
                loc.links.forEach(l => {
                    const btn = document.createElement('button');
                    btn.innerText = "‚û° " + world[l].name;
                    btn.onclick = () => move(l);
                    nav.appendChild(btn);
                });
            }
            updateUI();
            save();
        }

        function hunt() {
            const loc = world[p.loc];
            if(!loc.mobs) return;
            const m = loc.mobs[Math.floor(Math.random() * loc.mobs.length)];
            enemy = { ...m, curHp: m.hp };
            
            document.getElementById('en-name').innerText = enemy.n;
            document.getElementById('en-img').innerText = enemy.i;
            document.getElementById('en-lvl').innerText = enemy.lvl;
            document.getElementById('scr-battle').classList.add('active');
            addLog(`‚öîÔ∏è –í—Ä–∞–≥ –∑–∞–º–µ—á–µ–Ω: ${enemy.n}!`);
        }

        function hit(zone) {
            if(!enemy) return;
            let dmg = p.str + Math.floor(Math.random() * 5);
            enemy.curHp -= dmg;
            addLog(`–¢—ã —É–¥–∞—Ä–∏–ª ${enemy.n} –Ω–∞ ${dmg}.`);

            if(enemy.curHp <= 0) {
                addLog(`üèÜ –ü–æ–±–µ–¥–∞! –ü–æ–ª—É—á–µ–Ω–æ ${enemy.exp} –æ–ø—ã—Ç–∞ –∏ ${enemy.g} –∑–æ–ª–æ—Ç–∞.`);
                p.exp += enemy.exp; p.gold += enemy.g;
                checkProgress();
                return endBattle();
            }

            // –û—Ç–≤–µ—Ç –º–æ–±–∞
            let eDmg = enemy.dmg;
            if(Math.random() * 100 < p.agi) {
                addLog(`üõ°Ô∏è –¢—ã —É–≤–µ—Ä–Ω—É–ª—Å—è –æ—Ç —É–¥–∞—Ä–∞!`);
            } else {
                p.hp -= eDmg;
                addLog(`ü©∏ ${enemy.n} —É–¥–∞—Ä–∏–ª —Ç–µ–±—è –Ω–∞ ${eDmg}.`);
            }

            if(p.hp <= 0) {
                p.hp = 1;
                addLog("üíÄ –¢—ã –ø—Ä–æ–∏–≥—Ä–∞–ª –∏ —Å–±–µ–∂–∞–ª –≤ –≥–æ—Ä–æ–¥!");
                endBattle();
                move('town');
            }
            updateUI();
        }

        function endBattle() {
            enemy = null;
            document.getElementById('scr-battle').classList.remove('active');
            updateUI();
            save();
        }

        function checkProgress() {
            // –û—á–∫–∏ —Å—Ç–∞—Ç–æ–≤ –∫–∞–∂–¥—ã–µ 50 –æ–ø—ã—Ç–∞
            if(p.exp - p.lastExpPoint >= 50) {
                p.points += 1;
                p.lastExpPoint += 50;
                addLog("‚ú® –ü–æ–ª—É—á–µ–Ω–æ –æ—á–∫–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫!");
            }
            // –£—Ä–æ–≤–µ–Ω—å
            let nextLvlExp = p.lvl * 150;
            if(p.exp >= nextLvlExp) {
                p.lvl++;
                addLog(`üéä –£–†–û–í–ï–ù–¨ –ü–û–í–´–®–ï–ù: ${p.lvl}!`);
            }
        }

        function openChar() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('scr-char').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('nav-char').classList.add('active');
            updateUI();
        }

        function addStat(s) {
            if(p.points > 0) {
                p[s]++; p.points--;
                updateUI(); save();
            }
        }

        function updateUI() {
            let maxHp = 100 + (p.vit * 20);
            document.getElementById('gold').innerText = p.gold;
            document.getElementById('ui-lvl').innerText = p.lvl;
            document.getElementById('hp-val').innerText = `${Math.ceil(p.hp)}/${maxHp}`;
            document.getElementById('hp-fill').style.width = (p.hp / maxHp * 100) + "%";
            
            let nextExp = p.lvl * 150;
            document.getElementById('exp-val').innerText = `${p.exp}/${nextExp}`;
            document.getElementById('exp-fill').style.width = (p.exp / nextExp * 100) + "%";

            document.getElementById('stat-points').innerText = `–°–≤–æ–±–æ–¥–Ω—ã–µ –æ—á–∫–∏: ${p.points}`;
            const sl = document.getElementById('stat-list');
            sl.innerHTML = '';
            [['–°–∏–ª–∞', 'str'], ['–õ–æ–≤–∫–æ—Å—Ç—å', 'agi'], ['–ñ–∏–≤—É—á–µ—Å—Ç—å', 'vit']].forEach(s => {
                sl.innerHTML += `
                <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #333;">
                    <span>${s[0]}: <b>${p[s[1]]}</b></span>
                    ${p.points > 0 ? `<button onclick="addStat('${s[1]}')" style="padding:2px 10px; background:var(--green); color:black;">+</button>` : ''}
                </div>`;
            });

            if(enemy) {
                document.getElementById('en-hp-fill').style.width = (enemy.curHp / enemy.hp * 100) + "%";
            }
        }

        function addLog(m) {
            const l = document.getElementById('log');
            l.innerHTML += `<div><span style="color:#555">[${gTime()}]</span> ${m}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        function openBuild(type) {
            if(type === 'hospital') {
                if(p.gold >= 10) { p.gold -= 10; p.hp = 100 + (p.vit * 20); addLog("‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!"); updateUI(); }
                else { alert("–ú–∞–ª–æ –∑–æ–ª–æ—Ç–∞!"); }
            }
            if(type === 'shop') {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('scr-shop').classList.add('active');
            }
        }

        // –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è
        setInterval(() => {
            let maxHp = 100 + (p.vit * 20);
            if(!enemy && p.hp < maxHp) { p.hp = Math.min(maxHp, p.hp + 2); updateUI(); }
        }, 5000);

        move('town');
    </script>
</body>
</html>
