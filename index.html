<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carnage Online</title>
    <style>
        :root { --gold: #f1c40f; --bg: #121212; --panel: #222; --blue: #3498db; --red: #e74c3c; --green: #2ecc71; --nrg: #9b59b6; }
        body { background: var(--bg); color: #e0e0e0; font-family: sans-serif; margin: 0; padding: 10px; font-size: 14px; user-select: none; }
        .panel { background: var(--panel); padding: 12px; border-radius: 10px; border: 1px solid #333; margin-bottom: 8px; }
        .auth-box { display: flex; flex-direction: column; gap: 10px; }
        input { padding: 12px; background: #000; color: #fff; border: 1px solid #444; border-radius: 8px; outline: none; }
        input:focus { border-color: var(--blue); }
        .btn-main { padding: 14px; background: var(--blue); border: none; color: #fff; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        .bar-bg { flex-grow: 1; height: 10px; background: #000; border-radius: 5px; border: 1px solid #444; overflow: hidden; }
        .fill { height: 100%; transition: 0.3s; width: 100%; }
        #hp-fill { background: var(--green); }
        #nrg-fill { background: var(--nrg); }
        #work-fill { background: var(--gold); width: 0%; transition: none; }
        
        #log { height: 90px; overflow-y: auto; background: #000; padding: 10px; font-size: 12px; border-radius: 5px; margin-bottom: 8px; color: #bbb; border: 1px solid #333; }
        .screen { display: none; } .active { display: block; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        button { padding: 12px; background: #333; color: #fff; border: 1px solid #555; border-radius: 8px; font-weight: bold; cursor: pointer; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .loc-title { font-size: 18px; color: var(--gold); text-align: center; display: block; margin-bottom: 10px; font-weight: bold; }
        .avatar { font-size: 50px; text-align: center; margin: 10px 0; }
    </style>
</head>
<body>

    <div id="scr-auth" class="screen active">
        <div class="panel auth-box">
            <span class="loc-title">üè∞ CARNAGE ONLINE</span>
            <input type="text" id="auth-user" placeholder="–õ–æ–≥–∏–Ω (–ù–∏–∫–Ω–µ–π–º)">
            <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn-main" onclick="handleAuth('login')">–í–û–ô–¢–ò</button>
            <button style="background:none; border:none; color:var(--blue); font-size:12px;" onclick="handleAuth('reg')">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <div id="auth-msg" style="color:var(--red); font-size:11px; text-align:center; margin-top:5px;"></div>
        </div>
    </div>

    <div id="scr-game" class="screen">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; font-weight:bold;">
                <span>üë§ <span id="ui-name">–ì–µ—Ä–æ–π</span></span>
                <span>üí∞ <span id="gold">0</span></span>
            </div>
            <div style="display:flex; align-items:center; gap:8px; margin-top:8px;">
                <span style="font-size:10px;">‚ù§Ô∏è</span>
                <div class="bar-bg"><div id="hp-fill" class="fill"></div></div>
            </div>
            <div style="display:flex; align-items:center; gap:8px; margin-top:5px;">
                <span style="font-size:10px;">‚ö°</span>
                <div class="bar-bg"><div id="nrg-fill" class="fill"></div></div>
            </div>
            <div id="work-ui" style="display:none; margin-top:10px; flex-direction:column; align-items:center;">
                <div class="bar-bg" style="width:100%"><div id="work-fill" class="fill"></div></div>
                <span id="work-label" style="font-size:10px; color:var(--gold); margin-top:2px;">–î–û–ë–´–ß–ê...</span>
            </div>
        </div>

        <div id="log"></div>

        <div id="scr-world" class="screen active">
            <div class="avatar">üë§</div>
            <span class="loc-title" id="loc-name">–ì–æ—Ä–æ–¥</span>
            <div class="grid" id="nav-btns"></div>
            <div id="act-btns" class="grid" style="margin-top:10px;"></div>
        </div>
        
        <button onclick="saveAndExit()" style="width:100%; margin-top:15px; background:none; border:none; color:#555; font-size:11px;">–í—ã–π—Ç–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <script>
        // –î–ê–ù–ù–´–ï –°–ï–†–í–ï–†–ê
        const SB_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co"; 
        const SB_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";

        let p = {}; 
        let isWorking = false;

        async function sbFetch(method, body) {
            const options = {
                method: method,
                headers: { 
                    "apikey": SB_KEY, 
                    "Authorization": `Bearer ${SB_KEY}`, 
                    "Content-Type": "application/json", 
                    "Prefer": "return=representation" 
                }
            };
            if(body) options.body = JSON.stringify(body);
            // –†–∞–±–æ—Ç–∞–µ–º —Å —Ç–∞–±–ª–∏—Ü–µ–π 'users', –∫–æ—Ç–æ—Ä—É—é —Ç—ã –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å –≤ Supabase
            return fetch(`${SB_URL}/rest/v1/users${method==='POST'?'':'?username=eq.'+p.username}`, options);
        }

        async function handleAuth(type) {
            const user = document.getElementById('auth-user').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            const msg = document.getElementById('auth-msg');

            if(!user || !pass) return msg.innerText = "–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å!";
            msg.style.color = "var(--gold)"; msg.innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...";

            if(type === 'reg') {
                const res = await sbFetch('POST', { 
                    username: user, 
                    password: pass, 
                    save_data: { hp:100, g:50, nrg:50, wood:0, iron:0, loc:'town' } 
                });
                if(res.ok) msg.innerText = "–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –ù–∞–∂–º–∏—Ç–µ '–í–æ–π—Ç–∏'.";
                else msg.innerText = "–û—à–∏–±–∫–∞! –í–æ–∑–º–æ–∂–Ω–æ, –Ω–∏–∫ –∑–∞–Ω—è—Ç.";
            } else {
                try {
                    p.username = user;
                    const res = await sbFetch('GET');
                    const data = await res.json();
                    if(data && data.length > 0 && data[0].password === pass) {
                        p = { username: user, ...data[0].save_data };
                        startGame();
                    } else msg.innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å!";
                } catch(e) { msg.innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å —Ç–∞–±–ª–∏—Ü—É 'users'!"; }
            }
        }

        function startGame() {
            document.getElementById('scr-auth').classList.remove('active');
            document.getElementById('scr-game').classList.add('active');
            document.getElementById('ui-name').innerText = p.username;
            addLog("–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, " + p.username);
            move(p.loc || 'town');
            setInterval(saveToCloud, 30000); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        }

        async function saveToCloud() {
            if(!p.username || isWorking) return;
            await sbFetch('PATCH', { save_data: p });
            console.log("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
        }

        function move(k) {
            if(isWorking) return;
            p.loc = k;
            const world = {
                'town': { n: '–ì–æ—Ä–æ–¥', paths: ['forest', 'mine'], acts: [{t: 'üõå –û—Ç–¥—ã—Ö (5üí∞)', f: 'rest'}] },
                'forest': { n: '–ì—É—Å—Ç–æ–π –õ–µ—Å', paths: ['town'], acts: [{t: 'ü™ì –†—É–±–∏—Ç—å –¥–µ—Ä–µ–≤–æ (10—Å)', f: 'work', arg: 'wood'}] },
                'mine': { n: '–ì–ª—É–±–æ–∫–∞—è –®–∞—Ö—Ç–∞', paths: ['town'], acts: [{t: '‚õèÔ∏è –î–æ–±—ã–≤–∞—Ç—å –∂–µ–ª–µ–∑–æ (30—Å)', f: 'work', arg: 'iron'}] }
            };
            const l = world[k];
            document.getElementById('loc-name').innerText = l.n;
            
            const nB = document.getElementById('nav-btns'); nB.innerHTML = '';
            l.paths.forEach(pk => {
                let b = document.createElement('button'); b.innerText = `‚û° ${world[pk].n}`;
                b.onclick = () => move(pk); nB.appendChild(b);
            });

            const aB = document.getElementById('act-btns'); aB.innerHTML = '';
            l.acts.forEach(a => {
                let b = document.createElement('button'); b.innerText = a.t;
                b.onclick = () => window[a.f](a.arg); aB.appendChild(b);
            });
            updateUI();
        }

        window.work = (type) => {
            if(p.nrg < 10) return addLog("‚ùå –í—ã —Å–ª–∏—à–∫–æ–º —É—Å—Ç–∞–ª–∏!");
            isWorking = true; p.nrg -= 10;
            const time = type === 'wood' ? 10000 : 30000;
            document.getElementById('work-ui').style.display = 'flex';
            
            let start = Date.now();
            let timer = setInterval(() => {
                let proc = ((Date.now() - start) / time) * 100;
                document.getElementById('work-fill').style.width = proc + "%";
                if(proc >= 100) {
                    clearInterval(timer); isWorking = false;
                    p[type]++; 
                    document.getElementById('work-ui').style.display = 'none';
                    addLog(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ: 1 ${type === 'wood' ? '–¥–µ—Ä–µ–≤–æ' : '–∂–µ–ª–µ–∑–æ'}`); 
                    move(p.loc);
                }
            }, 100);
            updateUI();
        };

        window.rest = () => {
            if(p.g >= 5) { p.g -= 5; p.nrg = 50; p.hp = 100; addLog("üõå –í—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ —Å–∏–ª—ã!"); }
            else addLog("‚ùå –ú–∞–ª–æ –∑–æ–ª–æ—Ç–∞!");
            updateUI();
        };

        function addLog(m) {
            const l = document.getElementById('log'); l.innerHTML += `<div>${m}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        function updateUI() {
            document.getElementById('gold').innerText = p.g;
            document.getElementById('hp-fill').style.width = p.hp + "%";
            document.getElementById('nrg-fill').style.width = (p.nrg/50*100) + "%";
        }

        function saveAndExit() { 
            saveToCloud().then(() => location.reload()); 
        }
    </script>
</body>
</html>
