<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TSCHORNI RPG</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #ffcc00; --hp: #ff4444; --st: #00ff88; --bg: #000; --box: #1a1a1a; --border: #333; }
        body { background: var(--bg); color: #eee; font-family: sans-serif; margin: 0; padding: 10px; user-select: none; }
        .box { background: var(--box); padding: 12px; border-radius: 12px; border: 1px solid var(--border); max-width: 500px; margin: 8px auto; }
        
        /* –°—Ç–∞—Ç—ã –∏ –†–µ—Å—É—Ä—Å—ã */
        .res-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 10px; }
        .res-item { background: #111; padding: 8px 2px; border-radius: 8px; text-align: center; color: var(--gold); font-size: 11px; border: 1px solid #222; }
        
        .bar-bg { width: 100%; height: 20px; background: #222; border-radius: 10px; margin: 5px 0; overflow: hidden; position: relative; border: 1px solid #444; }
        .bar-fill { height: 100%; transition: width 0.5s; width: 0%; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 10px; font-weight: bold; line-height: 20px; color: #fff; z-index: 2; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .tabs { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin: 10px 0; }
        .tab-btn { padding: 10px 2px; background: #333; border: none; color: #aaa; border-radius: 6px; cursor: pointer; font-size: 10px; font-weight: bold; }
        .tab-active { background: var(--gold); color: #000; }

        .btn { width: 100%; padding: 12px; background: var(--gold); color: #000; border: none; border-radius: 8px; font-weight: bold; margin-top: 5px; cursor: pointer; font-size: 12px; }
        .btn-sell { background: #222; color: var(--gold); border: 1px solid var(--gold); font-size: 11px; padding: 8px; }

        /* –ß–∞—Ç –∏ –°–ø–∏—Å–∫–∏ */
        .main-container { display: flex; gap: 8px; height: 180px; }
        .side-box { width: 110px; background: #111; border-radius: 8px; padding: 8px; font-size: 10px; border: 1px solid var(--border); overflow-y: auto; }
        .chat-box { flex: 1; background: #111; border-radius: 8px; display: flex; flex-direction: column; border: 1px solid var(--border); }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 8px; font-size: 11px; text-align: left; }
        #chat-in { background: #222; border: none; color: #fff; padding: 10px; outline: none; border-top: 1px solid var(--border); }

        /* –°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ */
        .equip-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .slot { background: #111; border: 1px solid #444; padding: 8px; border-radius: 6px; font-size: 10px; }
        .slot b { color: var(--gold); display: block; margin-bottom: 2px; }

        #log { background: #111; padding: 10px; height: 70px; overflow-y: auto; font-size: 11px; color: #888; border-radius: 8px; margin-top: 10px; border: 1px solid #222; text-align: left; }
        .online-user { margin-bottom: 4px; padding-bottom: 2px; border-bottom: 1px solid #222; }
    </style>
</head>
<body>

<div id="game-ui" style="display: none;">
    <div class="box">
        <div class="res-grid">
            <div class="res-item">üí∞ <span id="res-gold">0</span></div>
            <div class="res-item">üå≤ <span id="res-wood">0</span></div>
            <div class="res-item">‚õèÔ∏è <span id="res-iron">0</span></div>
            <div class="res-item">‚¨õ <span id="res-coal">0</span></div>
        </div>
        <div class="bar-bg"><div class="bar-text" id="hp-text">HP: 0/0</div><div id="hp-fill" class="bar-fill" style="background: var(--hp);"></div></div>
        <div class="bar-bg"><div class="bar-text" id="st-text">ST: 0/0</div><div id="st-fill" class="bar-fill" style="background: var(--st);"></div></div>
    </div>

    <div class="tabs">
        <button id="t-world" class="tab-btn tab-active" onclick="setTab('world')">–ú–ò–†</button>
        <button id="t-mine" class="tab-btn" onclick="setTab('mine')">–î–û–ë–´–ß–ê</button>
        <button id="t-craft" class="tab-btn" onclick="setTab('craft')">–ö–£–ó–ù–Ø</button>
        <button id="t-hero" class="tab-btn" onclick="setTab('hero')">–ì–ï–†–û–ô</button>
        <button id="t-shop" class="tab-btn" onclick="setTab('shop')">–†–´–ù–û–ö</button>
    </div>

    <div id="tab-content"></div>

    <div class="box main-container">
        <div class="side-box">
            <div style="color:#666; margin-bottom:4px">–õ–û–ö–ê–¶–ò–Ø:</div>
            <div id="cur-loc-display" style="color:var(--gold); font-weight:bold; margin-bottom:10px;">-</div>
            <div style="color:#666; margin-bottom:4px">–ó–î–ï–°–¨:</div>
            <div id="online-list"></div>
        </div>
        <div class="chat-box">
            <div id="chat-msgs"></div>
            <input type="text" id="chat-in" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å..." onkeypress="if(event.key==='Enter') sendChat()">
        </div>
    </div>
    <div id="log"></div>
</div>

<div id="auth-ui">
    <div class="box" style="margin-top: 50px; text-align: center;">
        <h2 style="color: var(--gold)">TSCHORNI RPG</h2>
        <input type="text" id="u_nick" placeholder="–ù–ò–ö–ù–ï–ô–ú" style="width:80%; padding:12px; margin:5px; background:#111; border:1px solid #444; color:#fff; border-radius:8px;">
        <input type="password" id="u_pass" placeholder="–ü–ê–†–û–õ–¨" style="width:80%; padding:12px; margin:5px; background:#111; border:1px solid #444; color:#fff; border-radius:8px;">
        <button class="btn" onclick="auth('login')">–ò–ì–†–ê–¢–¨</button>
        <button class="btn" onclick="auth('reg')" style="background:none; color:var(--gold); border:1px solid var(--gold);">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
    </div>
</div>

<script>
    const S_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co";
    const S_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";
    const sb = window.supabase.createClient(S_URL, S_KEY);

    let user = null, data = {}, currentTab = 'world', isBusy = false;

    async function auth(mode) {
        const n = document.getElementById('u_nick').value.trim();
        const p = document.getElementById('u_pass').value.trim();
        if(!n || !p) return;
        if(mode === 'reg') {
            await sb.from('users').insert({ 
                username: n, email_hidden: p, current_hp: 150, stamina: 125, gold: 100, 
                str: 5, vit: 5, wood: 0, iron: 0, coal: 0, location: '–õ–∞–≥–µ—Ä—å', 
                equip: { h: "–ù–µ—Ç", b: "–¢–∫–∞–Ω—å", w: "–ö—É–ª–∞–∫–∏", r1: "–ù–µ—Ç", r2: "–ù–µ—Ç", l: "–ù–µ—Ç", s: "–ù–µ—Ç", a: "–ù–µ—Ç", p: "–ù–µ—Ç", t: "–ù–µ—Ç" } 
            });
            alert("–ì–µ—Ä–æ–π —Å–æ–∑–¥–∞–Ω!");
        } else {
            const { data: u } = await sb.from('users').select('*').eq('username', n).single();
            if(u && u.email_hidden === p) {
                user = n; data = u;
                document.getElementById('auth-ui').style.display = 'none';
                document.getElementById('game-ui').style.display = 'block';
                startApp();
            } else alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞!");
        }
    }

    function startApp() {
        updateUI();
        setTab('world');
        setInterval(regen, 2000);
        setInterval(save, 5000);
        setInterval(updateOnline, 4000);
        initChat();
    }

    function updateUI() {
        if(!data.stamina && data.stamina !== 0) data.stamina = 125;
        const mHp = 100 + (data.vit * 10);
        const mSt = 100 + (data.str * 5);
        
        document.getElementById('hp-text').innerText = `HP: ${Math.floor(data.current_hp)} / ${mHp}`;
        document.getElementById('hp-fill').style.width = (data.current_hp / mHp * 100) + '%';
        document.getElementById('st-text').innerText = `ST: ${Math.floor(data.stamina)} / ${mSt}`;
        document.getElementById('st-fill').style.width = (data.stamina / mSt * 100) + '%';
        
        document.getElementById('res-gold').innerText = Math.floor(data.gold);
        document.getElementById('res-wood').innerText = data.wood;
        document.getElementById('res-iron').innerText = data.iron;
        document.getElementById('res-coal').innerText = data.coal;
        document.getElementById('cur-loc-display').innerText = data.location;
    }

    function setTab(t) {
        currentTab = t;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
        document.getElementById('t-'+t).classList.add('tab-active');
        const cont = document.getElementById('tab-content');

        if(t === 'world') {
            cont.innerHTML = `<div class="box">
                <button class="btn" onclick="action('travel', '–õ–µ—Å', 4000)">üå≤ –í –õ–ï–°</button>
                <button class="btn" onclick="action('travel', '–®–∞—Ö—Ç–∞', 6000)">‚õèÔ∏è –í –®–ê–•–¢–£</button>
                <button class="btn" onclick="action('travel', '–õ–∞–≥–µ—Ä—å', 2000)" style="background:#444; color:#fff;">üõñ –í –õ–ê–ì–ï–†–¨</button>
            </div>`;
        } else if(t === 'mine') {
            cont.innerHTML = `<div class="box">
                <p style="text-align:center">${data.location === '–õ–∞–≥–µ—Ä—å' ? '–ó–¥–µ—Å—å –Ω–µ—á–µ–≥–æ –¥–æ–±—ã–≤–∞—Ç—å' : '–ú–æ–∂–Ω–æ –¥–æ–±—ã—Ç—å —Ä–µ—Å—É—Ä—Å—ã'}</p>
                <button class="btn" onclick="action('mine', '${data.location}', 3000)" ${data.location === '–õ–∞–≥–µ—Ä—å' ? 'disabled' : ''}>–ù–ê–ß–ê–¢–¨ –î–û–ë–´–ß–£ (-20 ST)</button>
            </div>`;
        } else if(t === 'hero') {
            const e = data.equip;
            cont.innerHTML = `<div class="box equip-grid">
                <div class="slot"><b>–ì–æ–ª–æ–≤–∞</b>${e.h}</div> <div class="slot"><b>–û—Ä—É–∂–∏–µ</b>${e.w}</div>
                <div class="slot"><b>–¢–µ–ª–æ</b>${e.b}</div> <div class="slot"><b>–©–∏—Ç/–î–æ–ø</b>${e.s}</div>
                <div class="slot"><b>–ù–æ–≥–∏</b>${e.l}</div> <div class="slot"><b>–®–µ—è</b>${e.a}</div>
                <div class="slot"><b>–ö–æ–ª—å—Ü–æ 1</b>${e.r1}</div> <div class="slot"><b>–ö–æ–ª—å—Ü–æ 2</b>${e.r2}</div>
                <div class="slot"><b>–ü–æ—è—Å</b>${e.p}</div> <div class="slot"><b>–ü–ª–∞—â</b>${e.t}</div>
            </div>`;
        } else if(t === 'shop') {
            cont.innerHTML = `<div class="box">
                <button class="btn btn-sell" onclick="sell('wood', 5)">–ü–†–û–î–ê–¢–¨ –î–ï–†–ï–í–û (5üí∞)</button>
                <button class="btn btn-sell" onclick="sell('iron', 15)">–ü–†–û–î–ê–¢–¨ –ñ–ï–õ–ï–ó–û (15üí∞)</button>
                <button class="btn btn-sell" onclick="sell('coal', 10)">–ü–†–û–î–ê–¢–¨ –£–ì–û–õ–¨ (10üí∞)</button>
            </div>`;
        } else if(t === 'craft') {
            cont.innerHTML = `<div class="box">
                <p style="font-size:11px">–ñ–µ–ª–µ–∑–Ω—ã–π –º–µ—á (20 –î–µ—Ä–µ–≤–∞, 50 –ñ–µ–ª–µ–∑–∞)</p>
                <button class="btn" onclick="craft('–ú–µ—á', {wood:20, iron:50})">–°–ö–†–ê–§–¢–ò–¢–¨</button>
            </div>`;
        }
    }

    function action(type, target, time) {
        if(isBusy || (type === 'mine' && data.stamina < 20)) return;
        isBusy = true;
        let start = Date.now();
        let timer = setInterval(() => {
            let p = (Date.now() - start) / time * 100;
            if(p >= 100) {
                clearInterval(timer);
                isBusy = false;
                if(type === 'travel') data.location = target;
                else {
                    data.stamina -= 20;
                    let r = data.location === '–õ–µ—Å' ? 'wood' : 'iron';
                    if(Math.random() > 0.7) data.coal++;
                    data[r]++;
                }
                updateUI(); setTab(currentTab);
            }
        }, 50);
    }

    function sell(res, price) {
        if(data[res] > 0) {
            data[res]--;
            data.gold += price;
            addLog(`–ü—Ä–æ–¥–∞–Ω–æ: ${res} –∑–∞ ${price}üí∞`);
            updateUI();
        }
    }

    function regen() {
        if(isBusy) return;
        const mSt = 100 + (data.str * 5);
        if(data.stamina < mSt) data.stamina = Math.min(mSt, data.stamina + 2);
        updateUI();
    }

    async function save() { if(user) await sb.from('users').update(data).eq('username', user); }

    async function updateOnline() {
        const { data: users } = await sb.from('users').select('username, location, last_seen');
        const active = users.filter(u => u.location === data.location && (new Date() - new Date(u.last_seen)) < 30000);
        document.getElementById('online-list').innerHTML = active.map(u => `<div class="online-user">${u.username === user ? '<b style="color:var(--st)">' + u.username + ' (–í–´)</b>' : u.username}</div>`).join('');
    }

    function addLog(m) {
        const l = document.getElementById('log');
        l.innerHTML = `<div><span style="color:#555">${new Date().toLocaleTimeString()}</span> ${m}</div>` + l.innerHTML;
    }

    async function initChat() {
        sb.channel('rpg_chat').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => {
            document.getElementById('chat-msgs').innerHTML += `<div><b>${p.new.user}:</b> ${p.new.text}</div>`;
            document.getElementById('chat-msgs').scrollTop = 9999;
        }).subscribe();
    }

    async function sendChat() {
        const ci = document.getElementById('chat-in');
        if(!ci.value.trim()) return;
        await sb.from('messages').insert({ user: user, text: ci.value });
        ci.value = '';
    }
</script>
</body>
</html>
