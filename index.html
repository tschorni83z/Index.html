<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TSCHORNI: MOB HUNTER</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #ffcc00; --hp: #ff4444; --st: #00ff88; --mp: #4488ff; --bg: #0d0d0d; --box: #1a1a1a; --border: #333; }
        body { background: var(--bg); color: #ddd; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 5px; user-select: none; font-size: 14px; }
        .box { background: var(--box); padding: 10px; border-radius: 8px; border: 1px solid var(--border); margin: 5px auto; max-width: 500px; }
        
        .bar-bg { width: 100%; height: 18px; background: #222; border-radius: 4px; margin: 3px 0; overflow: hidden; position: relative; border: 1px solid #444; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 10px; font-weight: bold; line-height: 18px; color: #fff; z-index: 2; text-shadow: 1px 1px #000; }

        .tabs { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; margin: 10px 0; }
        .tab-btn { padding: 10px 2px; background: #222; border: 1px solid #444; color: #888; font-size: 9px; border-radius: 4px; cursor: pointer; }
        .tab-active { background: var(--gold); color: #000; font-weight: bold; border-color: var(--gold); }
        .btn { background: var(--gold); color: #000; border: none; padding: 10px; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%; margin: 5px 0; }
        
        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
        th, td { border: 1px solid #333; padding: 5px; text-align: center; }
        th { background: #222; color: var(--gold); }

        .mob-box { background: #200; border: 1px solid #800; padding: 10px; border-radius: 6px; text-align: center; margin-bottom: 10px; }
        #log { height: 80px; overflow-y: auto; font-size: 10px; color: #aaa; background: #000; padding: 5px; border-top: 1px solid #222; }
    </style>
</head>
<body>

<div id="auth-ui">
    <div class="box" style="margin-top: 40px; text-align: center;">
        <h2 style="color: var(--gold)">TSCHORNI: REBORN</h2>
        <input type="text" id="u_nick" placeholder="ĞĞ˜ĞšĞĞ•Ğ™Ğœ (Ğ±ĞµĞ· Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ğ¾Ğ²)" style="width:85%; padding:12px; margin:5px; background:#111; border:1px solid #333; color:#fff;">
        <input type="password" id="u_pass" placeholder="ĞŸĞĞ ĞĞ›Ğ¬" style="width:85%; padding:12px; margin:5px; background:#111; border:1px solid #333; color:#fff;">
        <button class="btn" onclick="auth('login')">Ğ’ĞĞ™Ğ¢Ğ˜</button>
        <button class="btn" onclick="auth('reg')" style="background:none; border:1px solid var(--gold); color:var(--gold);">Ğ¡ĞĞ—Ğ”ĞĞ¢Ğ¬ Ğ“Ğ•Ğ ĞĞ¯</button>
        <div id="auth-msg" style="margin-top:10px; font-size:12px; color:#aaa; min-height:1.5em;"></div>
    </div>
</div>

<div id="game-ui" style="display: none;">
    <div class="box">
        <div style="display:flex; justify-content: space-between; font-size: 12px; color: var(--gold); margin-bottom: 5px;">
            <span>Ğ£Ğ ĞĞ’Ğ•ĞĞ¬: <b id="r-lvl">1</b></span>
            <span>Ğ—ĞĞ›ĞĞ¢Ğ: <b id="r-gold">0</b>ğŸ’°</span>
        </div>
        <div class="bar-bg"><div class="bar-text" id="hp-txt">HP</div><div id="hp-f" class="bar-fill" style="background:var(--hp);"></div></div>
        <div class="bar-bg"><div class="bar-text" id="st-txt">ST</div><div id="st-f" class="bar-fill" style="background:var(--st);"></div></div>
    </div>

    <div class="tabs">
        <button class="tab-btn tab-active" id="t-world" onclick="setTab('world')">ĞœĞ˜Ğ </button>
        <button class="tab-btn" id="t-fight" onclick="setTab('fight')">ĞĞ¥ĞĞ¢Ğ</button>
        <button class="tab-btn" id="t-inv" onclick="setTab('inv')">Ğ“Ğ•Ğ ĞĞ™</button>
        <button class="tab-btn" id="t-shop" onclick="setTab('shop')">Ğ Ğ«ĞĞĞš</button>
        <button class="tab-btn" id="t-stat" onclick="setTab('stat')">Ğ¢ĞĞŸ</button>
    </div>

    <div id="tab-content" class="box" style="min-height: 220px;"></div>
    <div id="log" class="box"></div>
</div>

<script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ĞšĞĞĞ¤Ğ˜Ğ“ Ğ˜ Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const S_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co";
    const S_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";  // â† Ñ‚Ğ²Ğ¾Ğ¹ Ğ°Ğ½Ğ¾Ğ½ ĞºĞ»ÑÑ‡

    let sb = null;
    let userData = null;
    let enemy = null;
    let curTab = 'world';
    let saveTimer = null;
    let isAuthInProgress = false;

    // Ğ–Ğ´Ñ‘Ğ¼ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸
    function initSupabase() {
        if (typeof supabase === 'undefined') {
            document.getElementById('auth-msg').innerHTML = 'ĞÑˆĞ¸Ğ±ĞºĞ°: Supabase Ğ½Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ğ»ÑÑ. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚ Ğ¸ CDN.';
            console.error('supabase global Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½');
            return false;
        }

        sb = supabase.createClient(S_URL, S_KEY);
        console.log('Supabase Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½');
        return true;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ĞĞ’Ğ¢ĞĞ Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function auth(mode) {
        if (isAuthInProgress) return;
        isAuthInProgress = true;

        const msgEl = document.getElementById('auth-msg');
        msgEl.innerHTML = 'ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ...';

        if (!sb) {
            if (!initSupabase()) {
                msgEl.innerHTML = 'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Supabase';
                isAuthInProgress = false;
                return;
            }
        }

        const nick = (document.getElementById('u_nick').value || '').trim();
        const pass = document.getElementById('u_pass').value;

        if (!nick || nick.length < 3 || nick.includes(' ')) {
            msgEl.innerHTML = "ĞĞ¸Ğº: Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 3 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°, Ğ±ĞµĞ· Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ğ¾Ğ²";
            isAuthInProgress = false;
            return;
        }
        if (!pass || pass.length < 6) {
            msgEl.innerHTML = "ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²";
            isAuthInProgress = false;
            return;
        }

        const email = nick.toLowerCase() + "@tschorni.game";

        try {
            if (mode === 'reg') {
                const { data, error } = await sb.auth.signUp({
                    email,
                    password: pass,
                    options: { data: { username: nick } }
                });

                if (error) throw error;
                msgEl.innerHTML = "Ğ“ĞµÑ€Ğ¾Ğ¹ ÑĞ¾Ğ·Ğ´Ğ°Ğ½! Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ.";
            } else {
                const { data: { session }, error } = await sb.auth.signInWithPassword({
                    email,
                    password: pass
                });

                if (error) throw error;
                await loadPlayerData();
            }
        } catch (err) {
            msgEl.innerHTML = "ĞÑˆĞ¸Ğ±ĞºĞ°: " + (err.message || "Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°");
            console.error(err);
        } finally {
            isAuthInProgress = false;
        }
    }

    async function loadPlayerData() {
        if (!sb) return;

        const { data: { user } } = await sb.auth.getUser();
        if (!user) {
            addLog("ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ ÑĞµÑÑĞ¸Ğ¸");
            return;
        }

        const username = user.user_metadata?.username;
        if (!username) {
            addLog("ĞĞ¸ĞºĞ½ĞµĞ¹Ğ¼ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ");
            return;
        }

        const { data, error } = await sb
            .from('users')
            .select('*')
            .eq('username', username)
            .single();

        if (error || !data) {
            // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ°
            const initial = {
                username,
                current_hp: 150,
                stamina: 100,
                gold: 200,
                str: 5,
                vit: 5,
                agi: 5,
                int: 5,
                exp: 0,
                level: 1,
                location: 'Ğ›Ğ°Ğ³ĞµÑ€ÑŒ',
                inventory: [{name:'Ğ Ğ¶Ğ°Ğ²Ñ‹Ğ¹ Ğ½Ğ¾Ğ¶', str:2, icon:'ğŸ”ª'}, {name:'Ğ¢Ñ€ÑĞ¿ĞºĞ¸', vit:2, icon:'ğŸ‘•'}]
            };

            const { error: insErr } = await sb.from('users').insert(initial);
            if (insErr) {
                addLog("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ°: " + insErr.message);
                return;
            }
            userData = initial;
        } else {
            userData = data;
        }

        document.getElementById('auth-ui').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        startApp();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ĞĞ¡ĞĞĞ’ĞĞĞ™ Ğ¦Ğ˜ĞšĞ› Ğ˜Ğ“Ğ Ğ« (Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ĞºĞ¾Ğ´ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startApp() {
        updateUI();
        setTab('world');

        if (saveTimer) clearInterval(saveTimer);
        saveTimer = setInterval(saveData, 10000);

        setInterval(tick, 2000);
    }

    async function saveData() {
        if (!userData || !sb) return;
        const { error } = await sb.from('users').update(userData).eq('username', userData.username);
        if (!error) addLog("Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾");
    }

    function updateUI() {
        if (!userData) return;

        const maxHp = 100 + userData.vit * 10;
        const maxSt = 100 + userData.str * 5;

        document.getElementById('r-lvl').innerText  = userData.level;
        document.getElementById('r-gold').innerText = Math.floor(userData.gold);

        setBar('hp', userData.current_hp, maxHp);
        setBar('st', userData.stamina,   maxSt);
    }

    function setBar(id, cur, max) {
        const perc = Math.max(0, Math.min(100, cur / max * 100));
        document.getElementById(`${id}-txt`).innerText = `${id.toUpperCase()}: ${Math.floor(cur)}/${max}`;
        document.getElementById(`${id}-f`).style.width = perc + '%';
    }

    // ... (Ğ²ĞµÑÑŒ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ĞºĞ¾Ğ´: setTab, renderFight, spawnEnemy, attack, checkLevelUp, renderHero, travel, buyPot, tick, addLog Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹)

    // Ğ’ÑÑ‚Ğ°Ğ²ÑŒ ÑÑĞ´Ğ° Ğ²ĞµÑÑŒ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¸Ğ³Ñ€Ğ¾Ğ²Ğ¾Ğ¹ ĞºĞ¾Ğ´ Ğ¸Ğ· Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Ğ—ĞĞŸĞ£Ğ¡Ğš ĞŸĞ Ğ˜ Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ• Ğ¡Ğ¢Ğ ĞĞĞ˜Ğ¦Ğ«
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.addEventListener('load', () => {
        if (initSupabase()) {
            sb.auth.onAuthStateChange(async (event, session) => {
                if (session) {
                    await loadPlayerData();
                } else {
                    document.getElementById('auth-ui').style.display = 'block';
                    document.getElementById('game-ui').style.display = 'none';
                }
            });

            // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ÑƒÑ ÑĞµÑÑĞ¸Ñ
            sb.auth.getSession().then(({ data: { session } }) => {
                if (session) loadPlayerData();
            });
        }
    });
</script>
</body>
</html>
