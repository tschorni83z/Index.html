<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–ò–† –¢–¨–ú–´</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #080808; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; padding: 5px; }
        .box { background: #121212; padding: 12px; border-radius: 12px; border: 1px solid #2a2a2a; max-width: 450px; margin: 8px auto; }
        .btn { width: 100%; padding: 12px; background: #ffcc00; color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; transition: 0.2s; }
        .btn:disabled { background: #222; color: #555; }
        .tabs { display: flex; gap: 4px; margin-bottom: 8px; overflow-x: auto; white-space: nowrap; padding-bottom: 5px; }
        .tab-btn { padding: 10px 15px; background: #1a1a1a; color: #777; border: 1px solid #333; border-radius: 6px; font-size: 11px; cursor: pointer; }
        .tab-active { background: #ffcc00; color: #000; font-weight: bold; border-color: #ffcc00; }
        
        .bar-container { width: 100%; height: 10px; background: #222; border-radius: 5px; margin: 4px 0; overflow: hidden; border: 1px solid #333; }
        .hp-fill { height: 100%; background: #cc3333; transition: 0.3s; }
        .st-fill { height: 100%; background: #33cc33; transition: 0.3s; }
        
        .inv-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 10px; }
        .inv-slot { background: #000; border: 1px solid #333; aspect-ratio: 1/1; border-radius: 4px; font-size: 9px; display: flex; align-items: center; justify-content: center; position: relative; }
        .durability { position: absolute; bottom: 1px; right: 1px; font-size: 7px; color: #ff4444; }
        
        #log { background: #000; border: 1px solid #222; padding: 8px; height: 90px; overflow-y: auto; font-size: 11px; text-align: left; color: #888; border-radius: 6px; margin-top: 8px; }
    </style>
</head>
<body>

<div id="game-container">
    <h1 style="color: #ffcc00;">–ú–ò–† –¢–¨–ú–´</h1>
    <div class="box">
        <input type="text" id="u_nick" placeholder="–ù–ò–ö–ù–ï–ô–ú" style="width:85%; padding:10px; margin-bottom:8px; background:#000; border:1px solid #333; color:#fff;">
        <input type="password" id="u_pass" placeholder="–ü–ê–†–û–õ–¨" style="width:85%; padding:10px; background:#000; border:1px solid #333; color:#fff;">
        <button class="btn" onclick="auth('login')">–í–û–ô–¢–ò</button>
        <button class="btn" style="background:none; color:#ffcc00; border:1px solid #ffcc00; margin-top:8px;" onclick="auth('reg')">–°–û–ó–î–ê–¢–¨ –ì–ï–†–û–Ø</button>
    </div>
</div>

<script>
    const S_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co";
    const S_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";
    const sb = window.supabase.createClient(S_URL, S_KEY);

    let user, data = {}, isBusy = false, currentTab = 'mine';

    async function auth(mode) {
        const n = document.getElementById('u_nick').value.trim();
        const p = document.getElementById('u_pass').value.trim();
        if(mode === 'reg') {
            await sb.from('users').insert({ id: crypto.randomUUID(), username: n, email_hidden: p, equip: { weapon: '–†–∂–∞–≤—ã–π –Ω–æ–∂', tool: '–°—Ç–∞—Ä–∞—è –∫–∏—Ä–∫–∞' }, durability: { weapon: 100, tool: 100 } });
            alert("–ì–µ—Ä–æ–π —Å–æ–∑–¥–∞–Ω!");
        } else {
            const { data: u } = await sb.from('users').select('*').eq('username', n).single();
            if (u && u.email_hidden === p) {
                user = n; data = u;
                localStorage.setItem('rpg_user', n);
                localStorage.setItem('rpg_pass', p);
                renderGame(); setInterval(regen, 30000);
            } else alert("–û—à–∏–±–∫–∞!");
        }
    }

    function renderGame() {
        const maxHp = 100 + (data.vit * 10);
        const maxSt = 100 + (data.str * 5);
        document.getElementById('game-container').innerHTML = `
            <div class="box">
                <div style="display:flex; justify-content:space-between; font-size:11px;">
                    <span>‚ù§Ô∏è HP: ${data.current_hp}/${maxHp}</span>
                    <span>üîã ST: ${data.stamina}/${maxSt}</span>
                    <span>üí∞ ${data.gold}</span>
                </div>
                <div class="bar-container"><div class="hp-fill" style="width:${(data.current_hp/maxHp)*100}%"></div></div>
                <div class="bar-container"><div class="st-fill" style="width:${(data.stamina/maxSt)*100}%"></div></div>
            </div>

            <div class="tabs">
                <button class="tab-btn ${currentTab==='mine'?'tab-active':''}" onclick="setTab('mine')">–õ–û–ö–ê–¶–ò–ò</button>
                <button class="tab-btn ${currentTab==='inv'?'tab-active':''}" onclick="setTab('inv')">–ò–ù–í–ï–ù–¢–ê–†–¨</button>
                <button class="tab-btn ${currentTab==='craft'?'tab-active':''}" onclick="setTab('craft')">–ö–£–ó–ù–ò–¶–ê</button>
                <button class="tab-btn ${currentTab==='shop'?'tab-active':''}" onclick="setTab('shop')">–ú–ê–ì–ê–ó–ò–ù</button>
            </div>
            <div id="tab-content">${renderTab()}</div>
            <div id="log">...</div>
        `;
    }

    function renderTab() {
        if(currentTab === 'mine') return `
            <div class="box">
                <h3>–î–û–ë–´–ß–ê</h3>
                <button class="btn" onclick="mine('wood')" ${isBusy?'disabled':''}>–†–£–ë–ò–¢–¨ –õ–ï–° (-15 ST)</button>
                <button class="btn" onclick="mine('iron')" ${isBusy?'disabled':''}>–î–û–ë–´–í–ê–¢–¨ –†–£–î–£ (-20 ST)</button>
            </div>`;
        if(currentTab === 'inv') {
            let eq = data.equip || {};
            let dur = data.durability || {};
            return `<div class="box">
                <h3>–°–ù–ê–†–Ø–ñ–ï–ù–ò–ï</h3>
                <div class="inv-grid">
                    <div class="inv-slot">üß§<br>${eq.gloves || '–ü—É—Å—Ç–æ'}</div>
                    <div class="inv-slot">ü™ñ<br>${eq.helmet || '–ü—É—Å—Ç–æ'}</div>
                    <div class="inv-slot">üß•<br>${eq.body || '–ü—É—Å—Ç–æ'}</div>
                    <div class="inv-slot">‚öîÔ∏è<br>${eq.weapon || '–†—É–∫–∏'}<span class="durability">${dur.weapon||0}%</span></div>
                    <div class="inv-slot">‚õèÔ∏è<br>${eq.tool || '–ü—É—Å—Ç–æ'}<span class="durability">${dur.tool||0}%</span></div>
                    <div class="inv-slot">üëñ<br>${eq.belt || '–ü—É—Å—Ç–æ'}</div>
                    <div class="inv-slot">üë¢<br>${eq.boots || '–ü—É—Å—Ç–æ'}</div>
                    <div class="inv-slot">üíç<br>–ö–æ–ª—å—Ü–æ</div>
                </div>
                <button class="btn" onclick="logout()" style="background:#333; color:#eee; margin-top:10px;">–í–´–ô–¢–ò</button>
            </div>`;
        }
        if(currentTab === 'craft') return `
            <div class="box">
                <h3>–ö–£–ó–ù–Ø</h3>
                <div style="font-size:11px; text-align:left;">
                    ‚öíÔ∏è <b>–°—Ç–∞–ª—å–Ω–æ–π –®–ª–µ–º</b> (50 –°—Ç–∞–ª–∏, 1000üí∞)<br>
                    ‚öíÔ∏è <b>–ö–∏—Ä–∞—Å–∞ –¢—å–º—ã</b> (100 –°—Ç–∞–ª–∏, 5000üí∞)
                </div>
                <button class="btn" onclick="craft('dark_plate')">–°–ö–†–ê–§–¢–ò–¢–¨ –ö–ò–†–ê–°–£</button>
            </div>`;
        return `<div class="box"><h3>–ú–ê–ì–ê–ó–ò–ù</h3><button class="btn" onclick="repair()">–ü–û–ß–ò–ù–ò–¢–¨ –í–°–Å (100üí∞)</button></div>`;
    }

    async function mine(res) {
        let cost = res === 'wood' ? 15 : 20;
        if(data.stamina < cost) return alert("–í—ã —É—Å—Ç–∞–ª–∏!");
        if(data.durability.tool <= 0) return alert("–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–ª–æ–º–∞–Ω!");
        
        isBusy = true; renderGame();
        addLog("–î–æ–±—ã—á–∞...");
        
        setTimeout(async () => {
            data.stamina -= cost;
            data.durability.tool -= 5;
            data[res] = (data[res] || 0) + 1;
            await sb.from('users').update(data).eq('username', user);
            isBusy = false; renderGame();
            addLog(`–ü–æ–ª—É—á–µ–Ω–æ: ${res}. –ü—Ä–æ—á–Ω–æ—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: ${data.durability.tool}%`);
        }, 2000);
    }

    async function repair() {
        if(data.gold < 100) return alert("–ù–µ—Ç –¥–µ–Ω–µ–≥!");
        data.gold -= 100;
        data.durability = { weapon: 100, tool: 100 };
        await sb.from('users').update(data).eq('username', user);
        renderGame();
        addLog("–°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ –ø–æ—á–∏–Ω–µ–Ω–æ!");
    }

    function addLog(m) { const l = document.getElementById('log'); if(l) l.innerHTML = `> ${m}<br>` + l.innerHTML; }
    function setTab(t) { currentTab = t; renderGame(); }
    function logout() { localStorage.clear(); location.reload(); }

    async function regen() {
        const maxHp = 100 + (data.vit * 10);
        const maxSt = 100 + (data.str * 5);
        if(data.current_hp < maxHp) data.current_hp += 2;
        if(data.stamina < maxSt) data.stamina += 5;
        if(user) {
            renderGame();
            await sb.from('users').update({ stamina: data.stamina, current_hp: data.current_hp }).eq('username', user);
        }
    }

    window.onload = async () => {
        const n = localStorage.getItem('rpg_user'), p = localStorage.getItem('rpg_pass');
        if(n && p) {
            const { data: u } = await sb.from('users').select('*').eq('username', n).single();
            if(u && u.email_hidden === p) { user = n; data = u; renderGame(); setInterval(regen, 30000); }
        }
    };
</script>
</body>
</html>
