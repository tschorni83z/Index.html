<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carnage: Craft & Runes</title>
    <style>
        :root { --gold: #f1c40f; --bg: #0a0a0a; --panel: #1a1a1a; --blue: #3498db; --red: #e74c3c; --green: #2ecc71; --stamina: #9b59b6; --border: #333; }
        body { background: var(--bg); color: #ddd; font-family: 'Verdana', sans-serif; margin: 0; padding-bottom: 80px; user-select: none; }
        .header { background: #000; padding: 10px; border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 10; }
        .bar-bg { height: 12px; background: #222; border-radius: 6px; border: 1px solid #444; overflow: hidden; margin: 4px 0; position: relative; }
        .fill { height: 100%; transition: 0.3s; width: 100%; }
        .bar-txt { position: absolute; width: 100%; text-align: center; font-size: 9px; line-height: 12px; font-weight: bold; color: #fff; z-index: 2; }
        
        .content { padding: 10px; }
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 10px; }
        .screen { display: none; } .active { display: block; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        button { padding: 10px; background: #2a2a2a; color: #eee; border: 1px solid #444; border-radius: 5px; font-size: 12px; font-weight: bold; }
        button:active { background: #444; }

        /* –ö—É–∫–ª–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ */
        .char-slots { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .slot { background: #111; border: 1px solid #444; height: 55px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 20px; border-radius: 4px; position: relative; }
        .slot-name { font-size: 8px; color: #666; position: absolute; bottom: 2px; }

        /* –õ–æ–≥ –±–æ—è */
        #log { height: 100px; overflow-y: auto; background: #000; padding: 8px; font-size: 11px; color: #888; border: 1px solid var(--border); margin-bottom: 10px; }
        
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #000; display: flex; border-top: 2px solid var(--border); }
        .nav-item { flex: 1; padding: 12px 0; text-align: center; font-size: 10px; color: #555; }
        .nav-item.active { color: var(--gold); background: #111; }

        .item-card { background: #111; border: 1px solid #333; padding: 8px; border-radius: 4px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .rarity-craft { border-color: var(--stamina); color: var(--stamina); }
    </style>
</head>
<body>

    <div class="header">
        <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--gold); margin-bottom:4px;">
            <b id="ui-nick">–ó–∞–≥—Ä—É–∑–∫–∞...</b>
            <b>üí∞ <span id="gold">0</span></b>
        </div>
        <div class="bar-bg"><div class="bar-txt">‚ù§Ô∏è HP: <span id="hp-val">0/0</span></div><div id="hp-fill" class="fill" style="background:var(--green)"></div></div>
        <div class="bar-bg"><div class="bar-txt">üí™ STAMINA: <span id="st-val">0/0</span></div><div id="st-fill" class="fill" style="background:var(--stamina)"></div></div>
        <div style="text-align:center; font-size:10px; color:#777;">–£—Ä–æ–≤–µ–Ω—å: <span id="ui-lvl">1</span> | –°—Ç–∞—Ç—ã: <b id="ui-pts" style="color:var(--green)">0</b></div>
    </div>

    <div class="content">
        <div id="log"></div>

        <div id="scr-town" class="screen active">
            <div class="grid">
                <button onclick="move('shop')">üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω</button>
                <button onclick="move('craft')">üî® –ö—É–∑–Ω–∏—Ü–∞</button>
                <button onclick="move('runes')">üí† –ê–ª—Ç–∞—Ä—å –†—É–Ω</button>
                <button onclick="move('hospital')">üè• –ë–æ–ª—å–Ω–∏—Ü–∞</button>
                <button onclick="move('gift')">üéÅ –ü–æ–¥–∞—Ä–∫–∏</button>
                <button onclick="move('forest_1')" style="border-color:var(--green)">üå≤ –í –õ–ï–°</button>
            </div>
        </div>

        <div id="scr-shop" class="screen">
            <h4 style="text-align:center; color:var(--gold)">üõí –ú–ê–ì–ê–ó–ò–ù</h4>
            <div id="shop-tabs" style="display:flex; gap:5px; margin-bottom:10px;">
                <button style="flex:1" onclick="renderShop('equip')">–°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</button>
                <button style="flex:1" onclick="renderShop('cons')">–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏</button>
            </div>
            <div id="shop-list"></div>
            <button style="width:100%; margin-top:10px;" onclick="move('town')">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="scr-craft" class="screen panel">
            <h4 style="text-align:center; color:var(--stamina)">üî® –ö–£–ó–ù–ò–¶–ê (–ö–†–ê–§–¢)</h4>
            <div id="craft-list"></div>
            <button style="width:100%; margin-top:10px;" onclick="move('town')">–ù–∞–∑–∞–¥</button>
        </div>

        <div id="scr-char" class="screen">
            <div class="panel">
                <div class="char-slots">
                    <div class="slot" id="sl-head">ü™ñ<span class="slot-name">–ì–æ–ª–æ–≤–∞</span></div>
                    <div class="slot" id="sl-neck">üìø<span class="slot-name">–ê–º—É–ª–µ—Ç</span></div>
                    <div class="slot" id="sl-weapon">‚öîÔ∏è<span class="slot-name">–û—Ä—É–∂–∏–µ</span></div>
                    <div class="slot" id="sl-belt">üéóÔ∏è<span class="slot-name">–ü–æ—è—Å</span></div>
                    <div class="slot" id="sl-ring">üíç<span class="slot-name">–ö–æ–ª—å—Ü–æ</span></div>
                    <div class="slot" id="sl-boots">üëû<span class="slot-name">–û–±—É–≤—å</span></div>
                </div>
                <div id="char-stats"></div>
            </div>
            <div class="panel">
                <h5 style="margin:0 0 5px 0;">üéí –†—é–∫–∑–∞–∫ –∏ –†–µ—Å—É—Ä—Å—ã</h5>
                <div id="inv-res" style="font-size:10px; color:var(--gold); margin-bottom:10px;"></div>
                <div id="inv-list"></div>
            </div>
        </div>

        <div id="scr-battle" class="screen" style="text-align:center;">
            <div class="panel">
                <h3 id="en-name" style="color:var(--red); margin:0;">–í—Ä–∞–≥</h3>
                <div id="en-img" style="font-size:40px;">üëæ</div>
                <div class="bar-bg"><div id="en-hp-fill" class="fill" style="background:var(--red)"></div></div>
                <div style="font-size:12px; margin-top:20px;">–¢–≤–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è:</div>
                <div class="grid">
                    <button onclick="battleHit()">‚öîÔ∏è –£–î–ê–†</button>
                    <button onclick="usePotion()">üß™ –ó–ï–õ–¨–ï</button>
                </div>
            </div>
        </div>

    </div>

    <div class="nav-bar">
        <div class="nav-item active" id="n-town" onclick="move('town')">üèôÔ∏è<br>–ì–æ—Ä–æ–¥</div>
        <div class="nav-item" id="n-wild" onclick="hunt()">‚öîÔ∏è<br>–û—Ö–æ—Ç–∞</div>
        <div class="nav-item" id="n-char" onclick="move('char')">üë§<br>–ì–µ—Ä–æ–π</div>
    </div>

    <script>
        const SB_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co"; 
        const SB_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";

        let p = JSON.parse(localStorage.getItem('save_v3')) || {
            username: "–ò–≥—Ä–æ–∫", hp:100, st:100, gold:200, exp:0, lvl:1, points:5,
            str:5, agi:5, vit:5, int:5,
            equip: { head:null, neck:null, weapon:null, belt:null, ring:null, boots:null },
            inv: [], res: { fang:0, scale:0, rune_shard:0 },
            bank: 0
        };

        const items = {
            'h1': { n: '–ö–æ–∂–∞–Ω—ã–π —à–ª–µ–º', slot:'head', cost:80, st:'vit', v:2 },
            'w1': { n: '–ú–µ—á –ù–æ–≤–∏—á–∫–∞', slot:'weapon', cost:120, st:'str', v:4 },
            'pot_hp': { n: '–ó–µ–ª—å–µ –û–∑–¥–æ—Ä–æ–≤–ª–µ–Ω–∏—è', type:'cons', cost:30, v:50 },
            'w_elite': { n: 'üî• –ú–µ—á –ò–Ω–∫–≤–∏–∑–∏—Ç–æ—Ä–∞', slot:'weapon', craft: {fang:5, scale:2}, st:'str', v:15 }
        };

        const mobs = [
            { n: '–õ–µ—Å–Ω–æ–π –í–æ–ª–∫', i:'üê∫', hp:80, dmg:8, exp:20, g:10, drop:'fang', drChance: 0.5 },
            { n: '–ì–æ—Ä–Ω—ã–π –î—Ä–∞–∫–æ–Ω', i:'üêâ', hp:400, dmg:40, exp:150, g:60, drop:'scale', drChance: 0.2 }
        ];

        let enemy = null;

        function addLog(m) {
            const time = new Intl.DateTimeFormat('ru-RU', {timeZone:'Europe/Berlin', hour:'2-digit', minute:'2-digit', second:'2-digit'}).format(new Date());
            const l = document.getElementById('log');
            l.innerHTML += `<div><span style="color:#555">[${time}]</span> ${m}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        function move(scr) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('scr-' + scr).classList.add('active');
            if(scr === 'shop') renderShop('equip');
            if(scr === 'craft') renderCraft();
            if(scr === 'char') renderChar();
            updateUI();
        }

        function renderShop(type) {
            const list = document.getElementById('shop-list');
            list.innerHTML = '';
            for(let id in items) {
                const it = items[id];
                if(type === 'cons' && it.type !== 'cons') continue;
                if(type === 'equip' && (it.type === 'cons' || it.craft)) continue;
                list.innerHTML += `<div class="item-card">
                    <span>${it.n} (${it.cost}üí∞)</span>
                    <button onclick="buy('${id}')">–ö—É–ø–∏—Ç—å</button>
                </div>`;
            }
        }

        function buy(id) {
            const it = items[id];
            if(p.gold >= it.cost) {
                p.gold -= it.cost;
                if(it.type === 'cons') p.inv.push(id);
                else p.inv.push(id);
                addLog(`–ö—É–ø–ª–µ–Ω–æ: ${it.n}`);
                updateUI(); save();
            }
        }

        function renderCraft() {
            const list = document.getElementById('craft-list');
            list.innerHTML = '';
            for(let id in items) {
                const it = items[id];
                if(!it.craft) continue;
                list.innerHTML += `<div class="item-card rarity-craft">
                    <div><b>${it.n}</b><br><small>–¢—Ä–µ–±—É–µ—Ç: –ö–ª—ã–∫–∏(${it.craft.fang}), –ß–µ—à—É—è(${it.craft.scale})</small></div>
                    <button onclick="craft('${id}')">–°–æ–∑–¥–∞—Ç—å</button>
                </div>`;
            }
        }

        function craft(id) {
            const it = items[id];
            if(p.res.fang >= it.craft.fang && p.res.scale >= it.craft.scale) {
                p.res.fang -= it.craft.fang;
                p.res.scale -= it.craft.scale;
                p.inv.push(id);
                addLog(`‚öíÔ∏è –°–∫—Ä–∞—Ñ—á–µ–Ω–æ: ${it.n}`);
                renderCraft(); save();
            } else { alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤!"); }
        }

        function renderChar() {
            const list = document.getElementById('inv-list');
            list.innerHTML = '';
            document.getElementById('inv-res').innerText = `–ö–ª—ã–∫–∏: ${p.res.fang} | –ß–µ—à—É—è: ${p.res.scale}`;
            p.inv.forEach((id, idx) => {
                const it = items[id];
                list.innerHTML += `<div class="item-card">
                    <span>${it.n}</span>
                    <button onclick="equip('${id}', ${idx})">${it.type==='cons'?'–ü–∏—Ç—å':'–ù–∞–¥–µ—Ç—å'}</button>
                </div>`;
            });
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–æ–∫ –∫—É–∫–ª—ã
            for(let s in p.equip) {
                const id = p.equip[s];
                document.getElementById('sl-'+s).innerHTML = id ? items[id].n.substring(0,2) : '‚ûñ';
            }
        }

        function equip(id, idx) {
            const it = items[id];
            if(it.type === 'cons') {
                p.hp = Math.min(p.hp + it.v, 100 + p.vit*20);
                p.inv.splice(idx, 1);
                addLog(`üß™ –í—ã–ø–∏—Ç–æ: ${it.n}`);
            } else {
                p.equip[it.slot] = id;
                addLog(`‚öîÔ∏è –ù–∞–¥–µ—Ç–æ: ${it.n}`);
            }
            renderChar(); updateUI(); save();
        }

        function hunt() {
            enemy = {...mobs[Math.random() > 0.8 ? 1 : 0]};
            enemy.curHp = enemy.hp;
            document.getElementById('en-name').innerText = enemy.n;
            document.getElementById('en-img').innerText = enemy.i;
            move('battle');
        }

        function battleHit() {
            if(p.st < 10) return addLog("–£—Å—Ç–∞–ª! –ù—É–∂–Ω–æ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å.");
            p.st -= 10;
            let dmg = p.str + Math.floor(Math.random()*5);
            enemy.curHp -= dmg;
            addLog(`–í—ã —É–¥–∞—Ä–∏–ª–∏ ${enemy.n} –Ω–∞ ${dmg}`);
            
            if(enemy.curHp <= 0) {
                addLog(`üèÜ –ü–æ–±–µ–¥–∞! +${enemy.exp} –æ–ø—ã—Ç–∞.`);
                p.exp += enemy.exp; p.gold += enemy.g;
                if(Math.random() < enemy.drChance) {
                    p.res[enemy.drop]++;
                    addLog(`üíé –í—ã–ø–∞–ª —Ä–µ—Å—É—Ä—Å: ${enemy.drop}`);
                }
                checkLvl(); move('town');
                return;
            }
            
            let edmg = enemy.dmg;
            p.hp -= edmg;
            addLog(`${enemy.n} –±—å–µ—Ç –≤–∞—Å –Ω–∞ ${edmg}`);
            if(p.hp <= 0) { p.hp=10; move('town'); addLog("üíÄ –í—ã –ø–æ—Ç–µ—Ä—è–ª–∏ —Å–æ–∑–Ω–∞–Ω–∏–µ!"); }
            updateUI();
        }

        function checkLvl() {
            if(p.exp >= p.lvl * 200) {
                p.lvl++; p.points += 3;
                addLog(`üéä –£–†–û–í–ï–ù–¨ –ü–û–í–´–®–ï–ù! –¢–µ–∫—É—â–∏–π: ${p.lvl}`);
            }
        }

        function updateUI() {
            let maxHp = 100 + p.vit*20;
            document.getElementById('ui-nick').innerText = p.username;
            document.getElementById('gold').innerText = p.gold;
            document.getElementById('ui-lvl').innerText = p.lvl;
            document.getElementById('ui-pts').innerText = p.points;
            document.getElementById('hp-val').innerText = `${Math.ceil(p.hp)}/${maxHp}`;
            document.getElementById('hp-fill').style.width = (p.hp/maxHp*100)+'%';
            document.getElementById('st-val').innerText = `${p.st}/100`;
            document.getElementById('st-fill').style.width = p.st+'%';
            if(enemy) document.getElementById('en-hp-fill').style.width = (enemy.curHp/enemy.hp*100)+'%';
        }

        async function save() {
            localStorage.setItem('save_v3', JSON.stringify(p));
            await fetch(`${SB_URL}/rest/v1/users?username=eq.${p.username}`, {
                method: 'PATCH',
                headers: { "apikey": SB_KEY, "Authorization": `Bearer ${SB_KEY}`, "Content-Type": "application/json" },
                body: JSON.stringify({ save_data: p })
            });
        }

        setInterval(() => { if(!enemy && p.st < 100) { p.st = Math.min(100, p.st+5); updateUI(); } }, 5000);
        updateUI();
    </script>
</body>
</html>
