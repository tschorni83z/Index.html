<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carnage: Mobile Store</title>
    <style>
        :root { --gold: #f1c40f; --bg: #151515; --panel: #252525; --blue: #3498db; --red: #e74c3c; --green: #2ecc71; --border: #3d3d3d; }
        body { background: var(--bg); color: #ddd; font-family: 'Verdana', sans-serif; margin: 0; padding-bottom: 80px; user-select: none; }
        
        .header { background: #000; padding: 10px; border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 10; }
        .bar-bg { height: 14px; background: #333; border-radius: 7px; border: 1px solid #555; overflow: hidden; margin: 4px 0; position: relative; }
        .fill { height: 100%; transition: 0.4s; width: 100%; }
        .bar-txt { position: absolute; width: 100%; text-align: center; font-size: 10px; line-height: 14px; font-weight: bold; color: #fff; z-index: 2; }
        
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .screen { display: none; } .active { display: block; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        button { padding: 12px; background: #3c3c3c; color: #eee; border: 1px solid #555; border-radius: 6px; font-weight: bold; cursor: pointer; }
        
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #000; display: flex; border-top: 2px solid var(--border); z-index: 20; }
        .nav-item { flex: 1; padding: 15px 5px; text-align: center; font-size: 10px; color: #888; }
        .nav-item.active { color: var(--gold); background: #1a1a1a; }

        /* –ú–∞–≥–∞–∑–∏–Ω –∏ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å */
        .item-card { background: #1a1a1a; border: 1px solid #444; padding: 10px; border-radius: 5px; text-align: center; margin-bottom: 8px; }
        .item-name { color: var(--gold); font-weight: bold; font-size: 12px; display: block; }
        .item-stat { color: var(--green); font-size: 10px; }
        .equip-slot { background: #111; border: 1px dashed #555; padding: 10px; font-size: 20px; text-align: center; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="header">
        <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--gold);">
            <b id="ui-nick">–ó–∞–≥—Ä—É–∑–∫–∞...</b>
            <b>üí∞ <span id="gold">0</span></b>
        </div>
        <div class="bar-bg"><div class="bar-txt">‚ù§Ô∏è HP: <span id="hp-val">0/0</span></div><div id="hp-fill" class="fill" style="background:var(--green)"></div></div>
    </div>

    <div class="content" style="padding:10px;">
        
        <div id="scr-town" class="screen">
            <h3 style="text-align:center; color:var(--gold)">üèôÔ∏è –ü–ª–æ—â–∞–¥—å –ì–æ—Ä–æ–¥–∞</h3>
            <div class="grid">
                <button onclick="openBuild('shop')">üõçÔ∏è –ú–ê–ì–ê–ó–ò–ù</button>
                <button onclick="openBuild('hospital')">üè• –ë–æ–ª—å–Ω–∏—Ü–∞</button>
                <button onclick="openBuild('bank')">üèõÔ∏è –ë–∞–Ω–∫</button>
                <button onclick="move('forest_1')">üå≤ –í –õ–ï–°</button>
            </div>
        </div>

        <div id="scr-shop" class="screen">
            <div style="display:flex; justify-content:space-between;">
                <h3 style="color:var(--gold)">üõí –õ–∞–≤–∫–∞ –ö—É–ø—Ü–∞</h3>
                <button onclick="move('town')" style="padding:5px 10px;">‚ùå –í—ã–π—Ç–∏</button>
            </div>
            <div id="shop-items"></div>
        </div>

        <div id="scr-char" class="screen">
            <div class="panel">
                <h4 style="margin:0; color:var(--gold)">üë§ –ü—Ä–æ—Ñ–∏–ª—å –∏ –°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</h4>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:15px;">
                    <div class="equip-slot" id="slot-neck">üìø</div>
                    <div class="equip-slot" id="slot-head">ü™ñ</div>
                    <div class="equip-slot" id="slot-weapon">‚öîÔ∏è</div>
                </div>
                <div style="margin-top:20px;" id="stat-list"></div>
            </div>
        </div>

    </div>

    <div class="nav-bar">
        <div class="nav-item active" id="nav-town" onclick="move('town')">üèôÔ∏è<br>–ì–æ—Ä–æ–¥</div>
        <div class="nav-item" id="nav-char" onclick="openChar()">üë§<br>–ì–µ—Ä–æ–π</div>
    </div>

    <script>
        const SB_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co"; 
        const SB_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";

        let p = JSON.parse(localStorage.getItem('last_user_save')) || { 
            username: "–ò–≥—Ä–æ–∫", hp: 100, gold: 150, exp: 0, lvl: 1, points: 5,
            str: 5, agi: 5, int: 5, vit: 5, loc: 'town',
            equip: { weapon: null, head: null, neck: null }
        };

        const items = [
            { id: 'sw1', name: '–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π –º–µ—á', type: 'weapon', cost: 50, stat: 'str', val: 3, icon: 'üó°Ô∏è' },
            { id: 'sw2', name: '–°—Ç–∞–ª—å–Ω–æ–π –∫–ª–∏–Ω–æ–∫', type: 'weapon', cost: 200, stat: 'str', val: 10, icon: '‚öîÔ∏è' },
            { id: 'hm1', name: '–ö–æ–∂–∞–Ω—ã–π —à–ª–µ–º', type: 'head', cost: 40, stat: 'vit', val: 2, icon: 'ü™ñ' },
            { id: 'nk1', name: '–ê–º—É–ª–µ—Ç –£–¥–∞—á–∏', type: 'neck', cost: 100, stat: 'agi', val: 5, icon: 'üìø' }
        ];

        function move(loc) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(loc === 'town') {
                document.getElementById('scr-town').classList.add('active');
                document.getElementById('nav-town').classList.add('active');
            }
            p.loc = loc;
            updateUI();
        }

        function openBuild(type) {
            if(type === 'shop') {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('scr-shop').classList.add('active');
                renderShop();
            }
        }

        function renderShop() {
            const container = document.getElementById('shop-items');
            container.innerHTML = '';
            items.forEach(it => {
                const owned = p.equip[it.type] === it.id;
                container.innerHTML += `
                <div class="item-card">
                    <span class="item-name">${it.icon} ${it.name}</span>
                    <span class="item-stat">+${it.val} ${it.stat.toUpperCase()}</span>
                    <button style="width:100%; margin-top:5px; padding:5px;" 
                        onclick="buyItem('${it.id}')" ${owned ? 'disabled' : ''}>
                        ${owned ? '–≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ' : `–ö—É–ø–∏—Ç—å –∑–∞ ${it.cost}üí∞`}
                    </button>
                </div>`;
            });
        }

        function buyItem(id) {
            const it = items.find(i => i.id === id);
            if(p.gold >= it.cost) {
                p.gold -= it.cost;
                p.equip[it.type] = it.id;
                alert(`–í—ã –∫—É–ø–∏–ª–∏ ${it.name}!`);
                updateUI();
                renderShop();
                save();
            } else {
                alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞!");
            }
        }

        function openChar() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('scr-char').classList.add('active');
            document.getElementById('nav-char').classList.add('active');
            updateUI();
        }

        function updateUI() {
            // –°—á–∏—Ç–∞–µ–º –±–æ–Ω—É—Å—ã –æ—Ç –≤–µ—â–µ–π
            let bStr = 0, bAgi = 0, bVit = 0, bInt = 0;
            Object.values(p.equip).forEach(id => {
                const it = items.find(i => i.id === id);
                if(it) {
                    if(it.stat === 'str') bStr += it.val;
                    if(it.stat === 'agi') bAgi += it.val;
                    if(it.stat === 'vit') bVit += it.val;
                    if(it.stat === 'int') bInt += it.val;
                    document.getElementById(`slot-${it.type}`).innerText = it.icon;
                }
            });

            let totalMaxHp = 100 + ((p.vit + bVit) * 20);
            document.getElementById('ui-nick').innerText = p.username;
            document.getElementById('gold').innerText = p.gold;
            document.getElementById('hp-val').innerText = `${Math.ceil(p.hp)}/${totalMaxHp}`;
            document.getElementById('hp-fill').style.width = (p.hp / totalMaxHp * 100) + "%";

            const sl = document.getElementById('stat-list');
            sl.innerHTML = `
                <div style="display:flex; justify-content:space-between; padding:5px 0;"><span>–°–∏–ª–∞:</span> <b>${p.str} <small style="color:var(--green)">+${bStr}</small></b></div>
                <div style="display:flex; justify-content:space-between; padding:5px 0;"><span>–ñ–∏–≤—É—á–µ—Å—Ç—å:</span> <b>${p.vit} <small style="color:var(--green)">+${bVit}</small></b></div>
                <div style="display:flex; justify-content:space-between; padding:5px 0;"><span>–õ–æ–≤–∫–æ—Å—Ç—å:</span> <b>${p.agi} <small style="color:var(--green)">+${bAgi}</small></b></div>
            `;
        }

        async function save() {
            localStorage.setItem('last_user_save', JSON.stringify(p));
            await fetch(`${SB_URL}/rest/v1/users?username=eq.${p.username}`, {
                method: 'PATCH',
                headers: { "apikey": SB_KEY, "Authorization": `Bearer ${SB_KEY}`, "Content-Type": "application/json" },
                body: JSON.stringify({ save_data: p })
            });
        }

        move('town');
    </script>
</body>
</html>
