<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TSCHORNI GAME ONLINE</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #f1c40f; --bg: #0d0d0d; --panel: #1a1a1a; --blue: #3498db; --red: #e74c3c; --green: #2ecc71; --stamina: #9b59b6; --border: #333; }
        body { background: var(--bg); color: #ddd; font-family: 'Verdana', sans-serif; margin: 0; padding-bottom: 80px; overflow-x: hidden; }
        
        /* AUTH SCREEN */
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .auth-form { background: var(--panel); padding: 25px; border-radius: 12px; border: 2px solid var(--gold); width: 100%; max-width: 320px; text-align: center; }
        .auth-form input { width: 100%; padding: 12px; margin: 8px 0; background: #111; border: 1px solid #444; color: #fff; border-radius: 6px; box-sizing: border-box; }
        .auth-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .auth-tabs button { flex: 1; background: #222; border: 1px solid #444; color: #888; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .auth-tabs button.active { background: var(--gold); color: #000; border: none; }
        .btn-main { width: 100%; padding: 14px; background: var(--gold); color: #000; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* GAME UI */
        .header { background: #000; padding: 10px; border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .bar-bg { height: 14px; background: #222; border-radius: 7px; border: 1px solid #444; overflow: hidden; margin: 4px 0; position: relative; }
        .fill { height: 100%; transition: 0.4s; width: 0%; }
        .bar-txt { position: absolute; width: 100%; text-align: center; font-size: 10px; line-height: 14px; font-weight: bold; color: #fff; z-index: 2; }
        
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 10px; }
        .screen { display: none; padding: 10px; } .active { display: block; }
        
        #log { height: 100px; overflow-y: auto; background: #000; padding: 8px; font-size: 11px; border: 1px solid var(--border); margin-bottom: 10px; color: #aaa; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #000; display: flex; border-top: 2px solid var(--border); height: 65px; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: #555; cursor: pointer; }
        .nav-item.active { color: var(--gold); background: #111; }
        
        .item-row { background: #111; border: 1px solid #333; padding: 10px; border-radius: 5px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-form">
            <h2 style="color:var(--gold); margin:0 0 15px 0;">TSCHORNI GAME</h2>
            <div class="auth-tabs">
                <button id="tab-login" class="active" onclick="setAuthMode('login')">–í–•–û–î</button>
                <button id="tab-reg" onclick="setAuthMode('reg')">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
            </div>
            <input type="text" id="auth-nick" placeholder="–ù–∏–∫–Ω–µ–π–º">
            <input type="email" id="auth-email" placeholder="Email" style="display:none;">
            <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn-main" onclick="handleAuth()" id="auth-btn">–í–û–ô–¢–ò</button>
            <p id="auth-msg" style="font-size:11px; margin-top:10px; color:var(--red);"></p>
        </div>
    </div>

    <div id="game-ui" style="display:none;">
        <div class="header">
            <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--gold); margin-bottom:5px;">
                <b id="ui-nick">---</b>
                <b>üí∞ <span id="gold">0</span></b>
            </div>
            <div class="bar-bg"><div class="bar-txt">‚ù§Ô∏è <span id="hp-val">0/0</span></div><div id="hp-fill" class="fill" style="background:var(--green)"></div></div>
            <div class="bar-bg"><div class="bar-txt">üí™ <span id="st-val">0/0</span></div><div id="st-fill" class="fill" style="background:var(--stamina)"></div></div>
        </div>

        <div id="log"></div>

        <div id="scr-town" class="screen">
            <div class="panel" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button onclick="move('shop')">üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω</button>
                <button onclick="move('craft')">‚öíÔ∏è –ö—É–∑–Ω–∏—Ü–∞</button>
                <button onclick="move('world')" style="grid-column:span 2; background:var(--blue); color:#fff; border:none;">üß≠ –ö–ê–†–¢–ê –ú–ò–†–ê</button>
                <button onclick="logout()" style="grid-column:span 2; background:#222; color:#666;">–í–´–ô–¢–ò –ò–ó –ê–ö–ö–ê–£–ù–¢–ê</button>
            </div>
        </div>

        <div id="scr-world" class="screen">
            <h4 style="margin:0 0 10px 0;">üó∫Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –ø—É—Ç—å</h4>
            <div id="loc-list"></div>
            <button onclick="move('town')" style="width:100%; margin-top:10px;">–í –≥–æ—Ä–æ–¥</button>
        </div>

        <div id="scr-action" class="screen">
            <div class="panel" style="text-align:center;">
                <h3 id="act-name">...</h3>
                <div id="act-icon" style="font-size:50px; margin:10px 0;">‚ùì</div>
                <div class="bar-bg" id="act-hp-bar"><div id="act-fill" class="fill" style="background:var(--red)"></div></div>
                <button onclick="doAction()" id="main-act-btn" style="width:100%; height:50px; background:var(--red); border:none; color:#fff; font-weight:bold; margin-top:15px;">–î–ï–ô–°–¢–í–ò–ï</button>
                <button onclick="move('world')" style="width:100%; margin-top:10px; background:none; border:1px solid #444; color:#fff;">–°–ë–ï–ñ–ê–¢–¨</button>
            </div>
        </div>

        <div id="scr-char" class="screen">
            <div class="panel" id="char-info"></div>
            <div class="panel"><h5>üéí –†–µ—Å—É—Ä—Å—ã –¥–ª—è –∫—Ä–∞—Ñ—Ç–∞</h5><div id="res-list"></div></div>
        </div>

        <div id="scr-shop" class="screen"><div id="shop-list"></div><button onclick="move('town')" style="width:100%; margin-top:10px;">–ù–∞–∑–∞–¥</button></div>
        <div id="scr-craft" class="screen"><div id="craft-list"></div><button onclick="move('town')" style="width:100%; margin-top:10px;">–ù–∞–∑–∞–¥</button></div>

        <div class="nav-bar">
            <div id="n-town" class="nav-item" onclick="move('town')">üèôÔ∏è<br>–ì–æ—Ä–æ–¥</div>
            <div id="n-world" class="nav-item" onclick="move('world')">üß≠<br>–ö–∞—Ä—Ç–∞</div>
            <div id="n-char" class="nav-item" onclick="move('char')">üë§<br>–ì–µ—Ä–æ–π</div>
        </div>
    </div>

    <script>
        const SB_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co"; 
        const SB_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";
        const supabase = window.supabase.createClient(SB_URL, SB_KEY);

        let p = null;
        let activeTarget = null;
        let authMode = 'login';
        let lastActivity = Date.now();

        const CONTENT = {
            locs: {
                'f': { n:'üå≤ –¢–∏—Ö–∏–π –õ–µ—Å', type:'peace', res:'wood', icon:'üå≤' },
                'm': { n:'‚õèÔ∏è –®–∞—Ö—Ç–∞', type:'peace', res:'ore', icon:'üíé' },
                'b1': { n:'üåæ –ü–æ–ª–µ (Lvl 1)', type:'battle', mob:{n:'–ö—Ä—ã—Å–∞', hp:40, dmg:4, g:10, exp:20, drop:'skin'} },
                'b2': { n:'üíÄ –ü–µ—â–µ—Ä–∞ (Lvl 5)', type:'battle', mob:{n:'–û—Ä–∫', hp:200, dmg:15, g:50, exp:100, drop:'bone'} }
            },
            shop: [
                { id:'p1', n:'–ó–µ–ª—å–µ HP', cost:20, v:30 },
                { id:'w1', n:'–†–∂–∞–≤—ã–π –ú–µ—á', cost:100, str:5 }
            ],
            craft: [
                { id:'c1', n:'–ú–µ—á –ú–∞—Å—Ç–µ—Ä–∞', req:{wood:10, ore:5}, str:20 },
                { id:'c2', n:'–ö–æ–∂–∞–Ω–∞—è –ë—Ä–æ–Ω—è', req:{skin:10}, vit:10 }
            ]
        };

        // --- AUTH ---
        function setAuthMode(mode) {
            authMode = mode;
            document.getElementById('tab-login').className = mode==='login'?'active':'';
            document.getElementById('tab-reg').className = mode==='reg'?'active':'';
            document.getElementById('auth-email').style.display = mode==='reg'?'block':'none';
            document.getElementById('auth-btn').innerText = mode==='login'?'–í–û–ô–¢–ò':'–ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–¢–¨–°–Ø';
        }

        async function handleAuth() {
            const nick = document.getElementById('auth-nick').value.trim();
            const email = document.getElementById('auth-email').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            const msg = document.getElementById('auth-msg');
            if(!nick || !pass) return msg.innerText = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!";

            if(authMode === 'reg') {
                const { data, error } = await supabase.auth.signUp({ email, password: pass, options: { data: { nickname: nick } } });
                if(error) return msg.innerText = error.message;
                // –ë—Ä–æ–Ω–∏—Ä—É–µ–º –Ω–∏–∫ –≤ –ë–î
                await supabase.from('users').insert({ id: data.user.id, username: nick, email_hidden: email });
                msg.style.color = 'var(--green)'; msg.innerText = "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ Email –∏ –≤–æ–π–¥–∏—Ç–µ!";
            } else {
                const { data: u } = await supabase.from('users').select('email_hidden').eq('username', nick).single();
                if(!u) return msg.innerText = "–ù–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!";
                const { data, error } = await supabase.auth.signInWithPassword({ email: u.email_hidden, password: pass });
                if(error) return msg.innerText = error.message;
                loadData(data.user);
            }
        }

        // --- GAME ENGINE ---
        async function loadData(user) {
            const { data } = await supabase.from('users').select('*').eq('id', user.id).single();
            if(data && data.save_data && data.save_data.username) {
                p = data.save_data;
            } else {
                p = { id:user.id, username:data.username, hp:100, st:100, gold:100, exp:0, lvl:1, vit:5, str:5, res:{wood:0, ore:0, skin:0, bone:0}, last_save: Date.now() };
            }
            init();
        }

        function init() {
            const diff = Math.floor((Date.now() - p.last_save)/1000);
            if(diff > 30) {
                const max = 100 + p.vit*20;
                p.hp = Math.min(max, p.hp + Math.floor(diff/15));
                p.st = Math.min(100, p.st + Math.floor(diff/8));
            }
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            move('town');
            updateUI();
            setInterval(save, 30000);
        }

        function move(scr) {
            if(activeTarget && scr !== 'action') return addLog("–°–Ω–∞—á–∞–ª–∞ –∑–∞–∫–æ–Ω—á–∏ –¥–µ–ª–æ!");
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('scr-'+scr).classList.add('active');
            if(document.getElementById('n-'+scr)) document.getElementById('n-'+scr).classList.add('active');
            if(scr === 'world') renderWorld();
            if(scr === 'char') renderChar();
            if(scr === 'shop') renderShop();
            if(scr === 'craft') renderCraft();
            updateUI();
        }

        function renderWorld() {
            const div = document.getElementById('loc-list'); div.innerHTML = '';
            for(let id in CONTENT.locs) {
                const l = CONTENT.locs[id];
                div.innerHTML += `<div class="item-row"><span>${l.n}</span> <button onclick="startAct('${id}')">–í–æ–π—Ç–∏</button></div>`;
            }
        }

        function startAct(id) {
            activeTarget = { ...CONTENT.locs[id], id };
            if(activeTarget.type === 'battle') {
                activeTarget.curHp = activeTarget.mob.hp;
                document.getElementById('act-name').innerText = activeTarget.mob.n;
                document.getElementById('main-act-btn').innerText = '–£–î–ê–†–ò–¢–¨';
            } else {
                document.getElementById('act-name').innerText = '–°–±–æ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤...';
                document.getElementById('main-act-btn').innerText = '–°–û–ë–ò–†–ê–¢–¨';
            }
            move('action');
        }

        function doAction() {
            lastActivity = Date.now();
            if(p.st < 5) return addLog("–ù–µ—Ç –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏!");
            p.st -= 5;
            if(activeTarget.type === 'battle') {
                activeTarget.curHp -= (p.str + 3);
                p.hp -= activeTarget.mob.dmg;
                if(activeTarget.curHp <= 0) {
                    addLog(`–ü–æ–±–µ–¥–∞! +${activeTarget.mob.g}üí∞`);
                    p.gold += activeTarget.mob.g; p.exp += activeTarget.mob.exp;
                    p.res[activeTarget.mob.drop]++;
                    activeTarget = null; move('world');
                }
            } else {
                p.res[activeTarget.res]++;
                addLog(`–î–æ–±—ã—Ç–æ: ${activeTarget.res}`);
            }
            if(p.hp <= 0) { p.hp=20; activeTarget=null; move('town'); addLog("–í—ã –ø–æ—Ç–µ—Ä—è–ª–∏ —Å–æ–∑–Ω–∞–Ω–∏–µ..."); }
            updateUI();
        }

        function renderShop() {
            const div = document.getElementById('shop-list'); div.innerHTML = '<h4>üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω</h4>';
            CONTENT.shop.forEach(i => {
                div.innerHTML += `<div class="item-row"><span>${i.n} (${i.cost}üí∞)</span><button onclick="buy('${i.id}')">–ö—É–ø–∏—Ç—å</button></div>`;
            });
        }

        function buy(id) {
            const it = CONTENT.shop.find(i => i.id === id);
            if(p.gold >= it.cost) { p.gold -= it.cost; addLog("–ö—É–ø–ª–µ–Ω–æ: " + it.n); updateUI(); }
        }

        function renderCraft() {
            const div = document.getElementById('craft-list'); div.innerHTML = '<h4>‚öíÔ∏è –ö—É–∑–Ω–∏—Ü–∞</h4>';
            CONTENT.craft.forEach(i => {
                div.innerHTML += `<div class="item-row"><span>${i.n}</span><button onclick="craft('${i.id}')">–°–æ–∑–¥–∞—Ç—å</button></div>`;
            });
        }

        function craft(id) {
            const it = CONTENT.craft.find(i => i.id === id);
            let can = true;
            for(let r in it.req) if(p.res[r] < it.req[r]) can = false;
            if(can) {
                for(let r in it.req) p.res[r] -= it.req[r];
                addLog("–°–æ–∑–¥–∞–Ω–æ: " + it.n); renderCraft();
            } else alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤!");
        }

        function renderChar() {
            document.getElementById('char-info').innerHTML = `<h3>${p.username}</h3>–£—Ä–æ–≤–µ–Ω—å: ${p.lvl}<br>–°–∏–ª–∞: ${p.str} | –ñ–∏–≤—É—á–µ—Å—Ç—å: ${p.vit}`;
            document.getElementById('res-list').innerHTML = Object.entries(p.res).map(([k,v]) => v>0?`<div class="item-row">${k}: ${v}</div>`:'').join('');
        }

        function updateUI() {
            if(!p) return;
            const max = 100 + p.vit*20;
            document.getElementById('ui-nick').innerText = p.username;
            document.getElementById('gold').innerText = Math.floor(p.gold);
            document.getElementById('hp-val').innerText = `${Math.ceil(p.hp)}/${max}`;
            document.getElementById('hp-fill').style.width = (p.hp/max*100)+'%';
            document.getElementById('st-val').innerText = `${p.st}/100`;
            document.getElementById('st-fill').style.width = p.st+'%';
            if(activeTarget && activeTarget.curHp) document.getElementById('act-fill').style.width = (activeTarget.curHp/activeTarget.mob.hp*100)+'%';
        }

        async function save() {
            if(!p) return; p.last_save = Date.now();
            await supabase.from('users').update({ save_data: p }).eq('id', p.id);
        }

        function addLog(m) {
            const l = document.getElementById('log'); l.innerHTML += `<div>> ${m}</div>`; l.scrollTop = l.scrollHeight;
        }

        function logout() { supabase.auth.signOut(); location.reload(); }

        window.onload = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if(session) loadData(session.user);
        };

        setInterval(() => {
            if(Date.now() - lastActivity > 3600000) logout();
            if(p && !activeTarget) {
                const max = 100 + p.vit*20;
                if(p.hp < max) p.hp = Math.min(max, p.hp + 2);
                if(p.st < 100) p.st = Math.min(100, p.st + 5);
                updateUI();
            }
        }, 5000);
    </script>
</body>
</html>
