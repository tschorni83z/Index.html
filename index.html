<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAME</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; text-align: center; padding: 20px; }
        input { width: 90%; padding: 15px; margin: 10px 0; border-radius: 10px; border: 1px solid #444; background: #111; color: #fff; }
        button { width: 90%; padding: 15px; background: #ffcc00; font-weight: bold; border: none; border-radius: 10px; margin-top: 10px; }
        #st { margin-top: 20px; color: #ffcc00; }
    </style>
</head>
<body>
    <h2>TSCHORNI RPG</h2>
    <input type="text" id="u_nick" placeholder="НИК">
    <input type="password" id="u_pass" placeholder="ПАРОЛЬ">
    <button onclick="play('login')">ВОЙТИ</button>
    <button onclick="play('reg')" style="background:none; color:#ffcc00; border: 1px solid #ffcc00;">РЕГИСТРАЦИЯ</button>
    <div id="st">Статус: Готов</div>

    <script>
        const S_URL = "https://xgnzgapvvulizxtqdyzn.supabase.co";
        const S_KEY = "sb_publishable_DtZvknbQ-Cy2mDqN6G-kfg_yLavMwLT";
        const sb = window.supabase.createClient(S_URL, S_KEY);

        async function play(m) {
            const s = document.getElementById('st');
            const n = document.getElementById('u_nick').value.trim();
            const p = document.getElementById('u_pass').value.trim();

            if(!n || !p) return alert("Заполни поля!");
            
            s.innerText = "⏳ Секунду...";
            const mail = n.toLowerCase() + "@ts.com";

            try {
                if(m === 'reg') {
                    const { data, error } = await sb.auth.signUp({ email: mail, password: p });
                    if(error) throw error;
                    if(data.user) {
                        await sb.from('users').insert({ id: data.user.id, username: n, email_hidden: mail });
                    }
                    alert("УСПЕХ! Теперь жми ВОЙТИ");
                    s.innerText = "Аккаунт создан!";
                } else {
                    const { data: d, error: e } = await sb.from('users').select('email_hidden').eq('username', n).single();
                    if(!d || e) throw new Error("Ник не найден!");
                    const { error: le } = await sb.auth.signInWithPassword({ email: d.email_hidden, password: p });
                    if(le) throw le;
                    alert("ВЫ В ИГРЕ!");
                    document.body.innerHTML = "<h1>ПРИВЕТ, " + n + "!</h1>";
                }
            } catch(err) {
                alert("ОШИБКА: " + err.message);
                s.innerText = "Ошибка: " + err.message;
            }
        }
    </script>
</body>
</html>
